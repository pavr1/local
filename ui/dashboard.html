<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ice Cream Store - Management Dashboard</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <!-- Shared CSS -->
    <link rel="stylesheet" href="shared/css/style.css?v=1.3">
    
    <style>
        /* SPA Dashboard Layout */
        body {
            background: var(--background-light);
            font-family: 'Poppins', sans-serif;
        }
        
        .dashboard-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        .dashboard-sidebar {
            width: 280px;
            flex-shrink: 0;
            background: var(--white);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            z-index: 1000;
        }
        
        .dashboard-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
                }





        /* Top Panel Styles - Hierarchical Design */
        .top-panel {
            background: var(--gradient-primary);
            color: var(--white);
            padding: 2rem;
            border-radius: var(--border-radius-lg);
            margin: 1rem;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            align-items: center;
            gap: 2rem;
        }

        .top-left {
            display: flex;
            align-items: center;
        }

        .brand-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .brand-icon {
            font-size: 1.5rem;
            opacity: 0.9;
        }

        .brand-name {
            font-size: 1.2rem;
            font-weight: 600;
            opacity: 0.9;
        }

        .top-center {
            text-align: center;
        }

        .page-title {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 0;
            margin-bottom: 0.25rem;
        }

        .page-subtitle {
            font-size: 0.95rem;
            opacity: 0.8;
            margin: 0;
            font-family: 'Courier New', monospace;
            transition: opacity 0.3s ease;
            border-left: 3px solid rgba(255, 255, 255, 0.3);
            padding-left: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            padding: 0.5rem 0.75rem;
        }

        .top-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.5rem;
        }

        .header-time {
            font-size: 1.4rem;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .header-status {
            font-size: 0.9rem;
            padding: 0.4rem 0.8rem;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Body Panel Styles */
        .body-panel {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }
        
        /* Sidebar Styles */
        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }
        
        .sidebar-nav {
            padding: 1.5rem 1rem;
        }
        
        .nav-section-title {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--secondary-color);
            margin-bottom: 1rem;
            padding: 0 0.75rem;
            letter-spacing: 0.5px;
        }
        
        .nav-pills .nav-link {
            border-radius: var(--border-radius);
            margin-bottom: 0.25rem;
            padding: 0.75rem;
            color: var(--dark-color);
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            background: none;
            text-align: left;
            width: 100%;
        }
        
        .nav-pills .nav-link:hover {
            background: var(--primary-light);
            color: var(--primary-color);
            transform: translateX(5px);
        }
        
        .nav-pills .nav-link.active {
            background: var(--primary-color);
            color: var(--white);
            box-shadow: var(--shadow-light);
        }
        
        .nav-sub {
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
            margin-left: 1rem;
        }
        
        /* Content Loading */
        .content-loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: var(--secondary-color);
        }
        
        .loading-spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .dashboard-sidebar {
                position: fixed;
                left: -280px;
                height: 100vh;
                transition: left 0.3s ease;
                z-index: 1050;
            }
            
            .dashboard-sidebar.show {
                left: 0;
            }
            
            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1040;
                display: none;
            }
            
            .sidebar-overlay.show {
                display: block;
            }

            .top-panel {
                padding: 1.5rem 1rem;
                margin: 0.5rem;
                grid-template-columns: 1fr;
                text-align: center;
                gap: 1rem;
            }

            .top-left, .top-center, .top-right {
                justify-self: center;
            }

            .brand-section {
                justify-content: center;
            }

            .page-title {
                font-size: 1.8rem;
            }

            .top-right {
                align-items: center;
            }

            .header-time {
                font-size: 1.2rem;
            }
            
            .body-panel {
                padding: 1rem;
            }


        }
        
        .breadcrumb-container {
            background: var(--white);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            margin: 0;
        }
        
        .breadcrumb {
            margin: 0;
            background: transparent;
            padding: 0;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="dashboard-sidebar" id="dashboardSidebar">
            <!-- Sidebar Header -->
            <div class="sidebar-header">
                <i class="fas fa-ice-cream text-primary fa-2x"></i>
                <h5 class="mt-2 mb-0">Ice Cream Store</h5>
                <small class="text-muted">Management Dashboard</small>
            </div>
            
            <!-- Navigation -->
            <nav class="sidebar-nav">
                <h6 class="nav-section-title">
                    <i class="fas fa-layer-group me-2"></i>Services
                </h6>
                
                <ul class="nav nav-pills flex-column">
                    <li class="nav-item">
                        <button class="nav-link active" onclick="loadContent('dashboard')" data-page="dashboard">
                            <i class="fas fa-home me-2"></i>
                            Dashboard
                        </button>
                    </li>
                    
                    <li class="nav-item">
                        <button class="nav-link" onclick="loadContent('orders')" data-page="orders">
                            <i class="fas fa-shopping-cart me-2"></i>
                            Orders
                        </button>
                    </li>
                    
                    <li class="nav-item">
                        <button class="nav-link" onclick="toggleSubmenu('inventory')" data-page="inventory">
                            <i class="fas fa-warehouse me-2"></i>
                            Inventory
                            <i class="fas fa-chevron-down ms-auto"></i>
                        </button>
                        <ul class="nav flex-column ms-3" id="inventory-submenu" style="display: none;">
                            <li class="nav-item">
                                <button class="nav-link nav-sub" onclick="loadContent('inventory')" data-page="inventory">
                                    <i class="fas fa-chart-bar me-2"></i>Overview
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link nav-sub" onclick="loadContent('inventory-suppliers')" data-page="inventory-suppliers">
                                    <i class="fas fa-truck me-2"></i>Suppliers
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link nav-sub" onclick="loadContent('inventory-ingredients')" data-page="inventory-ingredients">
                                    <i class="fas fa-seedling me-2"></i>Ingredients
                                </button>
                            </li>
                        </ul>
                    </li>
                    
                    <li class="nav-item">
                        <button class="nav-link" onclick="toggleSubmenu('invoice')" data-page="invoice">
                            <i class="fas fa-file-invoice me-2"></i>
                            Invoice
                            <i class="fas fa-chevron-down ms-auto"></i>
                        </button>
                        <ul class="nav flex-column ms-3" id="invoice-submenu" style="display: none;">
                            <li class="nav-item">
                                <button class="nav-link nav-sub" onclick="loadContent('invoice')" data-page="invoice">
                                    <i class="fas fa-chart-pie me-2"></i>Overview
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link nav-sub" onclick="loadContent('invoice-details')" data-page="invoice-details">
                                    <i class="fas fa-file-invoice me-2"></i>Details
                                </button>
                            </li>
                        </ul>
                    </li>
                </ul>
            </nav>
            
            <!-- User Section -->
            <div class="sidebar-footer" style="padding: 1.5rem; border-top: 1px solid var(--border-color); margin-top: auto;">
                <div class="user-info d-flex align-items-center mb-3">
                    <i class="fas fa-user-circle fa-2x text-primary me-2"></i>
                    <div>
                        <div class="fw-bold" id="user-name">Loading...</div>
                        <small class="text-muted">Administrator</small>
                    </div>
                </div>
                <button class="btn btn-outline-danger btn-sm w-100" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                </button>
            </div>
        </div>
        
        <!-- Mobile sidebar overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
        
        <!-- Main Content Area -->
        <div class="dashboard-main">
            <!-- Top Panel - Hierarchical Design -->
            <div class="top-panel">
                <div class="top-left">
                    <div class="brand-section">
                        <i class="fas fa-ice-cream brand-icon"></i>
                        <span class="brand-name">Dashboard</span>
                    </div>
                </div>
                <div class="top-center">
                    <h1 class="page-title" id="page-title">Dashboard</h1>
                    <p class="page-subtitle" id="page-subtitle">Welcome to your business management dashboard</p>
                </div>
                <div class="top-right">
                    <div class="header-time" id="header-time">--:--:--</div>
                    <div class="header-status">
                        <i class="fas fa-circle text-success me-2" style="font-size: 0.6rem;"></i>
                        System Online
                    </div>
                </div>
            </div>
            
            <!-- Body Panel - Where partial content loads -->
            <div class="body-panel" id="main-content">
                <!-- Initial loading state -->
                <div class="content-loader">
                    <div class="loading-spinner"></div>
                    <span>Loading dashboard...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Configuration -->
    <script src="config.js?v=1.3"></script>
    
    <!-- Shared JavaScript -->
    <script src="shared/js/auth.js?v=1.3"></script>
    <script src="shared/js/alerts.js?v=1.3"></script>
    
    <script>
        let currentPage = 'dashboard';
        let auth = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Initializing SPA Dashboard...');
            
            // Initialize authentication
            auth = new AuthService();
            if (!auth.isAuthenticated()) {
                console.log('❌ User not authenticated, redirecting to login');
                window.location.href = 'login.html';
                return;
            }
            
            // Load user info
            loadUserInfo();
            
            // Load initial dashboard content
            await loadContent('dashboard');
            
            console.log('✅ SPA Dashboard initialized successfully');
        });

        // Content loading function
        async function loadContent(page) {
            console.log('📄 Loading content:', page);
            
            try {
                // Show loading state
                showLoading();
                
                // Update navigation state
                updateActiveNavigation(page);
                
                // Update page title and breadcrumb in top panel
                updatePageInfo(page);
                
                // Load content based on page - this loads into body panel only
                let contentUrl, html;
                
                // Load content based on page - all pages load their partial content
                contentUrl = getContentUrl(page);
                const response = await fetch(contentUrl);
                if (!response.ok) {
                    throw new Error(`Failed to load content: ${response.status}`);
                }
                html = await response.text();
                
                // Load content into body panel
                document.getElementById('main-content').innerHTML = html;
                
                // Initialize page-specific functionality
                await initializePageContent(page);
                
                currentPage = page;
                
            } catch (error) {
                console.error('❌ Error loading content:', error);
                showError('Failed to load page content. Please try again.');
            }
        }

        // Get content URL for each page
        function getContentUrl(page) {
            const contentMap = {
                'dashboard': 'partials/dashboard-content.html',
                'orders': 'partials/orders-content.html',
                'inventory': 'partials/inventory-content.html',
                'inventory-suppliers': 'partials/inventory-suppliers-content.html',
                'inventory-ingredients': 'partials/inventory-ingredients-content.html',
                'invoice': 'partials/invoice-content.html',
                'invoice-details': 'partials/invoice-invoices-content.html'
            };
            
            return contentMap[page] || 'partials/dashboard-content.html';
        }

        // Initialize page-specific content
        async function initializePageContent(page) {
            const initMap = {
                'dashboard': 'initDashboardContent',
                'orders': 'initOrdersContent',
                'inventory': 'initInventoryContent',
                'inventory-suppliers': 'initSuppliersContent',
                'inventory-ingredients': 'initIngredientsContent',
                'invoice': 'initInvoiceContent',
                'invoice-details': 'initInvoiceDetailsContent'
            };
            
            // Setup header time (always visible in top panel)
            console.log('🕐 Setting up header time...');
            setTimeout(() => {
                const headerTimeElement = document.getElementById('header-time');
                
                const updateHeaderTime = () => {
                    const currentTime = new Date().toLocaleTimeString();
                    if (headerTimeElement) {
                        headerTimeElement.textContent = currentTime;
                    }
                };
                
                updateHeaderTime(); // Set immediately
                setInterval(updateHeaderTime, 1000); // Update every second
                console.log('✅ Header time setup complete');
            }, 200);
            
            const initFunction = initMap[page];
            if (initFunction && typeof window[initFunction] === 'function') {
                console.log('🔧 Initializing page:', initFunction);
                await window[initFunction]();
            }
        }

        // Update active navigation
        function updateActiveNavigation(page) {
            // Remove all active classes
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Add active class to current page
            const activeLink = document.querySelector(`[data-page="${page}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
        }

        // Update page title and subtitle with logs
        function updatePageInfo(page) {
            const pageInfo = {
                'dashboard': { 
                    title: 'Dashboard', 
                    subtitle: 'Welcome to your business management dashboard' 
                },
                'orders': { 
                    title: 'Orders Management', 
                    subtitle: 'Manage customer orders, track status, and handle fulfillment' 
                },
                'inventory': { 
                    title: 'Inventory Overview', 
                    subtitle: 'Track ingredients, manage suppliers, and monitor stock levels' 
                },
                'inventory-suppliers': { 
                    title: 'Suppliers Management', 
                    subtitle: 'Manage supplier relationships and vendor information' 
                },
                'inventory-ingredients': { 
                    title: 'Ingredients Management', 
                    subtitle: 'Track ingredient inventory and recipe components' 
                },
                'invoice': { 
                    title: 'Invoice Management', 
                    subtitle: 'Manage invoices, track payments, and handle billing' 
                },
                'invoice-details': { 
                    title: 'Invoice Details', 
                    subtitle: 'View and manage detailed invoice information' 
                }
            };
            
            const info = pageInfo[page] || pageInfo['dashboard'];
            
            // Update page title in top panel
            const pageTitleElement = document.getElementById('page-title');
            const pageSubtitleElement = document.getElementById('page-subtitle');
            
            if (pageTitleElement) {
                pageTitleElement.textContent = info.title;
            }
            
            // Update subtitle with activity logs
            if (pageSubtitleElement) {
                updatePageLogs(page, pageSubtitleElement);
            }
            
            // Update document title
            document.title = `Ice Cream Store - ${info.title}`;
        }

        // Update page logs in subtitle
        function updatePageLogs(page, subtitleElement) {
            const now = new Date();
            const timeStamp = now.toLocaleTimeString();
            
            const pageLogs = {
                'dashboard': `System initialized • ${timeStamp} • All services operational`,
                'orders': `Orders module loaded • ${timeStamp} • Ready for order management`,
                'inventory': `Inventory data synced • ${timeStamp} • Stock levels current`,
                'inventory-suppliers': `Supplier database loaded • ${timeStamp} • ${getRandomNumber(15, 45)} suppliers active`,
                'inventory-ingredients': `Ingredients catalog loaded • ${timeStamp} • ${getRandomNumber(50, 120)} items tracked`,
                'invoice': `Invoice system ready • ${timeStamp} • Financial tracking active`,
                'invoice-details': `Invoice records loaded • ${timeStamp} • ${getRandomNumber(5, 25)} invoices pending`
            };
            
            const logMessage = pageLogs[page] || `Page loaded • ${timeStamp} • System ready`;
            subtitleElement.textContent = logMessage;
            
            // Add a subtle animation to show the update
            subtitleElement.style.opacity = '0.6';
            setTimeout(() => {
                subtitleElement.style.opacity = '0.8';
            }, 200);
        }

        // Helper function to generate random numbers for dynamic data
        function getRandomNumber(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // Toggle submenu
        function toggleSubmenu(menuId) {
            const submenu = document.getElementById(menuId + '-submenu');
            if (submenu) {
                submenu.style.display = submenu.style.display === 'none' ? 'block' : 'none';
            }
        }

        // Show loading state
        function showLoading() {
            document.getElementById('main-content').innerHTML = `
                <div class="content-loader">
                    <div class="loading-spinner"></div>
                    <span>Loading content...</span>
                </div>
            `;
        }

        // Show error state
        function showError(message) {
            document.getElementById('main-content').innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-4x text-danger mb-3"></i>
                    <h3>Error Loading Content</h3>
                    <p class="text-muted mb-4">${message}</p>
                    <button class="btn btn-primary" onclick="loadContent('${currentPage}')">
                        <i class="fas fa-refresh me-2"></i>Retry
                    </button>
                </div>
            `;
        }

        // Load user info
        function loadUserInfo() {
            try {
                const userInfo = auth.getCurrentUser();
                if (userInfo) {
                    document.getElementById('user-name').textContent = userInfo.username || 'User';
                }
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        // Time display is now handled by dashboard content partial

        // Toggle mobile sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('dashboardSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                auth.logout();
                window.location.href = 'login.html';
            }
        }

        // Global navigation function for content partials
        window.navigateToRoute = function(route) {
            loadContent(route);
        };
    </script>
</body>
</html> 