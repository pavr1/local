<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ice Cream Store - Management Dashboard</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <!-- Shared CSS -->
    <link rel="stylesheet" href="shared/css/style.css?v=1.3">
    
    <style>
        /* SPA Dashboard Layout */
        body {
            background: var(--background-light);
            font-family: 'Poppins', sans-serif;
        }
        
        .dashboard-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        .dashboard-sidebar {
            width: 280px;
            flex-shrink: 0;
            background: var(--white);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            z-index: 1000;
        }
        
        .dashboard-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
                }





        /* Top Panel Styles - Hierarchical Design */
        .top-panel {
            background: var(--gradient-primary);
            color: var(--white);
            padding: 2rem;
            border-radius: var(--border-radius-lg);
            margin: 1rem;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            align-items: center;
            gap: 2rem;
        }

        .top-left {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .brand-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .brand-icon {
            font-size: 1.5rem;
            opacity: 0.9;
        }

        .brand-name {
            font-size: 1.2rem;
            font-weight: 600;
            opacity: 0.9;
        }

        .top-center {
            text-align: center;
        }

        .page-title {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 0;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .page-subtitle {
            font-size: 1rem;
            opacity: 0.8;
            margin: 0;
        }

        .top-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 1rem;
        }

        /* User Section Styles */
        .user-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .user-avatar {
            font-size: 1.8rem;
            color: rgba(255, 255, 255, 0.9);
        }

        .user-name {
            font-size: 0.95rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
        }

        .logout-btn {
            border-color: rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.9);
            padding: 0.4rem 0.6rem;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
            color: white;
            transform: translateY(-1px);
        }

        /* System Section Styles */
        .system-section {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.3rem;
        }

        .header-status {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            padding: 0.3rem 0.6rem;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .header-status-warning {
            background: rgba(255, 193, 7, 0.15);
            border-color: rgba(255, 193, 7, 0.3);
        }

        .header-status-error {
            background: rgba(220, 53, 69, 0.15);
            border-color: rgba(220, 53, 69, 0.3);
        }

        /* System Status Indicator in Header */
        .system-status-indicator {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.5rem;
            position: relative;
        }

        .system-status-indicator .connection-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            position: relative;
            display: inline-block;
        }

        .system-status-indicator .connection-indicator::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            opacity: 0.3;
        }

        /* System Status - Online */
        .system-status-indicator.online .connection-indicator {
            background: #00d851; /* More vibrant green */
            box-shadow: 0 0 12px rgba(0, 216, 81, 0.6);
            animation: connectionOnline 2s ease-in-out infinite;
        }

        .system-status-indicator.online .connection-indicator::before {
            background: #00d851; /* More vibrant green */
            animation: connectionPulse 2s ease-in-out infinite;
        }

        /* System Status - Checking */
        .system-status-indicator.checking .connection-indicator {
            background: #ff9500; /* More vibrant orange */
            box-shadow: 0 0 12px rgba(255, 149, 0, 0.6);
            animation: connectionChecking 1.5s ease-in-out infinite;
        }

        .system-status-indicator.checking .connection-indicator::before {
            background: #ff9500; /* More vibrant orange */
            animation: connectionCheckingRing 1.5s ease-in-out infinite;
        }

        /* System Status - Offline */
        .system-status-indicator.offline .connection-indicator {
            background: #ff1744; /* More vibrant red */
            box-shadow: 0 0 12px rgba(255, 23, 68, 0.6);
            transform: scale(1); /* Required for scale animation */
            animation: connectionOffline 3s ease-in-out infinite;
        }

        .system-status-indicator.offline .connection-indicator::before {
            background: #ff1744; /* More vibrant red */
            transform: scale(1); /* Required for scale animation */
            animation: connectionOfflineRing 3s ease-in-out infinite;
        }

        /* System Status - Degraded */
        .system-status-indicator.degraded .connection-indicator {
            background: #ff9500; /* More vibrant orange */
            box-shadow: 0 0 12px rgba(255, 149, 0, 0.6);
            animation: connectionDegraded 2s ease-in-out infinite;
        }

        .system-status-indicator.degraded .connection-indicator::before {
            background: #ff9500; /* More vibrant orange */
            animation: connectionDegradedRing 2s ease-in-out infinite;
        }

        /* Enhanced Connection Status Animations - Global for all pages */
        @keyframes connectionOnline {
            0%, 100% { 
                transform: scale(1); 
                opacity: 1;
                filter: brightness(1) saturate(1);
            }
            50% { 
                transform: scale(1.15); 
                opacity: 0.85;
                filter: brightness(1.3) saturate(1.2);
            }
        }

        @keyframes connectionPulse {
            0% { 
                transform: scale(1); 
                opacity: 0.4;
                filter: brightness(1);
            }
            50% { 
                transform: scale(1.9); 
                opacity: 0;
                filter: brightness(1.5);
            }
            100% { 
                transform: scale(1); 
                opacity: 0.4;
                filter: brightness(1);
            }
        }

        @keyframes connectionChecking {
            0%, 100% { 
                transform: scale(1); 
                opacity: 1;
                filter: brightness(1) saturate(1);
            }
            25% { 
                transform: scale(1.2); 
                opacity: 0.75;
                filter: brightness(1.2) saturate(1.3);
            }
            50% { 
                transform: scale(0.9); 
                opacity: 1;
                filter: brightness(1) saturate(1);
            }
            75% { 
                transform: scale(1.2); 
                opacity: 0.75;
                filter: brightness(1.2) saturate(1.3);
            }
        }

        @keyframes connectionCheckingRing {
            0% { 
                transform: scale(1); 
                opacity: 0.4;
                filter: brightness(1);
            }
            50% { 
                transform: scale(2.2); 
                opacity: 0;
                filter: brightness(1.3);
            }
            100% { 
                transform: scale(1); 
                opacity: 0.4;
                filter: brightness(1);
            }
        }

        @keyframes connectionOffline {
            0%, 85% { 
                opacity: 1;
                transform: scale(1);
                filter: brightness(1) saturate(1) hue-rotate(0deg);
            }
            90% { 
                opacity: 0.3;
                transform: scale(0.8);
                filter: brightness(1.8) saturate(1.5) hue-rotate(-20deg);
            }
            95% { 
                opacity: 0.6;
                transform: scale(1.2);
                filter: brightness(2.2) saturate(2.0) hue-rotate(20deg);
            }
            100% { 
                opacity: 1;
                transform: scale(1);
                filter: brightness(1) saturate(1) hue-rotate(0deg);
            }
        }

        @keyframes connectionOfflineRing {
            0%, 85% { 
                transform: scale(1); 
                opacity: 0.3;
                filter: brightness(1) hue-rotate(0deg);
            }
            90% { 
                transform: scale(1.3); 
                opacity: 0.6;
                filter: brightness(1.8) hue-rotate(-20deg);
            }
            95% { 
                transform: scale(2.0); 
                opacity: 0;
                filter: brightness(2.2) hue-rotate(20deg);
            }
            100% { 
                transform: scale(1); 
                opacity: 0.3;
                filter: brightness(1) hue-rotate(0deg);
            }
        }

        @keyframes connectionDegraded {
            0%, 50% { 
                opacity: 1;
                filter: brightness(1) hue-rotate(0deg);
            }
            51%, 100% { 
                opacity: 0.7;
                filter: brightness(1.2) hue-rotate(15deg);
            }
        }

        @keyframes connectionDegradedRing {
            0% { 
                transform: scale(1); 
                opacity: 0.4;
                filter: brightness(1);
            }
            25% { 
                transform: scale(1.6); 
                opacity: 0.2;
                filter: brightness(1.2);
            }
            50% { 
                transform: scale(1); 
                opacity: 0.4;
                filter: brightness(1);
            }
            75% { 
                transform: scale(1.6); 
                opacity: 0.2;
                filter: brightness(1.2);
            }
            100% { 
                transform: scale(1); 
                opacity: 0.4;
                filter: brightness(1);
            }
        }

        .header-time {
            font-size: 0.9rem;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.8);
            font-family: 'Courier New', monospace;
            margin-left: 2.5rem; /* Align with brand text */
        }

        /* Body Panel Styles */
        .body-panel {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }


        
        /* Sidebar Styles */
        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }
        
        .sidebar-nav {
            padding: 1.5rem 1rem;
        }
        
        .nav-section-title {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--secondary-color);
            margin-bottom: 1rem;
            padding: 0 0.75rem;
            letter-spacing: 0.5px;
        }
        
        .nav-pills .nav-link {
            border-radius: var(--border-radius);
            margin-bottom: 0.25rem;
            padding: 0.75rem;
            color: var(--dark-color);
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            background: none;
            text-align: left;
            width: 100%;
        }
        
        .nav-pills .nav-link:hover {
            background: var(--primary-light);
            color: var(--primary-color);
            transform: translateX(5px);
        }
        
        .nav-pills .nav-link.active {
            background: var(--primary-color);
            color: var(--white);
            box-shadow: var(--shadow-light);
        }
        
        .nav-sub {
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
            margin-left: 1rem;
        }
        
        /* Content Loading */
        .content-loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: var(--secondary-color);
        }
        
        .loading-spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Smooth breathing animation for status refresh */
        @keyframes statusBreathing {
            0% {
                opacity: 1;
                transform: scale(1);
                filter: drop-shadow(0 0 2px rgba(40, 167, 69, 0.3));
            }
            25% {
                opacity: 0.4;
                transform: scale(0.95);
                filter: drop-shadow(0 0 6px rgba(40, 167, 69, 0.6));
            }
            50% {
                opacity: 0.2;
                transform: scale(0.9);
                filter: drop-shadow(0 0 8px rgba(40, 167, 69, 0.8));
            }
            75% {
                opacity: 0.4;
                transform: scale(0.95);
                filter: drop-shadow(0 0 6px rgba(40, 167, 69, 0.6));
            }
            100% {
                opacity: 1;
                transform: scale(1);
                filter: drop-shadow(0 0 2px rgba(40, 167, 69, 0.3));
            }
        }

        .status-breathing {
            animation: statusBreathing 2s ease-in-out infinite;
            transform-origin: center;
            transition: all 0.3s ease;
        }

        /* Realistic heartbeat animation for status icon */
        @keyframes statusHeartbeat {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            14% {
                transform: scale(1.3);
                opacity: 0.8;
            }
            28% {
                transform: scale(1);
                opacity: 1;
            }
            42% {
                transform: scale(1.3);
                opacity: 0.8;
            }
            70% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .status-beating {
            animation: statusHeartbeat 1.2s ease-in-out infinite;
            transform-origin: center;
            filter: drop-shadow(0 0 6px rgba(220, 53, 69, 0.6));
            transition: filter 0.3s ease;
        }
        
        /* Enhanced heartbeat with color pulse for health status */
        @keyframes statusHeartbeatWithGlow {
            0% {
                transform: scale(1);
                opacity: 1;
                filter: drop-shadow(0 0 4px rgba(40, 167, 69, 0.4));
            }
            14% {
                transform: scale(1.3);
                opacity: 0.8;
                filter: drop-shadow(0 0 8px rgba(40, 167, 69, 0.8));
            }
            28% {
                transform: scale(1);
                opacity: 1;
                filter: drop-shadow(0 0 4px rgba(40, 167, 69, 0.4));
            }
            42% {
                transform: scale(1.3);
                opacity: 0.8;
                filter: drop-shadow(0 0 8px rgba(40, 167, 69, 0.8));
            }
            70% {
                transform: scale(1);
                opacity: 1;
                filter: drop-shadow(0 0 4px rgba(40, 167, 69, 0.4));
            }
            100% {
                transform: scale(1);
                opacity: 1;
                filter: drop-shadow(0 0 4px rgba(40, 167, 69, 0.4));
            }
        }
        
        /* Healthy status gets green glow heartbeat */
        .status-beating.text-success {
            animation: statusHeartbeatWithGlow 1.2s ease-in-out infinite;
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .dashboard-sidebar {
                position: fixed;
                left: -280px;
                height: 100vh;
                transition: left 0.3s ease;
                z-index: 1050;
            }
            
            .dashboard-sidebar.show {
                left: 0;
            }
            
            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1040;
                display: none;
            }
            
            .sidebar-overlay.show {
                display: block;
            }

            .top-panel {
                padding: 1.5rem 1rem;
                margin: 0.5rem;
                grid-template-columns: 1fr;
                text-align: center;
                gap: 1rem;
            }

            .top-left, .top-center, .top-right {
                justify-self: center;
            }

            .top-left {
                align-items: center;
                text-align: center;
            }

            .brand-section {
                justify-content: center;
            }

            .header-time {
                margin-left: 0;
                font-size: 0.85rem;
            }

            .page-title {
                font-size: 1.8rem;
            }

            .top-right {
                align-items: center;
                gap: 0.75rem;
            }

            .user-section {
                flex-direction: column;
                gap: 0.5rem;
            }

            .user-info {
                flex-direction: column;
                gap: 0.25rem;
                text-align: center;
            }

            .user-avatar {
                font-size: 1.5rem;
            }

            .user-name {
                font-size: 0.85rem;
            }

            .logout-btn {
                font-size: 0.8rem;
                padding: 0.3rem 0.5rem;
            }

            .system-section {
                gap: 0.25rem;
            }

            .header-time {
                font-size: 0.8rem;
            }
            
            .body-panel {
                padding: 1rem;
            }


        }
        
        .breadcrumb-container {
            background: var(--white);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            margin: 0;
        }
        
        .breadcrumb {
            margin: 0;
            background: transparent;
            padding: 0;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="dashboard-sidebar" id="dashboardSidebar">
            <!-- Sidebar Header -->
            <div class="sidebar-header">
                <i class="fas fa-ice-cream text-primary fa-2x"></i>
                <h5 class="mt-2 mb-0">Ice Cream Store</h5>
                <small class="text-muted">Management Dashboard</small>
            </div>
            
            <!-- Navigation -->
            <nav class="sidebar-nav">
                <h6 class="nav-section-title">
                    <i class="fas fa-layer-group me-2"></i>Services
                </h6>
                
                <ul class="nav nav-pills flex-column">
                    <li class="nav-item">
                        <button class="nav-link active" onclick="loadContent('dashboard')" data-page="dashboard">
                            <i class="fas fa-home me-2"></i>
                            Dashboard
                        </button>
                    </li>
                    
                    <li class="nav-item">
                        <button class="nav-link" onclick="loadContent('orders')" data-page="orders">
                            <i class="fas fa-shopping-cart me-2"></i>
                            Orders
                        </button>
                    </li>
                    
                    <li class="nav-item">
                        <button class="nav-link" onclick="toggleSubmenu('inventory')" data-page="inventory">
                            <i class="fas fa-warehouse me-2"></i>
                            Inventory
                            <i class="fas fa-chevron-down ms-auto"></i>
                        </button>
                        <ul class="nav flex-column ms-3" id="inventory-submenu" style="display: none;">
                            <li class="nav-item">
                                <li class="nav-item">
                                    <button class="nav-link nav-sub" onclick="toggleSubmenu('ingredients')" data-page="inventory-ingredients">
                                        <i class="fas fa-seedling me-2"></i>Ingredients
                                        <i class="fas fa-chevron-down ms-auto"></i>
                                    </button>
                                    <ul class="nav flex-column ms-3" id="ingredients-submenu" style="display: none;">
                                        <li class="nav-item">
                                            <button class="nav-link nav-sub" onclick="loadContent('inventory-ingredients')" data-page="inventory-ingredients">
                                                <i class="fas fa-seedling me-2"></i>All Ingredients
                                            </button>
                                        </li>
                                        <li class="nav-item">
                                            <button class="nav-link nav-sub" onclick="loadContent('inventory-categories')" data-page="inventory-categories">
                                                <i class="fas fa-tags me-2"></i>Categories
                                            </button>
                                        </li>
                                        <li class="nav-item">
                                            <button class="nav-link nav-sub" onclick="loadContent('inventory-runout-ingredients')" data-page="inventory-runout-ingredients">
                                                <i class="fas fa-exclamation-triangle me-2"></i>Runout Ingredients
                                            </button>
                                        </li>
                                    </ul>
                            <li class="nav-item">
                                <button class="nav-link nav-sub" onclick="loadContent('inventory-existences')" data-page="inventory-existences">
                                    <i class="fas fa-boxes me-2"></i>Existences
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link nav-sub" onclick="toggleSubmenu('recipes')">
                                    <i class="fas fa-utensils me-2"></i>Recipes
                                    <i class="fas fa-chevron-down ms-auto"></i>
                                </button>
                                <ul class="nav flex-column ms-3" id="recipes-submenu" style="display: none;">
                                    <li class="nav-item">
                                        <button class="nav-link nav-sub" onclick="loadContent('inventory-recipes')" data-page="inventory-recipes">
                                            <i class="fas fa-utensils me-2"></i>All Recipes
                                        </button>
                                    </li>
                                    <li class="nav-item">
                                        <button class="nav-link nav-sub" onclick="loadContent('inventory-recipe-categories')" data-page="inventory-recipe-categories">
                                            <i class="fas fa-tags me-2"></i>Recipe Categories
                                        </button>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                    
                    <li class="nav-item">
                        <button class="nav-link" onclick="toggleSubmenu('invoice')" data-page="invoice">
                            <i class="fas fa-file-invoice me-2"></i>
                            Invoice
                            <i class="fas fa-chevron-down ms-auto"></i>
                        </button>
                        <ul class="nav flex-column ms-3" id="invoice-submenu" style="display: none;">
                            <li class="nav-item">
                                <button class="nav-link nav-sub" onclick="loadContent('invoice')" data-page="invoice">
                                    <i class="fas fa-chart-pie me-2"></i>Overview
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link nav-sub" onclick="loadContent('invoice-details')" data-page="invoice-details">
                                    <i class="fas fa-receipt me-2"></i>
                                    Invoice Management
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link nav-sub" onclick="loadContent('invoice-expense-categories')" data-page="invoice-expense-categories">
                                    <i class="fas fa-tags me-2"></i>Expense Categories
                                </button>
                            </li>
                        </ul>
                    </li>
                </ul>
            </nav>
            
            <!-- Sidebar Footer -->
            <div class="sidebar-footer" style="padding: 1.5rem; border-top: 1px solid var(--border-color); margin-top: auto;">
                <div class="text-center text-muted">
                    <small>© 2024 Ice Cream Store</small>
                </div>
            </div>
        </div>
        
        <!-- Mobile sidebar overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
        
        <!-- Main Content Area -->
        <div class="dashboard-main">
            <!-- Top Panel - Hierarchical Design -->
            <div class="top-panel">
                <div class="top-left">
                    <div class="brand-section">
                        <i class="fas fa-ice-cream brand-icon"></i>
                        <span class="brand-name">Dashboard</span>
                    </div>
                    <div class="header-time" id="header-time">--:--:--</div>
                </div>
                <div class="top-center">
                    <h1 class="page-title" id="page-title">Dashboard</h1>
                    <p class="page-subtitle" id="page-subtitle">Welcome to your business management dashboard</p>
                </div>
                <div class="top-right">
                    <!-- User Profile & Logout -->
                    <div class="user-section">
                        <div class="user-info">
                            <i class="fas fa-user-circle user-avatar"></i>
                            <span class="user-name" id="user-name">Loading...</span>
                        </div>
                        <button class="btn btn-outline-light btn-sm logout-btn" onclick="logout()" title="Logout">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                    
                    <!-- System Status -->
                    <div class="system-section">
                        <div class="header-status" id="system-status">
                            <div class="system-status-indicator online" id="system-status-icon">
                                <div class="connection-indicator"></div>
                            </div>
                            <span id="system-status-text">System Online</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Body Panel - Where partial content loads -->
            <div class="body-panel" id="main-content">
                <!-- Initial loading state -->
                <div class="content-loader">
                    <div class="loading-spinner"></div>
                    <span>Loading dashboard...</span>
                </div>
            </div>
        </div>
    </div>



    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Configuration -->
    <script src="config.js?v=1.3"></script>
    
    <!-- Shared JavaScript -->
    <script src="shared/js/auth.js?v=1.3"></script>
    <script src="shared/js/alerts.js?v=1.3"></script>
    
    <script>
        let currentPage = 'dashboard';
        let auth = null;

        // Initialize SPA Dashboard
        async function initializeDashboard() {
            try {
                // Check authentication
                if (!isAuthenticated()) {
                    window.location.href = 'login.html';
                    return;
                }

                // Initialize health monitoring
                startHealthMonitoring();
                
                // Load initial content
                await loadContent('dashboard');
                
            } catch (error) {
                console.error('❌ Dashboard initialization failed:', error);
                showError('Failed to initialize dashboard. Please refresh the page.');
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize authentication
            auth = new AuthService();
            if (!auth.isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }
            
            // Load user info
            loadUserInfo();
            
            // Load initial dashboard content
            await loadContent('dashboard');
            
            // Initialize dynamic connections for architecture diagram
            if (window.initializeDynamicConnections) {
                window.initializeDynamicConnections();
            }
            
            // Start automatic health monitoring
            startHealthMonitoring();
            
            // Additional health check to ensure proper button states after content load
            setTimeout(() => {
                updateSystemStatus(false);
            }, 2000);
            
            // Test SweetAlert2 system
            setTimeout(() => {
                Alert.success('Dashboard Ready', 'Welcome to your Ice Cream Store management system!');
            }, 1000);
        });

        // Content loading function
        async function loadContent(page) {
            try {
                // Show loading state
                showLoading();
                
                // Update navigation state
                updateActiveNavigation(page);
                
                // Update page title and breadcrumb in top panel
                updatePageInfo(page);
                
                // Load content based on page - this loads into body panel only
                let contentUrl, html;
                
                // Load content based on page - all pages load their partial content
                contentUrl = getContentUrl(page);
                const response = await fetch(contentUrl);
                if (!response.ok) {
                    throw new Error(`Failed to load content: ${response.status}`);
                }
                html = await response.text();
                
                // Load content into body panel
                document.getElementById('main-content').innerHTML = html;
                
                // Initialize page-specific functionality
                await initializePageContent(page);
                
                currentPage = page;
                
            } catch (error) {
                console.error('❌ Error loading content:', error);
                showError('Failed to load page content. Please try again.');
            }
        }

        // Get content URL for each page
        function getContentUrl(page) {
                    const contentMap = {
            'dashboard': 'partials/dashboard/index.html',
            'orders': 'partials/orders/index.html',
            'inventory': 'partials/inventory/index.html',
            'inventory-suppliers': 'partials/inventory/suppliers.html',
            'inventory-ingredients': 'partials/inventory/ingredients.html',
            'inventory-categories': 'partials/inventory/categories.html',
            'inventory-existences': 'partials/inventory/existences.html',
            'inventory-runout-ingredients': 'partials/inventory/runout-ingredients.html',
            'inventory-recipe-categories': 'partials/inventory/recipe-categories.html',
            'inventory-recipes': 'partials/inventory/recipes.html',
            'invoice': 'partials/invoice/index.html',
            'invoice-details': 'partials/invoice/invoice.html',
            'invoice-expense-categories': 'partials/invoice/expense-categories.html'
        };
        
        return contentMap[page] || 'partials/dashboard/index.html';
        }

        // Initialize page-specific content
        async function initializePageContent(page) {
            const initMap = {
                'dashboard': 'initDashboardContent',
                'orders': 'initOrdersContent',
                'inventory': 'initInventoryContent',
                'inventory-suppliers': 'initSuppliersContent',
                'inventory-ingredients': 'initIngredientsContent',
                'inventory-categories': 'initCategoriesContent',
                'inventory-existences': 'initExistencesContent',
                'inventory-runout-ingredients': 'initRunoutIngredientsContent',
                'inventory-recipe-categories': 'initRecipeCategoriesContent',
                'inventory-recipes': 'initRecipesContent',
                'invoice': 'initInvoiceContent',
                'invoice-details': 'initInvoiceContent',
                'invoice-expense-categories': 'initExpenseCategoriesContent'
            };
            
            // Setup header time (always visible in top panel)
            setTimeout(() => {
                const headerTimeElement = document.getElementById('header-time');
                
                const updateHeaderTime = () => {
                    const currentTime = new Date().toLocaleTimeString();
                    if (headerTimeElement) {
                        headerTimeElement.textContent = currentTime;
                    }
                };
                
                updateHeaderTime(); // Set immediately
                setInterval(updateHeaderTime, 1000); // Update every second
            }, 200);
            
            const initFunction = initMap[page];
            if (initFunction && typeof window[initFunction] === 'function') {
                await window[initFunction]();
            }
            
            // Always update system status in top panel (on all pages)
            await updateSystemStatus();
        }

        // Update active navigation
        function updateActiveNavigation(page) {
            // Remove all active classes
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Add active class to current page
            const activeLink = document.querySelector(`[data-page="${page}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
        }

        // Update page title and subtitle with icons
        function updatePageInfo(page) {
            const pageInfo = {
                'dashboard': { 
                    title: 'Dashboard', 
                    subtitle: 'Welcome to your business management dashboard',
                    icon: 'fas fa-home'
                },
                'orders': { 
                    title: 'Orders Management', 
                    subtitle: 'Manage customer orders, track status, and handle fulfillment',
                    icon: 'fas fa-tools'
                },
                'inventory': { 
                    title: 'Inventory Overview', 
                    subtitle: 'Track ingredients, manage suppliers, and monitor stock levels',
                    icon: 'fas fa-warehouse'
                },
                'inventory-suppliers': { 
                    title: 'Suppliers Management', 
                    subtitle: 'Manage supplier relationships and vendor information',
                    icon: 'fas fa-truck'
                },
                'inventory-ingredients': { 
                    title: 'Ingredients Management', 
                    subtitle: 'Track ingredient inventory and recipe components',
                    icon: 'fas fa-seedling'
                },
                'inventory-categories': { 
                    title: 'Ingredient Categories', 
                    subtitle: 'Organize and manage ingredient categories for better inventory classification',
                    icon: 'fas fa-tags'
                },
                'inventory-existences': { 
                    title: 'Inventory Existences', 
                    subtitle: 'Track purchase batches, stock levels, and cost analysis of ingredients',
                    icon: 'fas fa-boxes'
                },
                'inventory-runout-ingredients': { 
                    title: 'Runout Ingredients', 
                    subtitle: 'Track and manage ingredients that are running out of stock',
                    icon: 'fas fa-exclamation-triangle'
                },
                'inventory-recipe-categories': { 
                    title: 'Recipe Categories', 
                    subtitle: 'Organize and manage recipe categories for better classification',
                    icon: 'fas fa-tags'
                },
                'inventory-recipes': { 
                    title: 'Recipes Management', 
                    subtitle: 'Create and manage recipes with ingredients and instructions',
                    icon: 'fas fa-utensils'
                },

                'invoice': { 
                    title: 'Invoice Management', 
                    subtitle: 'Manage invoices, track payments, and handle billing',
                    icon: 'fas fa-file-invoice-dollar'
                },
                'invoice-details': { 
                    title: 'Invoice Details', 
                    subtitle: 'View and manage detailed invoice information',
                    icon: 'fas fa-receipt'
                },
                'invoice-expense-categories': { 
                    title: 'Expense Categories', 
                    subtitle: 'Manage expense categories for invoice classification',
                    icon: 'fas fa-tags'
                }
            };
            
            const info = pageInfo[page] || pageInfo['dashboard'];
            
            // Update page title and subtitle in top panel
            const pageTitleElement = document.getElementById('page-title');
            const pageSubtitleElement = document.getElementById('page-subtitle');
            
            if (pageTitleElement) {
                pageTitleElement.innerHTML = `<i class="${info.icon} me-2"></i>${info.title}`;
            }
            if (pageSubtitleElement) {
                pageSubtitleElement.textContent = info.subtitle;
            }
            
            // Update document title
            document.title = `Ice Cream Store - ${info.title}`;
        }

        // Toggle submenu
        function toggleSubmenu(menuId) {
            const submenu = document.getElementById(menuId + '-submenu');
            if (submenu) {
                submenu.style.display = submenu.style.display === 'none' ? 'block' : 'none';
            }
        }

        // Show loading state
        function showLoading() {
            document.getElementById('main-content').innerHTML = `
                <div class="content-loader">
                    <div class="loading-spinner"></div>
                    <span>Loading content...</span>
                </div>
            `;
        }

        // Show error state
        function showError(message) {
            document.getElementById('main-content').innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-4x text-danger mb-3"></i>
                    <h3>Error Loading Content</h3>
                    <p class="text-muted mb-4">${message}</p>
                    <button class="btn btn-primary" onclick="loadContent('${currentPage}')">
                        <i class="fas fa-refresh me-2"></i>Retry
                    </button>
                </div>
            `;
        }

        // Load user info
        function loadUserInfo() {
            try {
                const userInfo = auth.getCurrentUser();
                if (userInfo) {
                    document.getElementById('user-name').textContent = userInfo.username || 'User';
                }
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        // Time display is now handled by dashboard content partial

        // Toggle mobile sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('dashboardSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        }

        // Logout function
        async function logout() {
            const result = await Alert.confirm('Confirm Logout', 'Are you sure you want to logout?', 'Yes, logout');
            if (result.isConfirmed) {
                Alert.toast('See you soon!', 'info');
                setTimeout(() => {
                    auth.logout();
                    window.location.href = 'login.html';
                }, 1000);
            }
        }

        // Global navigation function for content partials
        window.navigateToRoute = function(route) {
            loadContent(route);
        };

        /*
        ===========================================
        GENERIC MODAL MANAGEMENT SYSTEM
        ===========================================
        
        This system allows you to open modals from any page without worrying about:
        - Function not being defined yet (ReferenceError)
        - Need to navigate to specific pages first
        - Code duplication for modal management
        
        USAGE:
        1. HTML: <button onclick="openModal('ModalName', 'required-page')">
        2. JS: window.openModal('ModalName', 'required-page')
        
        FEATURES:
        - Auto-navigation to required pages
        - Smart waiting for functions to be defined
        - Backward compatibility with existing code
        - Debug helpers: listAvailableModals(), registerModal()
        */
        window.openModal = function(modalId, requiredPage = null) {
            
            // If a specific page is required and we're not on it, navigate first
            if (requiredPage && currentPage !== requiredPage) {
                loadContent(requiredPage).then(() => {
                    // After page loads, wait for the modal functions to be defined
                    setTimeout(() => {
                        const modalFunction = window[`open${modalId}`];
                        if (modalFunction && typeof modalFunction === 'function') {
                            modalFunction();
                        } else {
                            console.warn(`⚠️ Modal function open${modalId} not found after page load`);
                            Alert.warning('Modal Not Ready', 'Please wait for the page to fully load and try again.');
                        }
                    }, 500);
                });
            } else {
                // Already on correct page or no specific page required, try to open modal directly
                const modalFunction = window[`open${modalId}`];
                if (modalFunction && typeof modalFunction === 'function') {
                    modalFunction();
                } else {
                    // Function not yet loaded, wait a bit
                    setTimeout(() => {
                        const modalFunction = window[`open${modalId}`];
                        if (modalFunction && typeof modalFunction === 'function') {
                            modalFunction();
                        } else {
                            console.warn(`⚠️ Modal function open${modalId} not found after timeout`);
                            Alert.warning('Modal Not Ready', 'Please wait for the page to fully load and try again.');
                        }
                    }, 500);
                }
            }
        };

        // Debug helper to list all available modal functions
        window.listAvailableModals = function() {
            const modalFunctions = Object.keys(window).filter(key => 
                key.startsWith('open') && key.endsWith('Modal') && typeof window[key] === 'function'
            );
            return modalFunctions;
        };

        // Helper function for developers to register new modals easily
        window.registerModal = function(modalId, modalFunction, requiredPage = null) {
            const functionName = `open${modalId}`;
            window[functionName] = modalFunction;
            
            // Return a convenient onclick handler string
            return `openModal('${modalId}'${requiredPage ? `, '${requiredPage}'` : ''})`;
        };

        // Auto-refresh system health status every 2 seconds for real-time updates
        let healthCheckInterval = null;
        
        function startHealthMonitoring() {
            // Clear any existing interval
            if (healthCheckInterval) {
                clearInterval(healthCheckInterval);
            }
            
            // Set up automatic health checking every 2 seconds for real-time status
            healthCheckInterval = setInterval(async () => {
                await updateSystemStatus(true); // true = isAutoRefresh
            }, 2000); // 2 seconds for real-time updates
            
        }
        
        function stopHealthMonitoring() {
            if (healthCheckInterval) {
                clearInterval(healthCheckInterval);
                healthCheckInterval = null;
            }
        }

        // Alert system is loaded via shared/js/alerts.js (SweetAlert2)
        // Available methods:
        // Alert.success(title, text)
        // Alert.error(title, text) 
        // Alert.warning(title, text)
        // Alert.info(title, text)
        // Alert.comingSoon(feature)
        // Alert.toast(message, type)
        // Alert.confirm(title, text, confirmText)

        // Dashboard content initialization function
        window.initDashboardContent = async function() {
            
            try {
                // Service status will be loaded by the centralized updateSystemStatus() 
                // which is called automatically on page load and every 30 seconds
            } catch (error) {
                console.error('❌ Error initializing dashboard content:', error);
            }
        };

        // Old loadDashboardServiceStatus function removed - now handled by centralized updateSystemStatus()
        
        // Centralized system health checker - updates both top panel AND dashboard cards if present
        async function updateSystemStatus(isAutoRefresh = false) {
            const systemStatusElement = document.getElementById('system-status');
            const systemStatusIcon = document.getElementById('system-status-icon');
            const systemStatusText = document.getElementById('system-status-text');
            
            if (!systemStatusElement || !systemStatusIcon || !systemStatusText) {
                return; // Elements not found, skip update
            }
            
            // Start breathing animation to show refresh is active
            systemStatusIcon.classList.add('status-breathing');
            
            // Add visual indication during refresh
            
            try {
                const logPrefix = isAutoRefresh ? '🔄 [Auto]' : '🔍';
                
                // Use AbortController for better browser compatibility
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch(CONFIG.GATEWAY_URL + '/api/health', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const healthData = await response.json();
                    
                    // Update top panel based on overall status and service counts
                    if (healthData.status === 'healthy') {
                        systemStatusIcon.className = 'system-status-indicator online';
                        systemStatusText.textContent = 'System Online';
                        systemStatusElement.className = 'header-status';
                    } else if (healthData.status === 'degraded') {
                        // Always show degraded when any services are down
                        // Gateway remains operational for system recovery
                        systemStatusIcon.className = 'system-status-indicator degraded';
                        systemStatusText.textContent = 'System Degraded';
                        systemStatusElement.className = 'header-status header-status-warning';
                    } else {
                        // Unknown status or gateway completely unreachable = treat as offline for safety
                        systemStatusIcon.className = 'system-status-indicator offline';
                        systemStatusText.textContent = 'System Offline';
                        systemStatusElement.className = 'header-status header-status-error';
                    }
                    
                    // Update individual service cards if they exist (dashboard page)
                    if (healthData.services) {
                        updateServiceCards(healthData.services, healthData.status);
                    }
                    
                } else {
                    throw new Error(`Gateway health check failed: ${response.status}`);
                }
                
            } catch (error) {
                const logPrefix = isAutoRefresh ? '🔄 [Auto]' : '❌';
                console.error(`${logPrefix} System status check failed:`, error.message);
                // Gateway unreachable = system offline
                systemStatusIcon.className = 'system-status-indicator offline';
                systemStatusText.textContent = 'System Offline';
                systemStatusElement.className = 'header-status header-status-error';
                
                // Mark all service cards as offline if they exist
                markAllServiceCardsOffline();
                
            } finally {
                // Stop breathing animation - smooth transition back to normal
                systemStatusIcon.classList.remove('status-breathing');
            }
        }
        
        // Update individual service cards based on gateway health response
        function updateServiceCards(servicesStatus, overallStatus = 'healthy') {
            const serviceMapping = {
                'data-service': 'data',
                'gateway-service': 'gateway', 
                'session-service': 'session',
                'orders-service': 'orders',
                'inventory-service': 'inventory',
                'invoice-service': 'invoice'
            };
            
            for (const [gatewayServiceName, cardId] of Object.entries(serviceMapping)) {
                const statusElement = document.getElementById(`${cardId}-status`);
                if (!statusElement) continue; // Card not present on current page
                
                const serviceStatus = servicesStatus[gatewayServiceName];
                
                // Special handling for gateway service - should reflect overall system status
                if (cardId === 'gateway') {
                    if (overallStatus === 'healthy') {
                        statusElement.className = 'service-status online';
                        statusElement.innerHTML = '<div class="connection-indicator"></div><span class="connection-text">Online</span>';
                        console.log(`✅ ${cardId} card: Online (system healthy)`);
                    } else if (overallStatus === 'degraded') {
                        statusElement.className = 'service-status degraded';
                        statusElement.innerHTML = '<div class="connection-indicator"></div><span class="connection-text">Degraded</span>';
                        console.log(`⚠️  ${cardId} card: Degraded (system degraded)`);
                    } else {
                        statusElement.className = 'service-status offline';
                        statusElement.innerHTML = '<div class="connection-indicator"></div><span class="connection-text">Offline</span>';
                        console.log(`❌ ${cardId} card: Offline`);
                    }
                } else {
                    // For all other services, use individual service status
                    if (serviceStatus === 'healthy') {
                        statusElement.className = 'service-status online';
                        statusElement.innerHTML = '<div class="connection-indicator"></div><span class="connection-text">Online</span>';
                        console.log(`✅ ${cardId} card: Online`);
                    } else if (serviceStatus === 'unhealthy') {
                        statusElement.className = 'service-status offline';
                        statusElement.innerHTML = '<div class="connection-indicator"></div><span class="connection-text">Offline</span>';
                        console.log(`❌ ${cardId} card: Offline`);
                    } else {
                        statusElement.className = 'service-status degraded';
                        statusElement.innerHTML = '<div class="connection-indicator"></div><span class="connection-text">Unknown</span>';
                        console.log(`⚠️  ${cardId} card: Unknown status`);
                    }
                }
            }
            
            // Update architecture diagram if present
            if (typeof window.updateArchitectureStatus === 'function') {
                window.updateArchitectureStatus(servicesStatus, overallStatus);
            }
            
            // Update connection lines and dots if present
            if (typeof window.updateConnectionLines === 'function') {
                window.updateConnectionLines(servicesStatus, overallStatus);
            }
            
            // Update service management buttons based on current status
            updateAllServiceButtons(servicesStatus);
        }
        
        // Mark all service cards as offline (when gateway is unreachable)
        function markAllServiceCardsOffline() {
            const serviceIds = ['data', 'gateway', 'session', 'orders', 'inventory', 'invoice'];
            
            serviceIds.forEach(serviceId => {
                const statusElement = document.getElementById(`${serviceId}-status`);
                if (statusElement) {
                    statusElement.className = 'service-status offline';
                    statusElement.innerHTML = '<div class="connection-indicator"></div><span class="connection-text">Offline</span>';
                    console.log(`❌ ${serviceId} card: Marked offline (gateway unreachable)`);
                }
                
                // Also disable management buttons (assume database is also down when gateway is unreachable)
                updateServiceButtons(serviceId, false, false);
            });
            
            // Update architecture diagram if present
            if (typeof window.markAllArchitectureOffline === 'function') {
                window.markAllArchitectureOffline();
            }
        }

        // Environment configuration for service management
        const ENVIRONMENT_CONFIG = {
            // Default environment - can be changed dynamically
            current: 'locally', // Options: 'locally', 'container'
            
            // Available environments
            environments: {
                locally: 'locally',
                container: 'container'
            }
        };

        // Service management function
        async function manageService(serviceName, action, clickedButton = null) {
            const env = ENVIRONMENT_CONFIG.current;
            console.log(`🔧 Managing ${serviceName}: ${action} (${env})`);
            
            // Find the clicked button if not provided
            if (!clickedButton) {
                clickedButton = event ? event.target.closest('.action-btn') : null;
            }
            
            // Set loading state on the specific clicked button
            if (clickedButton) {
                setButtonLoadingState(clickedButton, true);
            }
            
            // Immediately update header status to show operation in progress
            updateHeaderStatusDuringOperation(action);
            
            // Disable all buttons for this service during operation
            disableServiceButtons(serviceName, true);
            
            try {
                const response = await fetch(`${CONFIG.GATEWAY_URL}/api/management/services/${serviceName}/${action}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        environment: env
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log(`✅ ${serviceName} ${action} successful:`, result.message);
                    
                    // Show success state on clicked button
                    if (clickedButton) {
                        setButtonSuccessState(clickedButton);
                    }
                    
                    Alert.success(`Service ${action.charAt(0).toUpperCase() + action.slice(1)}`, 
                        `${serviceName} ${action} completed successfully!`);
                    
                    // Special handling for data-service start: auto-restart dependent services
                    if (serviceName === 'data-service' && action === 'start') {
                        // Extended refresh schedule for auto-restart scenario
                        setTimeout(() => {
                            updateSystemStatus(false);
                        }, 10000);
                        
                        setTimeout(() => {
                            updateSystemStatus(false);
                        }, 20000);
                        
                        setTimeout(() => {
                            updateSystemStatus(false);
                            Alert.success('Auto-Restart Complete', 
                                'All dependent services have been restarted and are reconnecting!');
                        }, 30000);
                    }
                    
                    // Immediately refresh header and dashboard status after success
                    updateSystemStatus(false);
                    
                    // Additional refresh after delays to ensure services are fully up/down
                    setTimeout(() => {
                        updateSystemStatus(false);
                    }, 3000);
                    
                    // Final refresh to ensure status is accurate
                    setTimeout(() => {
                        updateSystemStatus(false);
                    }, 6000);
                } else {
                    const error = await response.json();
                    console.error(`❌ ${serviceName} ${action} failed:`, error.message);
                    
                    // Show error state on clicked button
                    if (clickedButton) {
                        setButtonErrorState(clickedButton);
                    }
                    
                    Alert.error(`Service ${action} Failed`, 
                        `Failed to ${action} ${serviceName}: ${error.message}`);
                    
                    // Refresh status on failure to show actual state
                    updateSystemStatus(false);
                    
                    // Additional refresh after delay
                    setTimeout(() => {
                        updateSystemStatus(false);
                    }, 3000);
                }
                
            } catch (error) {
                console.error(`❌ ${serviceName} ${action} error:`, error);
                
                // Show error state on clicked button
                if (clickedButton) {
                    setButtonErrorState(clickedButton);
                }
                
                Alert.error(`Service ${action} Error`, 
                    `Network error while trying to ${action} ${serviceName}`);
                
                // Refresh status on error to show actual state
                updateSystemStatus(false);
                
                // Additional refresh after delay
                setTimeout(() => {
                    updateSystemStatus(false);
                }, 3000);
            } finally {
                // Remove loading state and re-enable buttons based on current service status after a short delay
                setTimeout(() => {
                    if (clickedButton) {
                        clearButtonState(clickedButton);
                    }
                    // Re-enable buttons will be handled by updateSystemStatus → updateServiceCards → updateAllServiceButtons
                    updateSystemStatus(false);
                }, 800); // Reduced delay - just enough time for success/error animation to show
            }
        }

        // Helper function to update service card visibility based on button states
        function updateServiceCardVisibility(button) {
            if (!button) return;
            
            const serviceCard = button.closest('.service-card');
            if (!serviceCard) return;
            
            const serviceActions = serviceCard.querySelector('.service-actions');
            if (!serviceActions) return;
            
            // Check if any button in this service has active operations
            const hasActiveOperations = serviceActions.querySelector('.action-btn.loading, .action-btn.success, .action-btn.error');
            
            if (hasActiveOperations) {
                serviceCard.classList.add('has-active-operations');
            } else {
                serviceCard.classList.remove('has-active-operations');
            }
        }

        // Button state management functions
        function setButtonLoadingState(button, isLoading) {
            if (!button) return;
            
            if (isLoading) {
                button.classList.add('loading');
                button.classList.remove('success', 'error');
                button.disabled = true;
                
                // Store original content
                button.dataset.originalHTML = button.innerHTML;
                
                console.log(`🔄 Button loading state: ${button.title || 'Unknown'}`);
            } else {
                button.classList.remove('loading');
                button.disabled = false;
                
                // Restore original content if stored
                if (button.dataset.originalHTML) {
                    button.innerHTML = button.dataset.originalHTML;
                    delete button.dataset.originalHTML;
                }
            }
            
            // Update service card visibility
            updateServiceCardVisibility(button);
        }

        function setButtonSuccessState(button) {
            if (!button) return;
            
            button.classList.remove('loading');
            button.classList.add('success');
            button.classList.remove('error');
            
            console.log(`✅ Button success state: ${button.title || 'Unknown'}`);
            
            // Update service card visibility
            updateServiceCardVisibility(button);
            
            // Clear success state after animation
            setTimeout(() => {
                if (button.classList.contains('success')) {
                    button.classList.remove('success');
                    // Update visibility again after clearing state
                    updateServiceCardVisibility(button);
                }
            }, 600);
        }

        function setButtonErrorState(button) {
            if (!button) return;
            
            button.classList.remove('loading');
            button.classList.remove('success');
            button.classList.add('error');
            
            console.log(`❌ Button error state: ${button.title || 'Unknown'}`);
            
            // Update service card visibility
            updateServiceCardVisibility(button);
            
            // Clear error state after animation
            setTimeout(() => {
                if (button.classList.contains('error')) {
                    button.classList.remove('error');
                    // Update visibility again after clearing state
                    updateServiceCardVisibility(button);
                }
            }, 600);
        }

        function clearButtonState(button) {
            if (!button) return;
            
            button.classList.remove('loading', 'success', 'error');
            button.disabled = false;
            
            // Restore original content if stored
            if (button.dataset.originalHTML) {
                button.innerHTML = button.dataset.originalHTML;
                delete button.dataset.originalHTML;
            }
            
            // Update service card visibility
            updateServiceCardVisibility(button);
            
            console.log(`🔄 Button state cleared: ${button.title || 'Unknown'}`);
        }

        function disableServiceButtons(serviceName, disable) {
            const servicePrefix = serviceName.split('-')[0];
            const buttons = document.querySelectorAll(`button[onclick*="'${serviceName}'"]`);
            
            buttons.forEach(button => {
                // Don't change state of buttons that are currently showing loading/success/error animations
                if (!button.classList.contains('loading') && !button.classList.contains('success') && !button.classList.contains('error')) {
                    button.disabled = disable;
                }
            });
            
            console.log(`🔧 Service buttons ${disable ? 'disabled' : 'enabled'}: ${serviceName} (${buttons.length} buttons)`);
        }

        // Enhanced context menu action with button reference
        function contextMenuActionWithButton(action) {
            if (currentContextService && typeof window.manageService === 'function') {
                // Find the button in the context menu that was clicked
                const contextButton = event ? event.target.closest('.context-menu-item') : null;
                
                // Execute the service management action
                window.manageService(currentContextService, action, contextButton);
            }
            hideContextMenu();
        }

        // Function to update header status during service operations
        function updateHeaderStatusDuringOperation(action) {
            const systemStatusElement = document.getElementById('system-status');
            const systemStatusIcon = document.getElementById('system-status-icon');
            const systemStatusText = document.getElementById('system-status-text');
            
            if (systemStatusElement && systemStatusIcon && systemStatusText) {
                // Add breathing animation and show operation in progress
                systemStatusIcon.classList.add('status-breathing');
                systemStatusIcon.className = 'system-status-indicator checking status-breathing';
                systemStatusText.textContent = `${action.charAt(0).toUpperCase() + action.slice(1)}ing Service...`;
                systemStatusElement.className = 'header-status header-status-warning';
                
                console.log(`🔄 Header status updated: ${action}ing service...`);
            }
        }

        // Update service management buttons based on status
        function updateServiceButtons(servicePrefix, isOnline, dataServiceHealthy = true) {
            const startBtn = document.querySelector(`button[onclick*="manageService('${servicePrefix}-service', 'start'"]`);
            const stopBtn = document.querySelector(`button[onclick*="manageService('${servicePrefix}-service', 'stop'"]`);
            const restartBtn = document.querySelector(`button[onclick*="manageService('${servicePrefix}-service', 'restart'"]`);
            
            // Services that depend on database (including gateway since it routes to business services)
            const databaseDependentServices = ['session', 'orders', 'inventory', 'invoice', 'gateway'];
            const isDatabaseDependent = databaseDependentServices.includes(servicePrefix);
            
            if (startBtn && stopBtn && restartBtn) {
                // Helper function to safely update button if not in animation state
                function safeUpdateButton(button, shouldDisable, reason = '') {
                    const hasLoading = button.classList.contains('loading');
                    const hasSuccess = button.classList.contains('success');
                    const hasError = button.classList.contains('error');
                    
                    // Don't change button state if it's currently showing loading/success/error animations
                    if (!hasLoading && !hasSuccess && !hasError) {
                        button.disabled = shouldDisable;
                        console.log(`🔘 ${button.title}: ${shouldDisable ? 'DISABLED' : 'ENABLED'} ${reason}`);
                    } else {
                        console.log(`🔄 ${button.title}: Skipped update (in animation)`);
                    }
                }
                
                if (isOnline) {
                    // Service is online: disable start, enable stop and restart
                    safeUpdateButton(startBtn, true, '(service online)');
                    safeUpdateButton(stopBtn, false, '(service online)');
                    safeUpdateButton(restartBtn, false, '(service online)');
                } else {
                    // Service is offline
                    if (servicePrefix === 'gateway') {
                        // Special handling for gateway: always keep start button enabled when offline
                        // This allows users to restart the system even when everything is down
                        safeUpdateButton(startBtn, false, '(gateway offline - can restart system)');
                        safeUpdateButton(stopBtn, true, '(service offline)');
                        safeUpdateButton(restartBtn, false, '(gateway offline - can restart)');
                        console.log('🚪 Gateway offline: Start/Restart buttons enabled for system recovery');
                    } else if (isDatabaseDependent && !dataServiceHealthy) {
                        // Database-dependent service is down AND database is down: disable all buttons
                        safeUpdateButton(startBtn, true, '(database down - cannot start)');
                        safeUpdateButton(stopBtn, true, '(service offline)');
                        safeUpdateButton(restartBtn, true, '(database down - cannot restart)');
                    } else {
                        // Service is down but database is healthy (or this is data-service itself)
                        safeUpdateButton(startBtn, false, '(service offline - can start)');
                        safeUpdateButton(stopBtn, true, '(service offline)');
                        safeUpdateButton(restartBtn, true, '(service offline)');
                    }
                }
                
                console.log(`🔧 Service buttons updated for ${servicePrefix}-service: ${isOnline ? 'Online' : 'Offline'} (DB: ${dataServiceHealthy ? 'healthy' : 'down'}${isDatabaseDependent ? ' - DB dependent' : ' - Independent'})`);
            }
        }

        // Update button states based on service status
        function updateAllServiceButtons(servicesStatus) {
            const serviceMapping = {
                'data-service': 'data',
                'gateway-service': 'gateway', 
                'session-service': 'session',
                'orders-service': 'orders',
                'inventory-service': 'inventory',
                'invoice-service': 'invoice'
            };
            
            console.log('🔧 updateAllServiceButtons called with:', servicesStatus);
            
            // Check if data-service is healthy
            const dataServiceHealthy = servicesStatus['data-service'] === 'healthy';
            console.log(`📊 Data service status: ${dataServiceHealthy ? 'healthy' : 'unhealthy'}`);
            
            for (const [gatewayServiceName, servicePrefix] of Object.entries(serviceMapping)) {
                const serviceStatus = servicesStatus[gatewayServiceName];
                
                // Special handling for gateway - its button state should match its card status
                // Gateway buttons should be disabled when system is degraded (not just when gateway service is down)
                let isOnline;
                if (servicePrefix === 'gateway') {
                    // For gateway, use overall system health instead of individual service status
                    // If any critical service is down (especially database), gateway should be considered offline for button purposes
                    isOnline = dataServiceHealthy && serviceStatus === 'healthy';
                    console.log(`🚪 Gateway button status: ${isOnline ? 'Online' : 'Offline'} (DB: ${dataServiceHealthy}, Gateway: ${serviceStatus})`);
                } else {
                    // For all other services, use individual service status
                    isOnline = serviceStatus === 'healthy';
                }
                
                updateServiceButtons(servicePrefix, isOnline, dataServiceHealthy);
            }
        }

        // Set environment for service management (can be called from UI)
        function setServiceEnvironment(environment) {
            if (ENVIRONMENT_CONFIG.environments[environment]) {
                ENVIRONMENT_CONFIG.current = environment;
                console.log(`🔧 Environment set to: ${environment}`);
                Alert.info('Environment Changed', `Service management environment set to: ${environment}`);
            } else {
                console.error(`❌ Invalid environment: ${environment}`);
                Alert.error('Invalid Environment', `Environment '${environment}' is not supported`);
            }
        }

        // Expose environment management globally
        window.setServiceEnvironment = setServiceEnvironment;
        window.manageService = manageService;

        // ===========================================
        // SUPPLIERS PAGE FUNCTIONALITY
        // ===========================================

        // Initialize suppliers content
        async function initSuppliersContent() {
            await loadSuppliersData();
        }

        async function loadSuppliersData() {
            
            try {
                // Use CONFIG object instead of undefined getServiceUrls function
                const response = await authenticatedGet(`${CONFIG.GATEWAY_URL}/api/v1/inventory/suppliers?limit=1000`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const suppliers = data.data || [];
                
                displaySuppliers(suppliers);
                
            } catch (error) {
                console.error('❌ Error loading suppliers:', error);
                displaySuppliersError('Failed to load suppliers. Please check your connection and try again.');
            }
        }

        function displaySuppliers(suppliers) {
            const container = document.getElementById('suppliersTableContainer');
            
            if (!suppliers || suppliers.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-truck empty-state-icon"></i>
                        <h5>No Suppliers Found</h5>
                        <p class="text-muted">No suppliers have been added yet.</p>
                        <button class="btn btn-primary" onclick="openAddSupplierModal()">
                            <i class="fas fa-plus me-2"></i>Add First Supplier
                        </button>
                    </div>
                `;
                return;
            }

            const tableHtml = `
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th>Contact Person</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${suppliers.map(supplier => `
                                <tr>
                                    <td>
                                        <strong>${supplier.supplier_name || 'N/A'}</strong>
                                        ${supplier.address ? `<br><small class="text-muted">${supplier.address}</small>` : ''}
                                    </td>
                                    <td>${supplier.contact_person || 'N/A'}</td>
                                    <td>
                                        ${supplier.email ? `<a href="mailto:${supplier.email}">${supplier.email}</a>` : 'N/A'}
                                    </td>
                                    <td>
                                        ${supplier.contact_number ? `<a href="tel:${supplier.contact_number}">${supplier.contact_number}</a>` : 'N/A'}
                                    </td>
                                    <td>
                                        <span class="badge bg-success">Active</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewSupplier('${supplier.id}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary ms-1" onclick="editSupplier('${supplier.id}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = tableHtml;
        }

        function displaySuppliersError(message) {
            const container = document.getElementById('suppliersTableContainer');
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle error-state-icon"></i>
                    <h5>Unable to Load Suppliers</h5>
                    <p class="text-muted">${message}</p>
                    <button class="btn btn-primary" onclick="loadSuppliersData()">
                        <i class="fas fa-refresh me-2"></i>Retry
                    </button>
                </div>
            `;
        }

        // Modal and form functions
        window.openAddSupplierModal = function() {
            resetSupplierForm();
            const modalElement = document.getElementById('addSupplierModal');
            if (modalElement) {
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            } else {
                // Dynamically inject the supplier modal HTML
                injectSupplierModal();
                // Wait a bit for DOM update, then open modal
                setTimeout(() => {
                    resetSupplierForm();
                    const modal = new bootstrap.Modal(document.getElementById('addSupplierModal'));
                    modal.show();
                }, 100);
            }
        };
        
        function resetSupplierForm() {
            const form = document.getElementById('addSupplierForm');
            if (form) {
                form.reset();
                form.classList.remove('was-validated');
                
                // Remove validation classes with null checks
                const supplierName = document.getElementById('supplierName');
                const contactNumber = document.getElementById('contactNumber');
                const supplierEmail = document.getElementById('supplierEmail');
                const supplierAddress = document.getElementById('supplierAddress');
                
                if (supplierName) supplierName.classList.remove('is-invalid', 'is-valid');
                if (contactNumber) contactNumber.classList.remove('is-invalid', 'is-valid');
                if (supplierEmail) supplierEmail.classList.remove('is-invalid', 'is-valid');
                if (supplierAddress) supplierAddress.classList.remove('is-invalid', 'is-valid');
                
                // Reset button if it exists
                const saveBtn = document.getElementById('saveSupplierBtn');
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Supplier';
                }
            }
        }

        async function saveSupplier() {
            const form = document.getElementById('addSupplierForm');
            const saveBtn = document.getElementById('saveSupplierBtn');
            
            // Reset validation state
            form.classList.remove('was-validated');
            form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            
            // Collect form data
            const formData = new FormData(form);
            const supplierData = {};
            
            // Process form fields
            for (let [key, value] of formData.entries()) {
                const trimmedValue = value.trim();
                if (trimmedValue) {
                    supplierData[key] = trimmedValue;
                }
            }
            
            // Validate required fields
            let isValid = true;
            
            if (!supplierData.supplier_name || supplierData.supplier_name.length < 1 || supplierData.supplier_name.length > 255) {
                document.getElementById('supplierName').classList.add('is-invalid');
                isValid = false;
            }
            
            if (supplierData.contact_number && supplierData.contact_number.length > 50) {
                document.getElementById('contactNumber').classList.add('is-invalid');
                isValid = false;
            }
            
            if (supplierData.email && (supplierData.email.length > 255 || !isValidEmail(supplierData.email))) {
                document.getElementById('supplierEmail').classList.add('is-invalid');
                isValid = false;
            }
            
            if (!isValid) {
                form.classList.add('was-validated');
                return;
            }
            
            // Update button state
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
            
            try {
                // Use CONFIG object instead of undefined getServiceUrls function
                const response = await authenticatedPost(`${CONFIG.GATEWAY_URL}/api/v1/inventory/suppliers`, supplierData);
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Success
                    Alert.success('Supplier created successfully!');
                    
                    // Hide modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addSupplierModal'));
                    modal.hide();
                    
                    // Reload suppliers if on suppliers page
                    if (document.getElementById('suppliersTableContainer')) {
                        await loadSuppliersData();
                    }
                    
                    // If called from ingredient modal, refresh dropdowns
                    if (currentIngredientModal) {
                        // Refresh supplier data for ingredient dropdowns
                        await loadDropdownData();
                        
                        // Repopulate the supplier dropdown in the ingredient form
                        const supplierSelect = currentIngredientModal === 'add' 
                            ? document.getElementById('ingredientSupplier')
                            : document.getElementById('editIngredientSupplier');
                        
                        if (supplierSelect) {
                            supplierSelect.innerHTML = '<option value="">Select a supplier</option>';
                            availableSuppliers.forEach(supplier => {
                                supplierSelect.innerHTML += `<option value="${supplier.id}">${supplier.supplier_name}</option>`;
                            });
                            
                            // Auto-select the newly created supplier
                            if (result.data && result.data.id) {
                                supplierSelect.value = result.data.id;
                            }
                        }
                        
                        currentIngredientModal = null;
                    }
                } else {
                    throw new Error(result.message || 'Failed to create supplier');
                }
                
            } catch (error) {
                console.error('❌ Error saving supplier:', error);
                Alert.error('Failed to save supplier. Please check your connection and try again.');
            }
            
            // Reset button state
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Supplier';
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function viewSupplier(supplierId) {
            console.log('👁️ Viewing supplier:', supplierId);
            loadSupplierForView(supplierId);
        }

        function editSupplier(supplierId) {
            console.log('✏️ Editing supplier:', supplierId);
            loadSupplierForEdit(supplierId);
        }

        async function loadSupplierForView(supplierId) {
            try {
                const response = await authenticatedGet(`${CONFIG.GATEWAY_URL}/api/v1/inventory/suppliers/${supplierId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                const supplier = result.data;
                
                // Populate view modal
                document.getElementById('viewSupplierName').textContent = supplier.supplier_name || '-';
                document.getElementById('viewContactNumber').textContent = supplier.contact_number || '-';
                document.getElementById('viewSupplierEmail').textContent = supplier.email || '-';
                document.getElementById('viewSupplierAddress').textContent = supplier.address || '-';
                document.getElementById('viewSupplierNotes').textContent = supplier.notes || '-';
                
                // Format dates
                const createdDate = supplier.created_at ? new Date(supplier.created_at).toLocaleDateString() : '-';
                const updatedDate = supplier.updated_at ? new Date(supplier.updated_at).toLocaleDateString() : '-';
                document.getElementById('viewCreatedDate').textContent = createdDate;
                document.getElementById('viewUpdatedDate').textContent = updatedDate;
                
                // Store supplier ID for edit button
                window.currentViewSupplierId = supplierId;
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('viewSupplierModal'));
                modal.show();
                
            } catch (error) {
                console.error('❌ Error loading supplier for view:', error);
                Alert.error('Failed to load supplier details. Please try again.');
            }
        }

        async function loadSupplierForEdit(supplierId) {
            try {
                const response = await authenticatedGet(`${CONFIG.GATEWAY_URL}/api/v1/inventory/suppliers/${supplierId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                const supplier = result.data;
                
                // Reset form
                resetEditSupplierForm();
                
                // Populate edit form
                document.getElementById('editSupplierId').value = supplier.id;
                document.getElementById('editSupplierName').value = supplier.supplier_name || '';
                document.getElementById('editContactNumber').value = supplier.contact_number || '';
                document.getElementById('editSupplierEmail').value = supplier.email || '';
                document.getElementById('editSupplierAddress').value = supplier.address || '';
                document.getElementById('editSupplierNotes').value = supplier.notes || '';
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('editSupplierModal'));
                modal.show();
                
            } catch (error) {
                console.error('❌ Error loading supplier for edit:', error);
                Alert.error('Failed to load supplier for editing. Please try again.');
            }
        }

        window.openEditSupplierModal = function() {
            // Called from view modal's edit button
            if (window.currentViewSupplierId) {
                loadSupplierForEdit(window.currentViewSupplierId);
            }
        };

        function resetEditSupplierForm() {
            const form = document.getElementById('editSupplierForm');
            form.reset();
            form.classList.remove('was-validated');
            
            // Remove validation classes
            form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            form.querySelectorAll('.is-valid').forEach(el => el.classList.remove('is-valid'));
            
            // Reset button
            const updateBtn = document.getElementById('updateSupplierBtn');
            updateBtn.disabled = false;
            updateBtn.innerHTML = '<i class="fas fa-save me-2"></i>Update Supplier';
        }

        async function updateSupplier() {
            const form = document.getElementById('editSupplierForm');
            const updateBtn = document.getElementById('updateSupplierBtn');
            const supplierId = document.getElementById('editSupplierId').value;
            
            // Reset validation state
            form.classList.remove('was-validated');
            form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            
            // Collect form data
            const formData = new FormData(form);
            const supplierData = {};
            
            // Process form fields
            for (let [key, value] of formData.entries()) {
                if (key !== 'id') { // Skip hidden ID field
                    const trimmedValue = value.trim();
                    if (trimmedValue) {
                        supplierData[key] = trimmedValue;
                    }
                }
            }
            
            // Validate required fields
            let isValid = true;
            
            if (!supplierData.supplier_name || supplierData.supplier_name.length < 1 || supplierData.supplier_name.length > 255) {
                document.getElementById('editSupplierName').classList.add('is-invalid');
                isValid = false;
            }
            
            if (supplierData.contact_number && supplierData.contact_number.length > 50) {
                document.getElementById('editContactNumber').classList.add('is-invalid');
                isValid = false;
            }
            
            if (supplierData.email && (supplierData.email.length > 255 || !isValidEmail(supplierData.email))) {
                document.getElementById('editSupplierEmail').classList.add('is-invalid');
                isValid = false;
            }
            
            if (!isValid) {
                form.classList.add('was-validated');
                return;
            }
            
            // Update button state
            updateBtn.disabled = true;
            updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
            
            try {
                const response = await authenticatedPut(`${CONFIG.GATEWAY_URL}/api/v1/inventory/suppliers/${supplierId}`, supplierData);
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Success
                    Alert.success('Supplier updated successfully!');
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editSupplierModal'));
                    modal.hide();
                    
                    // Reload suppliers list
                    await loadSuppliersData();
                    
                } else {
                    // API returned error
                    const errorMessage = result.message || result.error || 'Failed to update supplier';
                    Alert.error('Error: ' + errorMessage);
                }
                
            } catch (error) {
                console.error('❌ Error updating supplier:', error);
                Alert.error('Failed to update supplier. Please check your connection and try again.');
            }
            
            // Reset button state
            updateBtn.disabled = false;
            updateBtn.innerHTML = '<i class="fas fa-save me-2"></i>Update Supplier';
        }

        async function deleteSupplier() {
            const supplierId = document.getElementById('editSupplierId').value;
            const supplierName = document.getElementById('editSupplierName').value;
            
            // Confirm deletion
            const result = await Swal.fire({
                title: 'Delete Supplier?',
                text: `Are you sure you want to delete "${supplierName}"? This action cannot be undone.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel'
            });
            
            if (!result.isConfirmed) {
                return;
            }
            
            try {
                const response = await authenticatedDelete(`${CONFIG.GATEWAY_URL}/api/v1/inventory/suppliers/${supplierId}`);
                
                const deleteResult = await response.json();
                
                if (response.ok && deleteResult.success) {
                    // Success
                    Alert.success('Supplier deleted successfully!');
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editSupplierModal'));
                    modal.hide();
                    
                    // Reload suppliers list
                    await loadSuppliersData();
                    
                } else {
                    // API returned error
                    const errorMessage = deleteResult.message || deleteResult.error || 'Failed to delete supplier';
                    Alert.error('Error: ' + errorMessage);
                }
                
            } catch (error) {
                console.error('❌ Error deleting supplier:', error);
                Alert.error('Failed to delete supplier. Please check your connection and try again.');
            }
        }

        // Expose additional functions globally for onclick handlers
        window.viewSupplier = viewSupplier;
        window.editSupplier = editSupplier;
        window.saveSupplier = saveSupplier;
        window.updateSupplier = updateSupplier;
        window.deleteSupplier = deleteSupplier;
        window.loadSuppliersData = loadSuppliersData;
        window.initSuppliersContent = initSuppliersContent;

        console.log('✅ Suppliers functionality initialized and exposed globally');

        // ===== CATEGORIES FUNCTIONALITY =====
        let categories = [];
        let currentCategory = null;

        // Initialize categories content
        async function initCategoriesContent() {
            console.log('🏷️ Initializing Categories content...');
            await loadCategoriesData();
        }

        // Load categories data
        async function loadCategoriesData() {
            try {
                console.log('📥 Loading categories...');
                showCategoriesLoading();

                const response = await authenticatedGet(`${CONFIG.GATEWAY_URL}/api/v1/inventory/ingredient-categories`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success && result.data) {
                    categories = result.data;
                    console.log(`✅ Loaded ${categories.length} categories`);
                    displayCategories();
                } else {
                    throw new Error(result.message || 'Failed to load categories');
                }
            } catch (error) {
                console.error('❌ Error loading categories:', error);
                displayCategoriesError('Failed to load categories. Please check your connection and try again.');
            }
        }

        // Show categories loading state
        function showCategoriesLoading() {
            const container = document.getElementById('categoriesTableContainer');
            if (container) {
                container.innerHTML = `
                    <div class="loading-table text-center py-5">
                        <div class="loading-spinner"></div>
                        <p>Loading categories...</p>
                    </div>
                `;
            }
        }

        // Display categories error state
        function displayCategoriesError(message) {
            const container = document.getElementById('categoriesTableContainer');
            if (container) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="error-state-icon fas fa-exclamation-triangle"></i>
                        <h4>Error Loading Categories</h4>
                        <p class="text-muted">${message}</p>
                        <button class="btn btn-primary" onclick="loadCategoriesData()">
                            <i class="fas fa-sync-alt me-2"></i>Try Again
                        </button>
                    </div>
                `;
            }
        }

        // Display categories
        function displayCategories() {
            const container = document.getElementById('categoriesTableContainer');
            if (!container) return;

            if (!categories || categories.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="empty-state-icon fas fa-tags"></i>
                        <h4>No Categories Found</h4>
                        <p class="text-muted">Start by adding your first ingredient category.</p>
                        <button class="btn btn-primary" onclick="openAddCategoryModal()">
                            <i class="fas fa-plus me-2"></i>Add First Category
                        </button>
                    </div>
                `;
                return;
            }

            const categoriesHTML = `
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${categories.map(category => createCategoryRow(category)).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = categoriesHTML;
        }

        // Create category table row
        function createCategoryRow(category) {
            const statusBadgeClass = category.is_active ? 'status-active' : 'status-inactive';
            const statusText = category.is_active ? 'Active' : 'Inactive';
            const createdDate = new Date(category.created_at).toLocaleDateString();
            const truncatedDescription = category.description.length > 50 
                ? category.description.substring(0, 50) + '...' 
                : category.description;
            
            return `
                <tr>
                    <td class="fw-bold">${category.name}</td>
                    <td class="text-muted">${truncatedDescription}</td>
                    <td>
                        <span class="status-badge ${statusBadgeClass}">${statusText}</span>
                    </td>
                    <td class="text-muted">${createdDate}</td>
                    <td class="text-end">
                        <button class="btn btn-outline-info btn-sm me-1" onclick="viewCategory('${category.id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-warning btn-sm me-1" onclick="editCategory('${category.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteCategory('${category.id}', '${category.name.replace(/'/g, "\\'")}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }

        // Open add category modal
        window.openAddCategoryModal = function() {
            resetAddCategoryForm();
            const modal = new bootstrap.Modal(document.getElementById('addCategoryModal'));
            modal.show();
        };

        // Reset add category form
        function resetAddCategoryForm() {
            const form = document.getElementById('addCategoryForm');
            if (form) {
                form.reset();
                document.getElementById('categoryName').classList.remove('is-invalid');
                document.getElementById('categoryDescription').classList.remove('is-invalid');
            }
        }

        // Save new category
        window.saveCategory = async function() {
            if (!validateAddCategoryForm()) {
                return;
            }

            const categoryData = {
                name: document.getElementById('categoryName').value.trim(),
                description: document.getElementById('categoryDescription').value.trim(),
                is_active: document.getElementById('categoryActive').value === 'true'
            };

            try {
                const response = await authenticatedPost(`${CONFIG.GATEWAY_URL}/api/v1/inventory/ingredient-categories`, categoryData);

                const result = await response.json();

                if (response.ok && result.success) {
                    Alert.success('Category created successfully!');
                    
                    // Hide modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addCategoryModal'));
                    modal.hide();
                    
                    // Reload categories
                    await loadCategoriesData();
                } else {
                    throw new Error(result.message || 'Failed to create category');
                }
            } catch (error) {
                console.error('❌ Error saving category:', error);
                Alert.error('Error: ' + error.message);
            }
        };

        // Validate add category form
        function validateAddCategoryForm() {
            let isValid = true;

            const nameField = document.getElementById('categoryName');
            const descriptionField = document.getElementById('categoryDescription');

            if (!nameField.value.trim()) {
                nameField.classList.add('is-invalid');
                isValid = false;
            } else {
                nameField.classList.remove('is-invalid');
            }

            if (!descriptionField.value.trim()) {
                descriptionField.classList.add('is-invalid');
                isValid = false;
            } else {
                descriptionField.classList.remove('is-invalid');
            }

            return isValid;
        }

        // View category details
        window.viewCategory = async function(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            if (!category) {
                Alert.error('Category not found');
                return;
            }

            const statusText = category.is_active ? 'Active' : 'Inactive';
            const statusClass = category.is_active ? 'text-success' : 'text-secondary';

            const content = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="fw-bold">Category Information</h6>
                        <table class="table table-borderless">
                            <tr>
                                <td class="fw-bold">Name:</td>
                                <td>${category.name}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Status:</td>
                                <td><span class="${statusClass}">${statusText}</span></td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Created:</td>
                                <td>${new Date(category.created_at).toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Last Updated:</td>
                                <td>${new Date(category.updated_at).toLocaleString()}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold">Description</h6>
                        <p class="text-muted">${category.description}</p>
                    </div>
                </div>
            `;

            document.getElementById('viewCategoryContent').innerHTML = content;
            currentCategory = category;

            const modal = new bootstrap.Modal(document.getElementById('viewCategoryModal'));
            modal.show();
        };

        // Edit category
        window.editCategory = function(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            if (!category) {
                Alert.error('Category not found');
                return;
            }

            currentCategory = category;

            // Populate edit form
            document.getElementById('editCategoryName').value = category.name;
            document.getElementById('editCategoryDescription').value = category.description;
            document.getElementById('editCategoryActive').value = category.is_active.toString();

            // Show edit modal
            const modal = new bootstrap.Modal(document.getElementById('editCategoryModal'));
            modal.show();
        };

        // Edit category from view modal
        window.editCategoryFromView = function() {
            if (currentCategory) {
                // Hide view modal
                const viewModal = bootstrap.Modal.getInstance(document.getElementById('viewCategoryModal'));
                viewModal.hide();
                
                // Show edit modal after view modal is hidden
                setTimeout(() => {
                    editCategory(currentCategory.id);
                }, 300);
            }
        };

        // Update category
        window.updateCategory = async function() {
            if (!validateEditCategoryForm()) {
                return;
            }

            const categoryData = {
                name: document.getElementById('editCategoryName').value.trim(),
                description: document.getElementById('editCategoryDescription').value.trim(),
                is_active: document.getElementById('editCategoryActive').value === 'true'
            };

            try {
                const response = await authenticatedPut(`${CONFIG.GATEWAY_URL}/api/v1/inventory/ingredient-categories/${currentCategory.id}`, categoryData);

                const result = await response.json();

                if (response.ok && result.success) {
                    Alert.success('Category updated successfully!');
                    
                    // Hide modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editCategoryModal'));
                    modal.hide();
                    
                    // Reload categories
                    await loadCategoriesData();
                } else {
                    throw new Error(result.message || 'Failed to update category');
                }
            } catch (error) {
                console.error('❌ Error updating category:', error);
                Alert.error('Error: ' + error.message);
            }
        };

        // Validate edit category form
        function validateEditCategoryForm() {
            let isValid = true;

            const nameField = document.getElementById('editCategoryName');
            const descriptionField = document.getElementById('editCategoryDescription');

            if (!nameField.value.trim()) {
                nameField.classList.add('is-invalid');
                isValid = false;
            } else {
                nameField.classList.remove('is-invalid');
            }

            if (!descriptionField.value.trim()) {
                descriptionField.classList.add('is-invalid');
                isValid = false;
            } else {
                descriptionField.classList.remove('is-invalid');
            }

            return isValid;
        }

        // Delete category
        window.deleteCategory = async function(categoryId, categoryName) {
            const result = await Swal.fire({
                title: 'Delete Category',
                text: `Are you sure you want to delete "${categoryName}"? This action cannot be undone.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel'
            });

            if (result.isConfirmed) {
                try {
                    const response = await authenticatedDelete(`${CONFIG.GATEWAY_URL}/api/v1/inventory/ingredient-categories/${categoryId}`);

                    const deleteResult = await response.json();

                    if (response.ok && deleteResult.success) {
                        Alert.success('Category deleted successfully!');
                        await loadCategoriesData();
                    } else {
                        throw new Error(deleteResult.message || 'Failed to delete category');
                    }
                } catch (error) {
                    console.error('❌ Error deleting category:', error);
                    Alert.error('Error: ' + error.message);
                }
            }
        };

        // Expose categories functions globally
        window.loadCategoriesData = loadCategoriesData;

        console.log('✅ Categories functionality initialized and exposed globally');

        // ===== EXPENSE CATEGORIES FUNCTIONALITY =====
        let expenseCategories = [];
        let currentExpenseCategory = null;

        // Initialize expense categories content
        async function initExpenseCategoriesContent() {
            console.log('🏷️ Initializing Expense Categories content...');
            await loadExpenseCategoriesData();
        }

        // Load expense categories data
        async function loadExpenseCategoriesData() {
            try {
                console.log('📥 Loading expense categories...');
                showExpenseCategoriesLoading();

                const response = await authenticatedGet(`${CONFIG.GATEWAY_URL}/api/v1/invoices/expense-categories`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success && result.data) {
                    expenseCategories = result.data;
                    console.log(`✅ Loaded ${expenseCategories.length} expense categories`);
                    displayExpenseCategories();
                } else {
                    throw new Error(result.message || 'Failed to load expense categories');
                }
            } catch (error) {
                console.error('❌ Error loading expense categories:', error);
                displayExpenseCategoriesError('Failed to load expense categories. Please check your connection and try again.');
            }
        }

        // Show expense categories loading state
        function showExpenseCategoriesLoading() {
            const container = document.getElementById('expenseCategoriesTableContainer');
            if (container) {
                container.innerHTML = `
                    <div class="loading-table text-center py-5">
                        <div class="loading-spinner"></div>
                        <p>Loading expense categories...</p>
                    </div>
                `;
            }
        }

        // Display expense categories error state
        function displayExpenseCategoriesError(message) {
            const container = document.getElementById('expenseCategoriesTableContainer');
            if (container) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="error-state-icon fas fa-exclamation-triangle"></i>
                        <h4>Error Loading Expense Categories</h4>
                        <p class="text-muted">${message}</p>
                        <button class="btn btn-primary" onclick="loadExpenseCategoriesData()">
                            <i class="fas fa-sync-alt me-2"></i>Try Again
                        </button>
                    </div>
                `;
            }
        }

        // Display expense categories
        function displayExpenseCategories() {
            const container = document.getElementById('expenseCategoriesTableContainer');
            if (!container) return;

            if (!expenseCategories || expenseCategories.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="empty-state-icon fas fa-tags"></i>
                        <h4>No Expense Categories Found</h4>
                        <p class="text-muted">Start by adding your first expense category.</p>
                        <button class="btn btn-primary" onclick="openAddExpenseCategoryModal()">
                            <i class="fas fa-plus me-2"></i>Add First Category
                        </button>
                    </div>
                `;
                return;
            }

            const categoriesHTML = `
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${expenseCategories.map(category => createExpenseCategoryRow(category)).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = categoriesHTML;
        }

        // Create expense category row HTML
        function createExpenseCategoryRow(category) {
            const statusBadge = category.is_active 
                ? '<span class="status-badge status-active">Active</span>'
                : '<span class="status-badge status-inactive">Inactive</span>';

            const createdDate = new Date(category.created_at).toLocaleDateString();

            return `
                <tr>
                    <td class="fw-bold">${category.category_name}</td>
                    <td class="text-muted">${category.description || 'No description'}</td>
                    <td>${statusBadge}</td>
                    <td class="text-muted">${createdDate}</td>
                    <td class="text-end">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="viewExpenseCategory('${category.id}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="editExpenseCategory('${category.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteExpenseCategory('${category.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        // Expose expense categories functions globally
        window.loadExpenseCategoriesData = loadExpenseCategoriesData;
        window.initExpenseCategoriesContent = initExpenseCategoriesContent;

        console.log('✅ Expense Categories functionality initialized and exposed globally');

        // ===== INGREDIENTS FUNCTIONALITY =====
        let ingredients = [];
        let currentIngredient = null;
        let availableCategories = [];
        let availableSuppliers = [];

        // Initialize ingredients content
        async function initIngredientsContent() {
            console.log('🌱 Initializing Ingredients content...');
            await loadIngredientsData();
        }

        // Load ingredients data
        async function loadIngredientsData() {
            try {
                console.log('📥 Loading ingredients...');
                showIngredientsLoading();

                const response = await authenticatedGet(`${CONFIG.GATEWAY_URL}/api/v1/inventory/ingredients`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success && result.data) {
                    ingredients = result.data;
                    console.log(`✅ Loaded ${ingredients.length} ingredients`);
                    displayIngredients();
                } else {
                    throw new Error(result.message || 'Failed to load ingredients');
                }
            } catch (error) {
                console.error('❌ Error loading ingredients:', error);
                displayIngredientsError('Failed to load ingredients. Please check your connection and try again.');
            }
        }

        // Show ingredients loading state
        function showIngredientsLoading() {
            const container = document.getElementById('ingredientsTableContainer');
            if (container) {
                container.innerHTML = `
                    <div class="loading-table text-center py-5">
                        <div class="loading-spinner"></div>
                        <p>Loading ingredients...</p>
                    </div>
                `;
            }
        }

        // Display ingredients error state
        function displayIngredientsError(message) {
            const container = document.getElementById('ingredientsTableContainer');
            if (container) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="error-state-icon fas fa-exclamation-triangle"></i>
                        <h4>Error Loading Ingredients</h4>
                        <p class="text-muted">${message}</p>
                        <button class="btn btn-primary" onclick="loadIngredientsData()">
                            <i class="fas fa-sync-alt me-2"></i>Try Again
                        </button>
                    </div>
                `;
            }
        }

        // Display ingredients
        function displayIngredients() {
            const container = document.getElementById('ingredientsTableContainer');
            if (!container) return;

            if (!ingredients || ingredients.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="empty-state-icon fas fa-seedling"></i>
                        <h4>No Ingredients Found</h4>
                        <p class="text-muted">Start by adding your first ingredient.</p>
                        <button class="btn btn-primary" onclick="openAddIngredientModal()">
                            <i class="fas fa-plus me-2"></i>Add First Ingredient
                        </button>
                    </div>
                `;
                return;
            }

            const ingredientsHTML = `
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th>Supplier</th>
                                <th>Created</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ingredients.map(ingredient => createIngredientRow(ingredient)).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = ingredientsHTML;
        }

        // Create ingredient table row
        function createIngredientRow(ingredient) {
            const category = availableCategories.find(c => c.id === ingredient.ingredient_category_id);
            const supplier = availableSuppliers.find(s => s.id === ingredient.supplier_id);
            
            return `
                <tr>
                    <td><strong>${ingredient.ingredient_name}</strong></td>
                    <td>${ingredient.description || '-'}</td>
                    <td>
                        ${category ? `<span class="badge bg-info">${category.name}</span>` : '-'}
                    </td>
                    <td>
                        ${supplier ? `<span class="supplier-badge">${supplier.supplier_name}</span>` : '-'}
                    </td>
                    <td>${new Date(ingredient.created_at).toLocaleDateString()}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewIngredient('${ingredient.id}')" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="editIngredient('${ingredient.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteIngredient('${ingredient.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        // Load categories and suppliers for dropdowns
        async function loadDropdownData() {
            try {
                // Load categories
                const categoriesResponse = await authenticatedGet(`${CONFIG.GATEWAY_URL}/api/v1/inventory/ingredient-categories`);
                if (categoriesResponse.ok) {
                    const categoriesResult = await categoriesResponse.json();
                    if (categoriesResult.success && categoriesResult.data) {
                        availableCategories = categoriesResult.data.filter(c => c.is_active);
                    }
                }

                // Load suppliers
                const suppliersResponse = await authenticatedGet(`${CONFIG.GATEWAY_URL}/api/v1/inventory/suppliers`);
                if (suppliersResponse.ok) {
                    const suppliersResult = await suppliersResponse.json();
                    if (suppliersResult.success && suppliersResult.data) {
                        availableSuppliers = suppliersResult.data;
                    }
                }
            } catch (error) {
                console.error('❌ Error loading dropdown data:', error);
            }
        }

        // Populate dropdowns
        function populateDropdowns(categorySelectId, supplierSelectId) {
            // Skip dropdown population since we use the picker modals now
            // This function is kept for compatibility but no longer populates dropdowns
        }

        console.log('✅ Ingredients functionality initialized and exposed globally');

        // Inject supplier modal HTML dynamically
        function injectSupplierModal() {
            // Check if modal already exists
            if (document.getElementById('addSupplierModal')) {
                return;
            }

            // Inject CSS if not already present
            if (!document.getElementById('supplier-modal-styles')) {
                const style = document.createElement('style');
                style.id = 'supplier-modal-styles';
                style.textContent = `
                    /* Supplier Modal Styles */
                    .supplier-modal-content {
                        border: none;
                        border-radius: var(--border-radius-lg);
                        box-shadow: var(--shadow-heavy);
                    }
                    
                    .supplier-modal-header {
                        background: var(--gradient-primary);
                        color: var(--white);
                        border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
                        border-bottom: none;
                    }
                    
                    .btn-save-supplier {
                        background: var(--gradient-primary);
                        border: none;
                        border-radius: var(--border-radius);
                        padding: 0.75rem 2rem;
                        font-weight: 600;
                        color: var(--white);
                        transition: var(--transition);
                    }
                    
                    .btn-save-supplier:hover {
                        transform: translateY(-2px);
                        box-shadow: var(--shadow-medium);
                        color: var(--white);
                    }
                    
                    .btn-save-supplier:disabled {
                        opacity: 0.7;
                        transform: none;
                    }
                `;
                document.head.appendChild(style);
            }

            // Create modal HTML
            const modalHTML = `
                <div class="modal fade" id="addSupplierModal" tabindex="-1" aria-labelledby="addSupplierModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content supplier-modal-content">
                            <div class="modal-header supplier-modal-header">
                                <h5 class="modal-title" id="addSupplierModalLabel">
                                    <i class="fas fa-plus me-2"></i>Add New Supplier
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: brightness(0) invert(1);"></button>
                            </div>
                            <div class="modal-body">
                                <form id="addSupplierForm" novalidate>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="supplierName" class="form-label">
                                                Supplier Name <span class="text-danger">*</span>
                                            </label>
                                            <input type="text" class="form-control" id="supplierName" name="supplier_name" 
                                                   maxlength="255" required>
                                            <div class="invalid-feedback">
                                                Please provide a valid supplier name (1-255 characters).
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="contactNumber" class="form-label">Contact Number</label>
                                            <input type="tel" class="form-control" id="contactNumber" name="contact_number" 
                                                   maxlength="50" placeholder="+1 (555) 123-4567">
                                            <div class="invalid-feedback">
                                                Please provide a valid contact number (max 50 characters).
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="supplierEmail" class="form-label">Email Address</label>
                                            <input type="email" class="form-control" id="supplierEmail" name="email" 
                                                   maxlength="255" placeholder="supplier@example.com">
                                            <div class="invalid-feedback">
                                                Please provide a valid email address.
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="supplierAddress" class="form-label">Address</label>
                                            <input type="text" class="form-control" id="supplierAddress" name="address" 
                                                   placeholder="123 Main St, City, State, ZIP">
                                            <div class="invalid-feedback">
                                                Please provide a valid address.
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="supplierNotes" class="form-label">Notes</label>
                                        <textarea class="form-control" id="supplierNotes" name="notes" rows="3" 
                                                  placeholder="Additional notes about this supplier..."></textarea>
                                        <div class="invalid-feedback">
                                            Please provide valid notes.
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-save-supplier" id="saveSupplierBtn" onclick="saveSupplier()">
                                    <i class="fas fa-save me-2"></i>Save Supplier
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Inject modal into body
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Set up cleanup when modal is hidden
            const modal = document.getElementById('addSupplierModal');
            modal.addEventListener('hidden.bs.modal', function() {
                // Remove modal from DOM after it's hidden, unless we're on suppliers page
                if (!document.getElementById('suppliersTableContainer')) {
                    setTimeout(() => {
                        modal.remove();
                    }, 100);
                }
            });
        }

        // =================================================================================
        // EXISTENCES CRUD FUNCTIONS
        // =================================================================================

        // Global variables for existences
        let availableIngredients = [];
        let currentExistenceModal = null;

        // Initialize existences content
        async function initExistencesContent() {
            await loadExistencesData();
            await loadFilterIngredients();
        }

        // Load all existences data
        async function loadExistencesData(filters = {}) {
            try {
                showExistencesLoading();
                
                // Build query parameters
                const params = new URLSearchParams();
                if (filters.ingredient_id) params.append('ingredient_id', filters.ingredient_id);
                if (filters.unit_type) params.append('unit_type', filters.unit_type);
                if (filters.status) {
                    switch (filters.status) {
                        case 'expired':
                            params.append('expired', 'true');
                            break;
                        case 'low':
                            params.append('low_stock', 'true');
                            break;
                        // Add other status filters as needed
                    }
                }

                const queryString = params.toString();
                const url = `${CONFIG.GATEWAY_URL}/api/v1/inventory/existences${queryString ? '?' + queryString : ''}`;
                
                const response = await authenticatedGet(url);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch existences: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('📦 Existences loaded:', result);
                
                if (result.success && Array.isArray(result.data)) {
                    displayExistences(result.data);
                } else {
                    displayExistencesError('Invalid response format');
                }
                
            } catch (error) {
                console.error('❌ Error loading existences:', error);
                displayExistencesError(error.message);
            }
        }

        // Show loading state
        function showExistencesLoading() {
            const container = document.getElementById('existencesTableContainer');
            if (container) {
                container.innerHTML = `
                    <div class="d-flex justify-content-center align-items-center py-5">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin me-2"></i>
                            Loading existences...
                        </div>
                    </div>
                `;
            }
        }

        // Display error state
        function displayExistencesError(message) {
            const container = document.getElementById('existencesTableContainer');
            if (container) {
                container.innerHTML = `
                    <div class="d-flex flex-column justify-content-center align-items-center py-5">
                        <div class="error-state-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h5 class="text-danger mb-2">Error Loading Existences</h5>
                        <p class="text-muted mb-3">${message}</p>
                        <button class="btn btn-primary" onclick="loadExistencesData()">
                            <i class="fas fa-redo me-2"></i>Try Again
                        </button>
                    </div>
                `;
            }
        }

        // Display existences in table
        function displayExistences(existences) {
            const container = document.getElementById('existencesTableContainer');
            
            if (!container) {
                console.error('❌ Existences table container not found');
                return;
            }

            if (!existences || existences.length === 0) {
                container.innerHTML = `
                    <div class="d-flex flex-column justify-content-center align-items-center py-5">
                        <div class="empty-state-icon">
                            <i class="fas fa-boxes"></i>
                        </div>
                        <h5 class="text-muted mb-2">No Existences Found</h5>
                        <p class="text-muted mb-3">Existences are created automatically when invoices are processed.</p>
                    </div>
                `;
                return;
            }

            let tableHTML = `
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-primary">
                            <tr>
                                <th>Reference</th>
                                <th>Ingredient</th>
                                <th>Units Available</th>
                                <th>Unit Type</th>
                                <th>Cost/Unit</th>
                                <th>Status</th>
                                <th>Expiration</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            existences.forEach(existence => {
                const status = getExistenceStatus(existence);
                const statusBadge = getStatusBadge(status);
                const expirationDate = existence.expiration_date ? 
                    new Date(existence.expiration_date).toLocaleDateString() : 'N/A';
                
                tableHTML += createExistenceRow(existence, status, statusBadge, expirationDate);
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = tableHTML;
        }

        // Create existence table row
        function createExistenceRow(existence, status, statusBadge, expirationDate) {
            return `
                <tr>
                    <td><strong>#${existence.existence_reference_code || 'N/A'}</strong></td>
                    <td>${existence.ingredient_name || 'Unknown'}</td>
                    <td>${existence.units_available}/${existence.units_purchased}</td>
                    <td><span class="badge bg-secondary">${existence.unit_type}</span></td>
                    <td>₡${Number(existence.cost_per_unit || 0).toLocaleString()}</td>
                    <td>${statusBadge}</td>
                    <td>${expirationDate}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-action btn-view" onclick="viewExistence('${existence.id}')" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-action btn-edit" onclick="editExistence('${existence.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-action btn-delete" onclick="deleteExistence('${existence.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        // Get existence status
        function getExistenceStatus(existence) {
            const now = new Date();
            const expiration = existence.expiration_date ? new Date(existence.expiration_date) : null;
            const lowStockThreshold = existence.units_purchased * 0.1;

            if (existence.units_available <= 0) return 'out';
            if (expiration && expiration < now) return 'expired';
            if (existence.units_available <= lowStockThreshold) return 'low';
            return 'available';
        }

        // Get status badge HTML
        function getStatusBadge(status) {
            const badges = {
                'available': '<span class="status-badge status-available">Available</span>',
                'low': '<span class="status-badge status-low">Low Stock</span>',
                'expired': '<span class="status-badge status-expired">Expired</span>',
                'out': '<span class="status-badge status-out">Out of Stock</span>'
            };
            return badges[status] || badges['available'];
        }

        // Open add existence modal
        function openAddExistenceModal() {
            currentExistenceModal = 'add';
            resetAddExistenceForm();
            loadIngredientDropdown();
            const modal = new bootstrap.Modal(document.getElementById('addExistenceModal'));
            modal.show();
        }

        // Reset add existence form
        function resetAddExistenceForm() {
            const form = document.getElementById('addExistenceForm');
            if (form) {
                form.reset();
                
                // Clear ingredient selection
                document.getElementById('existenceIngredient').value = '';
                document.getElementById('existenceIngredientId').value = '';
                
                // Set default values
                document.getElementById('existenceIncomeMarginPercentage').value = '30.00';
                document.getElementById('existenceIvaPercentage').value = '13.00';
                document.getElementById('existenceServiceTaxPercentage').value = '10.00';
                
                // Remove validation classes
                form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            }
        }

        // Save existence
        async function saveExistence() {
            try {
                if (!validateAddExistenceForm()) {
                    return;
                }

                const saveBtn = document.getElementById('saveExistenceBtn');
                const originalText = saveBtn.innerHTML;
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';

                const formData = {
                    ingredient_id: document.getElementById('existenceIngredientId').value,
                    invoice_detail_id: document.getElementById('existenceInvoiceDetailId').value,
                    units_purchased: parseFloat(document.getElementById('existenceUnitsPurchased').value),
                    units_available: parseFloat(document.getElementById('existenceUnitsAvailable').value),
                    unit_type: document.getElementById('existenceUnitType').value,
                    items_per_unit: parseInt(document.getElementById('existenceItemsPerUnit').value),
                    cost_per_unit: parseFloat(document.getElementById('existenceCostPerUnit').value),
                    expiration_date: document.getElementById('existenceExpirationDate').value || null,
                    income_margin_percentage: parseFloat(document.getElementById('existenceIncomeMarginPercentage').value) || null,
                    iva_percentage: parseFloat(document.getElementById('existenceIvaPercentage').value) || null,
                    service_tax_percentage: parseFloat(document.getElementById('existenceServiceTaxPercentage').value) || null,
                    final_price: parseFloat(document.getElementById('existenceFinalPrice').value) || null
                };

                const response = await fetch(`${CONFIG.GATEWAY_URL}/api/v1/inventory/existences`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    Alert.success('Existence created successfully!');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addExistenceModal'));
                    modal.hide();
                    await loadExistencesData();
                } else {
                    Alert.error(result.message || 'Failed to create existence');
                }

            } catch (error) {
                console.error('❌ Error saving existence:', error);
                Alert.error('Failed to save existence');
            } finally {
                const saveBtn = document.getElementById('saveExistenceBtn');
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Existence';
            }
        }

        // Validate add existence form
        function validateAddExistenceForm() {
            const form = document.getElementById('addExistenceForm');
            const requiredFields = [
                'existenceIngredientId',
                'existenceInvoiceDetailId', 
                'existenceUnitsPurchased',
                'existenceUnitsAvailable',
                'existenceUnitType',
                'existenceItemsPerUnit',
                'existenceCostPerUnit'
            ];

            let isValid = true;

            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });

            return isValid;
        }

        // View existence
        async function viewExistence(id) {
            try {
                const response = await fetch(`${CONFIG.GATEWAY_URL}/api/v1/inventory/existences/${id}`);
                const result = await response.json();

                if (response.ok && result.success) {
                    const existence = result.data;
                    populateViewExistenceModal(existence);
                    const modal = new bootstrap.Modal(document.getElementById('viewExistenceModal'));
                    modal.show();
                } else {
                    Alert.error(result.message || 'Failed to load existence details');
                }
            } catch (error) {
                console.error('❌ Error viewing existence:', error);
                Alert.error('Failed to load existence details');
            }
        }

        // Populate view existence modal
        function populateViewExistenceModal(existence) {
            document.getElementById('viewExistenceReferenceCode').textContent = existence.existence_reference_code || 'N/A';
            document.getElementById('viewExistenceIngredient').textContent = existence.ingredient_name || 'Unknown';
            document.getElementById('viewExistenceInvoiceDetailId').textContent = existence.invoice_detail_id || 'N/A';
            document.getElementById('viewExistenceExpirationDate').textContent = existence.expiration_date ? 
                new Date(existence.expiration_date).toLocaleDateString() : 'N/A';
            
            document.getElementById('viewExistenceUnitsPurchased').textContent = existence.units_purchased || '0';
            document.getElementById('viewExistenceUnitsAvailable').textContent = existence.units_available || '0';
            document.getElementById('viewExistenceUnitType').textContent = existence.unit_type || 'N/A';
            document.getElementById('viewExistenceItemsPerUnit').textContent = existence.items_per_unit || '0';
            
            document.getElementById('viewExistenceCostPerUnit').textContent = '₡' + Number(existence.cost_per_unit || 0).toLocaleString();
            document.getElementById('viewExistenceCostPerItem').textContent = '₡' + Number(existence.cost_per_item || 0).toLocaleString();
            document.getElementById('viewExistenceTotalPurchaseCost').textContent = '₡' + Number(existence.total_purchase_cost || 0).toLocaleString();
            document.getElementById('viewExistenceRemainingValue').textContent = '₡' + Number(existence.remaining_value || 0).toLocaleString();
            
            document.getElementById('viewExistenceIncomeMarginPercentage').textContent = Number(existence.income_margin_percentage || 0).toFixed(2);
            document.getElementById('viewExistenceIncomeMarginAmount').textContent = '₡' + Number(existence.income_margin_amount || 0).toLocaleString();
            document.getElementById('viewExistenceIvaPercentage').textContent = Number(existence.iva_percentage || 0).toFixed(2);
            document.getElementById('viewExistenceIvaAmount').textContent = '₡' + Number(existence.iva_amount || 0).toLocaleString();
            document.getElementById('viewExistenceServiceTaxPercentage').textContent = Number(existence.service_tax_percentage || 0).toFixed(2);
            document.getElementById('viewExistenceServiceTaxAmount').textContent = '₡' + Number(existence.service_tax_amount || 0).toLocaleString();
            document.getElementById('viewExistenceCalculatedPrice').textContent = '₡' + Number(existence.calculated_price || 0).toLocaleString();
            document.getElementById('viewExistenceFinalPrice').textContent = existence.final_price ? 
                '₡' + Number(existence.final_price).toLocaleString() : 'Auto-calculated';

            // Store ID for potential edit
            document.getElementById('viewExistenceModal').setAttribute('data-existence-id', existence.id);
        }

        // Edit existence from view modal
        function editExistenceFromView() {
            const viewModal = bootstrap.Modal.getInstance(document.getElementById('viewExistenceModal'));
            viewModal.hide();
            
            const existenceId = document.getElementById('viewExistenceModal').getAttribute('data-existence-id');
            editExistence(existenceId);
        }

        // Edit existence
        async function editExistence(id) {
            try {
                const response = await fetch(`${CONFIG.GATEWAY_URL}/api/v1/inventory/existences/${id}`);
                const result = await response.json();

                if (response.ok && result.success) {
                    const existence = result.data;
                    populateEditExistenceModal(existence);
                    currentExistenceModal = 'edit';
                    const modal = new bootstrap.Modal(document.getElementById('editExistenceModal'));
                    modal.show();
                } else {
                    Alert.error(result.message || 'Failed to load existence for editing');
                }
            } catch (error) {
                console.error('❌ Error loading existence for edit:', error);
                Alert.error('Failed to load existence for editing');
            }
        }

        // Populate edit existence modal
        function populateEditExistenceModal(existence) {
            document.getElementById('editExistenceId').value = existence.id;
            document.getElementById('editExistenceReferenceCode').value = existence.existence_reference_code || '';
            document.getElementById('editExistenceIngredient').value = existence.ingredient_name || '';
            document.getElementById('editExistenceInvoiceDetailId').value = existence.invoice_detail_id || '';
            document.getElementById('editExistenceExpirationDate').value = existence.expiration_date ? 
                existence.expiration_date.split('T')[0] : '';
            
            document.getElementById('editExistenceUnitsPurchased').value = existence.units_purchased || '';
            document.getElementById('editExistenceUnitsAvailable').value = existence.units_available || '';
            document.getElementById('editExistenceUnitType').value = existence.unit_type || '';
            document.getElementById('editExistenceItemsPerUnit').value = existence.items_per_unit || '';
            document.getElementById('editExistenceCostPerUnit').value = existence.cost_per_unit || '';
            
            document.getElementById('editExistenceIncomeMarginPercentage').value = existence.income_margin_percentage || '';
            document.getElementById('editExistenceIvaPercentage').value = existence.iva_percentage || '';
            document.getElementById('editExistenceServiceTaxPercentage').value = existence.service_tax_percentage || '';
            document.getElementById('editExistenceFinalPrice').value = existence.final_price || '';
        }

        // Update existence
        async function updateExistence() {
            try {
                if (!validateEditExistenceForm()) {
                    return;
                }

                const updateBtn = document.getElementById('updateExistenceBtn');
                const originalText = updateBtn.innerHTML;
                updateBtn.disabled = true;
                updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';

                const existenceId = document.getElementById('editExistenceId').value;
                const formData = {
                    units_available: parseFloat(document.getElementById('editExistenceUnitsAvailable').value),
                    unit_type: document.getElementById('editExistenceUnitType').value,
                    items_per_unit: parseInt(document.getElementById('editExistenceItemsPerUnit').value),
                    cost_per_unit: parseFloat(document.getElementById('editExistenceCostPerUnit').value),
                    expiration_date: document.getElementById('editExistenceExpirationDate').value || null,
                    income_margin_percentage: parseFloat(document.getElementById('editExistenceIncomeMarginPercentage').value) || null,
                    iva_percentage: parseFloat(document.getElementById('editExistenceIvaPercentage').value) || null,
                    service_tax_percentage: parseFloat(document.getElementById('editExistenceServiceTaxPercentage').value) || null,
                    final_price: parseFloat(document.getElementById('editExistenceFinalPrice').value) || null
                };

                const response = await fetch(`${CONFIG.GATEWAY_URL}/api/v1/inventory/existences/${existenceId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    Alert.success('Existence updated successfully!');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editExistenceModal'));
                    modal.hide();
                    await loadExistencesData();
                } else {
                    Alert.error(result.message || 'Failed to update existence');
                }

            } catch (error) {
                console.error('❌ Error updating existence:', error);
                Alert.error('Failed to update existence');
            } finally {
                const updateBtn = document.getElementById('updateExistenceBtn');
                updateBtn.disabled = false;
                updateBtn.innerHTML = '<i class="fas fa-save me-2"></i>Update Existence';
            }
        }

        // Validate edit existence form
        function validateEditExistenceForm() {
            const requiredFields = [
                'editExistenceUnitsAvailable',
                'editExistenceUnitType',
                'editExistenceItemsPerUnit',
                'editExistenceCostPerUnit'
            ];

            let isValid = true;

            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });

            return isValid;
        }

        // Delete existence
        async function deleteExistence(id) {
            const result = await Swal.fire({
                title: 'Delete Existence?',
                text: 'This action cannot be undone. Are you sure you want to delete this existence?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel'
            });

            if (result.isConfirmed) {
                try {
                    const response = await authenticatedDelete(`${CONFIG.GATEWAY_URL}/api/v1/inventory/existences/${id}`);

                    const deleteResult = await response.json();

                    if (response.ok && deleteResult.success) {
                        Alert.success('Existence deleted successfully!');
                        await loadExistencesData();
                    } else {
                        Alert.error(deleteResult.message || 'Failed to delete existence');
                    }
                } catch (error) {
                    console.error('❌ Error deleting existence:', error);
                    Alert.error('Failed to delete existence');
                }
            }
        }

        // Load ingredients for filter dropdown
        async function loadFilterIngredients() {
            try {
                const response = await authenticatedGet(`${CONFIG.GATEWAY_URL}/api/v1/inventory/ingredients`);
                const result = await response.json();

                if (response.ok && result.success) {
                    const select = document.getElementById('filterIngredient');
                    if (select) {
                        select.innerHTML = '<option value="">All Ingredients</option>';
                        result.data.forEach(ingredient => {
                            select.innerHTML += `<option value="${ingredient.id}">${ingredient.name}</option>`;
                        });
                    }
                }
            } catch (error) {
                console.error('❌ Error loading filter ingredients:', error);
            }
        }

        // Load ingredients for picker modal
        async function loadIngredientDropdown() {
            try {
                const response = await authenticatedGet(`${CONFIG.GATEWAY_URL}/api/v1/inventory/ingredients`);
                const result = await response.json();

                if (response.ok && result.success) {
                    availableIngredients = result.data;
                }
            } catch (error) {
                console.error('❌ Error loading ingredients:', error);
                availableIngredients = [];
            }
        }

        // Open ingredient picker modal
        async function openIngredientPicker(formType) {
            currentExistenceModal = formType;
            
            // Load ingredients if not already loaded
            if (availableIngredients.length === 0) {
                await loadIngredientDropdown();
            }
            
            populateIngredientPicker();
            const modal = new bootstrap.Modal(document.getElementById('ingredientPickerModal'));
            modal.show();
        }

        // Populate ingredient picker modal
        function populateIngredientPicker() {
            const tbody = document.getElementById('ingredientPickerTableBody');
            
            if (!availableIngredients || availableIngredients.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>No ingredients available
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = '';
            availableIngredients.forEach(ingredient => {
                const row = `
                    <tr>
                        <td><strong>${ingredient.name}</strong></td>
                        <td>${ingredient.description || 'No description'}</td>
                        <td>${ingredient.category_name || 'Uncategorized'}</td>
                        <td>${ingredient.supplier_name || 'No supplier'}</td>
                        <td>
                            <button class="btn btn-select btn-sm" onclick="selectIngredient('${ingredient.id}', '${ingredient.name}')">
                                <i class="fas fa-check me-1"></i>Select
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            // Setup search functionality
            const searchInput = document.getElementById('ingredientSearchInput');
            searchInput.value = '';
            searchInput.onkeyup = filterIngredientPicker;
        }

        // Filter ingredient picker
        function filterIngredientPicker() {
            const searchTerm = document.getElementById('ingredientSearchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#ingredientPickerTableBody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // Select ingredient from picker
        function selectIngredient(ingredientId, ingredientName) {
            const ingredientField = document.getElementById('existenceIngredient');
            const ingredientIdField = document.getElementById('existenceIngredientId');
            
            if (ingredientField && ingredientIdField) {
                ingredientField.value = ingredientName;
                ingredientIdField.value = ingredientId;
                ingredientField.classList.remove('is-invalid');
            }

            const modal = bootstrap.Modal.getInstance(document.getElementById('ingredientPickerModal'));
            modal.hide();
        }

        // Apply filters
        function applyExistenceFilters() {
            const filters = {
                ingredient_id: document.getElementById('filterIngredient').value,
                unit_type: document.getElementById('filterUnitType').value,
                status: document.getElementById('filterStatus').value
            };

            // Remove empty filters
            Object.keys(filters).forEach(key => {
                if (!filters[key]) {
                    delete filters[key];
                }
            });

            loadExistencesData(filters);
        }

        // Clear filters
        function clearExistenceFilters() {
            document.getElementById('filterIngredient').value = '';
            document.getElementById('filterUnitType').value = '';
            document.getElementById('filterStatus').value = '';
            loadExistencesData();
        }

        // Inject supplier modal dynamically (existing function from suppliers - no changes needed)
        function injectSupplierModal() {
            // Check if modal already exists
            if (document.getElementById('addSupplierModal')) {
                return;
            }

            // Inject CSS if not already present
            if (!document.getElementById('supplier-modal-styles')) {
                const style = document.createElement('style');
                style.id = 'supplier-modal-styles';
                style.textContent = `
                    /* Supplier Modal Styles */
                    .supplier-modal-content {
                        border: none;
                        border-radius: var(--border-radius-lg);
                        box-shadow: var(--shadow-heavy);
                    }
                    
                    .supplier-modal-header {
                        background: var(--gradient-primary);
                        color: var(--white);
                        border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
                        border-bottom: none;
                    }
                    
                    .btn-save-supplier {
                        background: var(--gradient-primary);
                        border: none;
                        border-radius: var(--border-radius);
                        padding: 0.75rem 2rem;
                        font-weight: 600;
                        color: var(--white);
                        transition: var(--transition);
                    }
                    
                    .btn-save-supplier:hover {
                        transform: translateY(-2px);
                        box-shadow: var(--shadow-medium);
                        color: var(--white);
                    }
                    
                    .btn-save-supplier:disabled {
                        opacity: 0.7;
                        transform: none;
                    }
                `;
                document.head.appendChild(style);
            }

            // Create modal HTML
            const modalHTML = `
                <div class="modal fade" id="addSupplierModal" tabindex="-1" aria-labelledby="addSupplierModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content supplier-modal-content">
                            <div class="modal-header supplier-modal-header">
                                <h5 class="modal-title" id="addSupplierModalLabel">
                                    <i class="fas fa-plus me-2"></i>Add New Supplier
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: brightness(0) invert(1);"></button>
                            </div>
                            <div class="modal-body">
                                <form id="addSupplierForm" novalidate>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="supplierName" class="form-label">
                                                Supplier Name <span class="text-danger">*</span>
                                            </label>
                                            <input type="text" class="form-control" id="supplierName" name="supplier_name" 
                                                   maxlength="255" required>
                                            <div class="invalid-feedback">
                                                Please provide a valid supplier name (1-255 characters).
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="contactNumber" class="form-label">Contact Number</label>
                                            <input type="tel" class="form-control" id="contactNumber" name="contact_number" 
                                                   maxlength="50" placeholder="+1 (555) 123-4567">
                                            <div class="invalid-feedback">
                                                Please provide a valid contact number (max 50 characters).
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="supplierEmail" class="form-label">Email Address</label>
                                            <input type="email" class="form-control" id="supplierEmail" name="email" 
                                                   maxlength="255" placeholder="supplier@example.com">
                                            <div class="invalid-feedback">
                                                Please provide a valid email address.
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="supplierAddress" class="form-label">Address</label>
                                            <input type="text" class="form-control" id="supplierAddress" name="address" 
                                                   placeholder="123 Main St, City, State, ZIP">
                                            <div class="invalid-feedback">
                                                Please provide a valid address.
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="supplierNotes" class="form-label">Notes</label>
                                        <textarea class="form-control" id="supplierNotes" name="notes" rows="3" 
                                                  placeholder="Additional notes about this supplier..."></textarea>
                                        <div class="invalid-feedback">
                                            Please provide valid notes.
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-save-supplier" id="saveSupplierBtn" onclick="saveSupplier()">
                                    <i class="fas fa-save me-2"></i>Save Supplier
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Inject modal into body
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Set up cleanup when modal is hidden
            const modal = document.getElementById('addSupplierModal');
            modal.addEventListener('hidden.bs.modal', function() {
                // Remove modal from DOM after it's hidden, unless we're on suppliers page
                if (!document.getElementById('suppliersTableContainer')) {
                    setTimeout(() => {
                        modal.remove();
                    }, 100);
                }
            });
        }

        // Initialize Runout Ingredients Content
        async function initRunoutIngredientsContent() {
            await loadRunoutIngredientsData();
        }

        async function loadRunoutIngredientsData() {
            
            try {
                const response = await authenticatedGet(`${CONFIG.GATEWAY_URL}/api/v1/inventory/runout-ingredients?limit=1000`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const runoutIngredients = data.data || [];
                
                displayRunoutIngredients(runoutIngredients);
                
            } catch (error) {
                console.error('❌ Error loading runout ingredients:', error);
                displayRunoutIngredientsError('Failed to load runout ingredients. Please check your connection and try again.');
            }
        }

        function displayRunoutIngredients(runoutIngredients) {
            const container = document.getElementById('runoutIngredientsTableContainer');
            
            if (!runoutIngredients || runoutIngredients.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-exclamation-triangle empty-state-icon"></i>
                        <h5>No Runout Ingredients Found</h5>
                        <p class="text-muted">No runout ingredients have been reported yet.</p>
                        <button class="btn btn-primary" onclick="openAddRunoutIngredientModal()">
                            <i class="fas fa-plus me-2"></i>Add Runout Ingredient
                        </button>
                    </div>
                `;
                return;
            }

            const tableHtml = `
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Existence</th>
                                <th>Employee</th>
                                <th>Quantity</th>
                                <th>Unit Type</th>
                                <th>Report Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${runoutIngredients.map(item => `
                                <tr>
                                    <td>
                                        <strong>${item.existence_reference_code || 'N/A'}</strong>
                                    </td>
                                    <td>${item.employee_id || 'N/A'}</td>
                                    <td>${item.quantity || 'N/A'}</td>
                                    <td>${item.unit_type || 'N/A'}</td>
                                    <td>${item.report_date || 'N/A'}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewRunoutIngredient('${item.id}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary ms-1" onclick="editRunoutIngredient('${item.id}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = tableHtml;
        }

        function displayRunoutIngredientsError(message) {
            const container = document.getElementById('runoutIngredientsTableContainer');
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle error-state-icon"></i>
                    <h5>Error Loading Data</h5>
                    <p class="text-muted">${message}</p>
                    <button class="btn btn-primary" onclick="loadRunoutIngredientsData()">
                        <i class="fas fa-redo me-2"></i>Try Again
                    </button>
                </div>
            `;
        }

        // Global function for runout ingredients modal
        window.openAddRunoutIngredientModal = function() {
            console.log('🔧 openAddRunoutIngredientModal called from global scope');
            const modalElement = document.getElementById('addRunoutIngredientModal');
            if (modalElement) {
                // Reset form if resetRunoutIngredientForm function exists
                if (typeof resetRunoutIngredientForm === 'function') {
                    resetRunoutIngredientForm();
                }
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            } else {
                console.error('❌ Modal element not found');
            }
        };

        // Global picker functions for runout ingredients
        window.openExistencePicker = async function() {
            console.log('🔧 openExistencePicker called');
            await loadExistencesForPicker();
            const modal = new bootstrap.Modal(document.getElementById('existencePickerModal'));
            modal.show();
        };

        window.openUnitTypePicker = function() {
            console.log('🔧 openUnitTypePicker called');
            displayUnitTypesForPicker();
            const modal = new bootstrap.Modal(document.getElementById('unitTypePickerModal'));
            modal.show();
        };

        // Existence picker data and functions
        let allExistences = [];
        let filteredExistences = [];

        async function loadExistencesForPicker() {
            try {
                const response = await authenticatedGet(`${CONFIG.GATEWAY_URL}/api/v1/inventory/existences?limit=1000`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                allExistences = result.data || [];
                filteredExistences = [...allExistences];
                
                displayExistencesForPicker();
                
            } catch (error) {
                console.error('❌ Error loading existences for picker:', error);
                Alert.error('Failed to load existences. Please try again.');
            }
        }

        function displayExistencesForPicker() {
            const tbody = document.getElementById('existencePickerTableBody');
            
            if (!filteredExistences || filteredExistences.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted py-4">
                            <i class="fas fa-search me-2"></i>No existences found
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredExistences.map(existence => `
                <tr>
                    <td><code>${existence.reference_code || 'N/A'}</code></td>
                    <td>${existence.ingredient_name || 'N/A'}</td>
                    <td><strong>${existence.current_stock || '0'}</strong></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="selectExistence('${existence.id}', '${existence.reference_code}')">
                            <i class="fas fa-check me-1"></i>Select
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        window.filterExistences = function() {
            const searchTerm = document.getElementById('existenceSearchInput').value.toLowerCase();
            
            filteredExistences = allExistences.filter(existence => 
                (existence.reference_code && existence.reference_code.toLowerCase().includes(searchTerm)) ||
                (existence.ingredient_name && existence.ingredient_name.toLowerCase().includes(searchTerm))
            );
            
            displayExistencesForPicker();
        };

        window.selectExistence = function(existenceId, referenceCode) {
            document.getElementById('runoutExistenceId').value = existenceId;
            document.getElementById('runoutExistenceDisplay').value = referenceCode;
            
            // Hide modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('existencePickerModal'));
            modal.hide();
            
            // Clear search
            document.getElementById('existenceSearchInput').value = '';
        };

        // Unit type picker data and functions
        const unitTypes = [
            { value: 'kg', label: 'Kilograms (kg)' },
            { value: 'g', label: 'Grams (g)' },
            { value: 'l', label: 'Liters (l)' },
            { value: 'ml', label: 'Milliliters (ml)' },
            { value: 'pcs', label: 'Pieces (pcs)' },
            { value: 'units', label: 'Units' },
            { value: 'oz', label: 'Ounces (oz)' },
            { value: 'lb', label: 'Pounds (lb)' },
            { value: 'gal', label: 'Gallons (gal)' },
            { value: 'qt', label: 'Quarts (qt)' },
            { value: 'pt', label: 'Pints (pt)' },
            { value: 'cup', label: 'Cups' },
            { value: 'tbsp', label: 'Tablespoons (tbsp)' },
            { value: 'tsp', label: 'Teaspoons (tsp)' }
        ];
        let filteredUnitTypes = [...unitTypes];

        function displayUnitTypesForPicker() {
            const list = document.getElementById('unitTypePickerList');
            
            if (!filteredUnitTypes || filteredUnitTypes.length === 0) {
                list.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-search me-2"></i>No unit types found
                    </div>
                `;
                return;
            }

            list.innerHTML = filteredUnitTypes.map(unitType => `
                <button type="button" class="list-group-item list-group-item-action" 
                        onclick="selectUnitType('${unitType.value}', '${unitType.label}')">
                    <i class="fas fa-ruler me-2"></i>${unitType.label}
                </button>
            `).join('');
        }

        window.filterUnitTypes = function() {
            const searchTerm = document.getElementById('unitTypeSearchInput').value.toLowerCase();
            
            filteredUnitTypes = unitTypes.filter(unitType => 
                unitType.label.toLowerCase().includes(searchTerm) ||
                unitType.value.toLowerCase().includes(searchTerm)
            );
            
            displayUnitTypesForPicker();
        };

        window.selectUnitType = function(unitTypeValue, unitTypeLabel) {
            document.getElementById('runoutUnitType').value = unitTypeValue;
            document.getElementById('runoutUnitTypeDisplay').value = unitTypeLabel;
            
            // Hide modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('unitTypePickerModal'));
            modal.hide();
            
            // Clear search
            document.getElementById('unitTypeSearchInput').value = '';
        };



        // Initialize Recipe Categories Content
        async function initRecipeCategoriesContent() {
            await loadRecipeCategoriesData();
        }

        async function loadRecipeCategoriesData() {
            
            try {
                const response = await authenticatedGet(`${CONFIG.GATEWAY_URL}/api/v1/inventory/recipe-categories?limit=1000`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const recipeCategories = data.data || [];
                
                displayRecipeCategories(recipeCategories);
                
            } catch (error) {
                console.error('❌ Error loading recipe categories:', error);
                displayRecipeCategoriesError('Failed to load recipe categories. Please check your connection and try again.');
            }
        }

        function displayRecipeCategories(recipeCategories) {
            const container = document.getElementById('recipeCategoriesTableContainer');
            
            if (!recipeCategories || recipeCategories.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-tags empty-state-icon"></i>
                        <h5>No Recipe Categories Found</h5>
                        <p class="text-muted">No recipe categories have been created yet.</p>
                        <button class="btn btn-primary" onclick="openAddRecipeCategoryModal()">
                            <i class="fas fa-plus me-2"></i>Add First Category
                        </button>
                    </div>
                `;
                return;
            }

            const tableHtml = `
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Created At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${recipeCategories.map(category => `
                                <tr>
                                    <td>
                                        <strong>${category.name || 'N/A'}</strong>
                                    </td>
                                    <td>${category.description || 'N/A'}</td>
                                    <td>${category.created_at || 'N/A'}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewRecipeCategory('${category.id}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary ms-1" onclick="editRecipeCategory('${category.id}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = tableHtml;
        }

        function displayRecipeCategoriesError(message) {
            const container = document.getElementById('recipeCategoriesTableContainer');
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle error-state-icon"></i>
                    <h5>Error Loading Data</h5>
                    <p class="text-muted">${message}</p>
                    <button class="btn btn-primary" onclick="loadRecipeCategoriesData()">
                        <i class="fas fa-redo me-2"></i>Try Again
                    </button>
                </div>
            `;
        }

        // Initialize Recipes Content
        async function initRecipesContent() {
            await loadRecipesData();
        }

        async function loadRecipesData() {
            
            try {
                const response = await authenticatedGet(`${CONFIG.GATEWAY_URL}/api/v1/inventory/recipes?limit=1000`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const recipes = data.data || [];
                
                displayRecipes(recipes);
                
            } catch (error) {
                console.error('❌ Error loading recipes:', error);
                displayRecipesError('Failed to load recipes. Please check your connection and try again.');
            }
        }

        function displayRecipes(recipes) {
            const container = document.getElementById('recipesTableContainer');
            
            if (!recipes || recipes.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-utensils empty-state-icon"></i>
                        <h5>No Recipes Found</h5>
                        <p class="text-muted">No recipes have been created yet.</p>
                        <button class="btn btn-primary" onclick="openAddRecipeModal()">
                            <i class="fas fa-plus me-2"></i>Add Recipe
                        </button>
                    </div>
                `;
                return;
            }

            const tableHtml = `
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th>Total Cost</th>
                                <th>Created At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${recipes.map(recipe => `
                                <tr>
                                    <td>
                                        <strong>${recipe.name || 'N/A'}</strong>
                                    </td>
                                    <td>${recipe.description || 'N/A'}</td>
                                    <td>${recipe.category_id || 'N/A'}</td>
                                    <td>$${recipe.total_cost || '0.00'}</td>
                                    <td>${recipe.created_at || 'N/A'}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewRecipe('${recipe.id}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary ms-1" onclick="editRecipe('${recipe.id}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = tableHtml;
        }

        function displayRecipesError(message) {
            const container = document.getElementById('recipesTableContainer');
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle error-state-icon"></i>
                    <h5>Error Loading Data</h5>
                    <p class="text-muted">${message}</p>
                    <button class="btn btn-primary" onclick="loadRecipesData()">
                        <i class="fas fa-redo me-2"></i>Try Again
                    </button>
                </div>
            `;
        }

        // Supplier Picker Functions
        let currentSupplierModal = null; // Track which modal opened the supplier picker

        // Open supplier picker modal
        window.openSupplierPicker = async function(modalType) {
            currentSupplierModal = modalType;
            await loadDropdownData(); // Ensure suppliers are loaded
            populateSupplierPicker();
            
            const modal = new bootstrap.Modal(document.getElementById('supplierPickerModal'));
            modal.show();
        };

        // Populate supplier picker table
        function populateSupplierPicker() {
            const tbody = document.getElementById('supplierPickerTableBody');
            if (!tbody) return;

            if (!availableSuppliers || availableSuppliers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted py-4">
                            <i class="fas fa-truck me-2"></i>No suppliers available
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = availableSuppliers.map(supplier => `
                <tr class="supplier-row" data-supplier-id="${supplier.id}" data-supplier-name="${supplier.supplier_name.toLowerCase()}" data-supplier-contact="${(supplier.contact_number || '').toLowerCase()}" data-supplier-email="${(supplier.email || '').toLowerCase()}">
                    <td class="fw-bold">${supplier.supplier_name}</td>
                    <td class="text-muted">
                        ${supplier.contact_number ? `<div><i class="fas fa-phone me-1"></i>${supplier.contact_number}</div>` : ''}
                        ${supplier.email ? `<div><i class="fas fa-envelope me-1"></i>${supplier.email}</div>` : ''}
                    </td>
                    <td>
                        <span class="status-badge status-active">
                            Active
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="selectSupplier('${supplier.id}', '${supplier.supplier_name.replace(/'/g, "\\'")}')">
                            <i class="fas fa-check"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Filter suppliers based on search
        window.filterSuppliers = function() {
            const searchTerm = document.getElementById('supplierSearchInput').value.toLowerCase();
            const rows = document.querySelectorAll('.supplier-row');

            rows.forEach(row => {
                const name = row.getAttribute('data-supplier-name');
                const contact = row.getAttribute('data-supplier-contact');
                const email = row.getAttribute('data-supplier-email');
                
                if (name.includes(searchTerm) || contact.includes(searchTerm) || email.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };

        // Select a supplier
        window.selectSupplier = function(supplierId, supplierName) {
            if (currentSupplierModal === 'add') {
                document.getElementById('ingredientSupplier').value = supplierId;
                document.getElementById('ingredientSupplierDisplay').value = supplierName;
            } else {
                document.getElementById('editIngredientSupplier').value = supplierId;
                document.getElementById('editIngredientSupplierDisplay').value = supplierName;
            }

            // Close supplier picker modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('supplierPickerModal'));
            modal.hide();
            
            currentSupplierModal = null;
        };

        // Ingredient Modal Functions
        window.openAddIngredientModal = async function() {
            await loadDropdownData();
            resetIngredientForm();
            const modal = new bootstrap.Modal(document.getElementById('addIngredientModal'));
            modal.show();
        };

        function resetIngredientForm() {
            const form = document.getElementById('addIngredientForm');
            if (form) {
                form.reset();
                form.classList.remove('was-validated');
                
                // Clear picker displays
                document.getElementById('ingredientCategoryDisplay').value = '';
                document.getElementById('ingredientCategory').value = '';
                document.getElementById('ingredientSupplierDisplay').value = '';
                document.getElementById('ingredientSupplier').value = '';
                
                // Remove validation classes
                const fields = ['ingredientName', 'ingredientDescription'];
                fields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) field.classList.remove('is-invalid', 'is-valid');
                });
            }
        }

        async function saveIngredient() {
            const form = document.getElementById('addIngredientForm');
            const saveBtn = document.querySelector('#addIngredientModal .btn-save-ingredient');
            
            // Reset validation state
            form.classList.remove('was-validated');
            form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            
            // Collect form data
            const formData = new FormData(form);
            const ingredientData = {};
            
            // Process form fields
            for (let [key, value] of formData.entries()) {
                const trimmedValue = value.trim();
                if (trimmedValue) {
                    ingredientData[key] = trimmedValue;
                }
            }
            
            // Validate required fields
            let isValid = true;
            
            if (!ingredientData.ingredient_name || ingredientData.ingredient_name.length < 1 || ingredientData.ingredient_name.length > 255) {
                document.getElementById('ingredientName').classList.add('is-invalid');
                isValid = false;
            }
            
            if (!ingredientData.ingredient_category_id) {
                document.getElementById('ingredientCategoryDisplay').classList.add('is-invalid');
                isValid = false;
            }
            
            if (!ingredientData.supplier_id) {
                document.getElementById('ingredientSupplierDisplay').classList.add('is-invalid');
                isValid = false;
            }
            
            if (!isValid) {
                form.classList.add('was-validated');
                return;
            }
            
            // Update button state
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
            
            try {
                const response = await authenticatedPost(`${CONFIG.GATEWAY_URL}/api/v1/inventory/ingredients`, ingredientData);
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    Alert.success('Ingredient created successfully!');
                    
                    // Hide modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addIngredientModal'));
                    modal.hide();
                    
                    // Reload data
                    await loadIngredientsData();
                } else {
                    throw new Error(result.message || 'Failed to create ingredient');
                }
                
            } catch (error) {
                console.error('❌ Error saving ingredient:', error);
                Alert.error('Failed to save ingredient. Please check your connection and try again.');
            }
            
            // Reset button state
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Ingredient';
        }

        function viewIngredient(ingredientId) {
            console.log('👁️ Viewing ingredient:', ingredientId);
            // TODO: Implement view ingredient functionality
            Alert.info('View ingredient functionality coming soon!');
        }

        function editIngredient(ingredientId) {
            console.log('✏️ Editing ingredient:', ingredientId);
            // TODO: Implement edit ingredient functionality
            Alert.info('Edit ingredient functionality coming soon!');
        }

        async function deleteIngredient(ingredientId) {
            const ingredient = ingredients.find(i => i.id === ingredientId);
            if (!ingredient) {
                Alert.error('Ingredient not found');
                return;
            }
            
            const confirmed = await Swal.fire({
                title: 'Delete Ingredient?',
                text: `Are you sure you want to delete "${ingredient.ingredient_name}"? This action cannot be undone.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel'
            });
            
            if (confirmed.isConfirmed) {
                try {
                    const response = await authenticatedDelete(`${CONFIG.GATEWAY_URL}/api/v1/inventory/ingredients/${ingredientId}`);
                    
                    if (response.ok) {
                        Alert.success('Ingredient deleted successfully!');
                        await loadIngredientsData();
                    } else {
                        const result = await response.json();
                        throw new Error(result.message || 'Failed to delete ingredient');
                    }
                    
                } catch (error) {
                    console.error('❌ Error deleting ingredient:', error);
                    Alert.error('Failed to delete ingredient. Please try again.');
                }
            }
        }

        // Category Picker Functions
        let currentCategoryModal = null; // Track which modal opened the category picker

        // Open category picker modal
        window.openCategoryPicker = async function(modalType) {
            currentCategoryModal = modalType;
            await loadDropdownData(); // Ensure categories are loaded
            populateCategoryPicker();
            
            const modal = new bootstrap.Modal(document.getElementById('categoryPickerModal'));
            modal.show();
        };

        // Populate category picker table
        function populateCategoryPicker() {
            const tbody = document.getElementById('categoryPickerTableBody');
            if (!tbody) return;

            if (!availableCategories || availableCategories.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted py-4">
                            <i class="fas fa-tags me-2"></i>No categories available
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = availableCategories.map(category => `
                <tr class="category-row" data-category-id="${category.id}" data-category-name="${category.name.toLowerCase()}" data-category-description="${category.description.toLowerCase()}">
                    <td class="fw-bold">${category.name}</td>
                    <td class="text-muted">${category.description}</td>
                    <td>
                        <span class="status-badge ${category.is_active ? 'status-active' : 'status-inactive'}">
                            ${category.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="selectCategory('${category.id}', '${category.name.replace(/'/g, "\\'")}')">
                            <i class="fas fa-check"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Filter categories based on search
        window.filterCategories = function() {
            const searchTerm = document.getElementById('categorySearchInput').value.toLowerCase();
            const rows = document.querySelectorAll('.category-row');

            rows.forEach(row => {
                const name = row.getAttribute('data-category-name');
                const description = row.getAttribute('data-category-description');
                
                if (name.includes(searchTerm) || description.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };

        // Select a category
        window.selectCategory = function(categoryId, categoryName) {
            if (currentCategoryModal === 'add') {
                document.getElementById('ingredientCategory').value = categoryId;
                document.getElementById('ingredientCategoryDisplay').value = categoryName;
            } else {
                document.getElementById('editIngredientCategory').value = categoryId;
                document.getElementById('editIngredientCategoryDisplay').value = categoryName;
            }

            // Close category picker modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('categoryPickerModal'));
            modal.hide();
            
            currentCategoryModal = null;
        };

        // Supplier Modal Functions
        let currentIngredientModal = null; // Track which modal opened the supplier modal

        // Open supplier modal from ingredient form
        window.openSupplierModalFromIngredient = function(modalType) {
            currentIngredientModal = modalType;
            injectSupplierModal();
            
            // Update the save button to call the correct function
            const saveBtn = document.getElementById('saveSupplierBtn');
            if (saveBtn) {
                saveBtn.onclick = saveSupplierFromIngredient;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('addSupplierModal'));
            modal.show();
        };

        // Save supplier from ingredient modal
        async function saveSupplierFromIngredient() {
            const form = document.getElementById('addSupplierForm');
            const saveBtn = document.getElementById('saveSupplierBtn');
            
            // Reset validation state
            form.classList.remove('was-validated');
            form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            
            // Collect form data
            const formData = new FormData(form);
            const supplierData = {};
            
            // Process form fields
            for (let [key, value] of formData.entries()) {
                const trimmedValue = value.trim();
                if (trimmedValue) {
                    supplierData[key] = trimmedValue;
                }
            }
            
            // Validate required fields
            let isValid = true;
            
            if (!supplierData.supplier_name || supplierData.supplier_name.length < 1 || supplierData.supplier_name.length > 255) {
                document.getElementById('supplierName').classList.add('is-invalid');
                isValid = false;
            }
            
            if (!isValid) {
                form.classList.add('was-validated');
                return;
            }
            
            // Update button state
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
            
            try {
                const response = await authenticatedPost(`${CONFIG.GATEWAY_URL}/api/v1/inventory/suppliers`, supplierData);
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    Alert.success('Supplier created successfully!');
                    
                    // Hide modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addSupplierModal'));
                    modal.hide();
                    
                    // Reload suppliers data
                    await loadDropdownData();
                    
                    // If called from ingredient modal, refresh dropdowns
                    if (currentIngredientModal) {
                        // Auto-select the newly created supplier
                        const newSupplier = result.data;
                        if (currentIngredientModal === 'add') {
                            document.getElementById('ingredientSupplier').value = newSupplier.id;
                            document.getElementById('ingredientSupplierDisplay').value = newSupplier.supplier_name;
                        } else {
                            document.getElementById('editIngredientSupplier').value = newSupplier.id;
                            document.getElementById('editIngredientSupplierDisplay').value = newSupplier.supplier_name;
                        }
                    }
                    
                    currentIngredientModal = null;
                } else {
                    throw new Error(result.message || 'Failed to create supplier');
                }
                
            } catch (error) {
                console.error('❌ Error saving supplier:', error);
                Alert.error('Failed to save supplier. Please check your connection and try again.');
            }
            
            // Reset button state
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Supplier';
        }

        // Add existence modal function (placeholder)
        window.openAddExistenceModal = function() {
            console.log('🔧 openAddExistenceModal called');
            const modalElement = document.getElementById('addExistenceModal');
            if (modalElement) {
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            } else {
                console.error('❌ Add existence modal not found');
                Alert.info('Add existence functionality coming soon!');
            }
        };

        // Global function for recipes modal
        window.openAddRecipeModal = function() {
            console.log('🔧 openAddRecipeModal called from global scope');
            const modalElement = document.getElementById('addRecipeModal');
            if (modalElement) {
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            } else {
                console.error('❌ Add recipe modal not found');
                Alert.info('Add recipe functionality coming soon!');
            }
        };

        // Recipe Category Picker Functions
        let allRecipeCategories = [];
        let filteredRecipeCategories = [];

        window.openRecipeCategoryPicker = async function() {
            await loadRecipeCategoriesForPicker();
            const modal = new bootstrap.Modal(document.getElementById('recipeCategoryPickerModal'));
            modal.show();
        };

        async function loadRecipeCategoriesForPicker() {
            try {
                const response = await authenticatedGet(`${CONFIG.GATEWAY_URL}/api/v1/inventory/recipe-categories?limit=1000`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                allRecipeCategories = result.data || [];
                filteredRecipeCategories = [...allRecipeCategories];
                
                displayRecipeCategoriesForPicker();
                
            } catch (error) {
                console.error('❌ Error loading recipe categories for picker:', error);
                Alert.error('Failed to load recipe categories. Please try again.');
            }
        }

        function displayRecipeCategoriesForPicker() {
            const tbody = document.getElementById('recipeCategoryPickerTableBody');
            
            if (!filteredRecipeCategories || filteredRecipeCategories.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-muted py-4">
                            <i class="fas fa-search me-2"></i>No recipe categories found
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredRecipeCategories.map(category => `
                <tr>
                    <td><strong>${category.name || 'N/A'}</strong></td>
                    <td>${category.description || 'N/A'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="selectRecipeCategory('${category.id}', '${category.name}')">
                            <i class="fas fa-check me-1"></i>Select
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        window.filterRecipeCategories = function() {
            const searchTerm = document.getElementById('recipeCategorySearchInput').value.toLowerCase();
            
            filteredRecipeCategories = allRecipeCategories.filter(category => 
                (category.name && category.name.toLowerCase().includes(searchTerm)) ||
                (category.description && category.description.toLowerCase().includes(searchTerm))
            );
            
            displayRecipeCategoriesForPicker();
        };

        window.selectRecipeCategory = function(categoryId, categoryName) {
            document.getElementById('recipeCategoryId').value = categoryId;
            document.getElementById('recipeCategoryDisplay').value = categoryName;
            
            // Hide modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('recipeCategoryPickerModal'));
            modal.hide();
            
            // Clear search
            document.getElementById('recipeCategorySearchInput').value = '';
        };

        // Add recipe category modal function (placeholder)
        window.openAddRecipeCategoryModal = function() {
            Alert.info('Add recipe category functionality coming soon!');
        };

        // Recipe Image Upload Functions
        window.handleRecipeImageUpload = function() {
            const fileInput = document.getElementById('recipeImageFile');
            const preview = document.getElementById('recipeImagePreview');
            const previewImg = document.getElementById('recipeImagePreviewImg');
            const urlInput = document.getElementById('recipePictureUrl');
            
            if (fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];
                
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    Alert.error('Please select a valid image file.');
                    fileInput.value = '';
                    return;
                }
                
                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    Alert.error('Image file size must be less than 5MB.');
                    fileInput.value = '';
                    return;
                }
                
                // Create preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                    urlInput.value = e.target.result; // Store as data URL for now
                };
                reader.readAsDataURL(file);
            }
        };

        window.clearRecipeImage = function() {
            const fileInput = document.getElementById('recipeImageFile');
            const preview = document.getElementById('recipeImagePreview');
            const urlInput = document.getElementById('recipePictureUrl');
            
            fileInput.value = '';
            preview.style.display = 'none';
            urlInput.value = '';
        };

        // Recipe Ingredients Management
        let recipeIngredients = [];
        let allIngredients = [];
        let filteredIngredients = [];

        window.addRecipeIngredient = function() {
            openRecipeIngredientPicker();
        };

        window.openRecipeIngredientPicker = async function() {
            await loadIngredientsForRecipe();
            const modal = new bootstrap.Modal(document.getElementById('recipeIngredientPickerModal'));
            modal.show();
        };

        async function loadIngredientsForRecipe() {
            try {
                const response = await authenticatedGet(`${CONFIG.GATEWAY_URL}/api/v1/inventory/ingredients?limit=1000`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                allIngredients = result.data || [];
                filteredIngredients = [...allIngredients];
                
                displayIngredientsForRecipe();
                
            } catch (error) {
                console.error('❌ Error loading ingredients for recipe:', error);
                Alert.error('Failed to load ingredients. Please try again.');
            }
        }

        function displayIngredientsForRecipe() {
            const tbody = document.getElementById('recipeIngredientPickerTableBody');
            
            if (!filteredIngredients || filteredIngredients.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted py-4">
                            <i class="fas fa-search me-2"></i>No ingredients found
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredIngredients.map(ingredient => `
                <tr>
                    <td><strong>${ingredient.name || 'N/A'}</strong></td>
                    <td>${ingredient.category_name || 'N/A'}</td>
                    <td><span class="badge bg-secondary">${ingredient.unit_type || 'N/A'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="selectRecipeIngredient('${ingredient.id}', '${ingredient.name}', '${ingredient.unit_type}')">
                            <i class="fas fa-check me-1"></i>Select
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        window.filterRecipeIngredients = function() {
            const searchTerm = document.getElementById('recipeIngredientSearchInput').value.toLowerCase();
            
            filteredIngredients = allIngredients.filter(ingredient => 
                (ingredient.name && ingredient.name.toLowerCase().includes(searchTerm)) ||
                (ingredient.category_name && ingredient.category_name.toLowerCase().includes(searchTerm))
            );
            
            displayIngredientsForRecipe();
        };

        window.selectRecipeIngredient = function(ingredientId, ingredientName, unitType) {
            // Add ingredient to the list
            const ingredient = {
                id: ingredientId,
                name: ingredientName,
                unit_type: unitType,
                quantity: 1
            };
            
            recipeIngredients.push(ingredient);
            displayRecipeIngredients();
            
            // Hide modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('recipeIngredientPickerModal'));
            modal.hide();
            
            // Clear search
            document.getElementById('recipeIngredientSearchInput').value = '';
        };

        function displayRecipeIngredients() {
            const container = document.getElementById('recipeIngredientsList');
            
            if (!recipeIngredients || recipeIngredients.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-info-circle me-2"></i>No ingredients added yet
                    </div>
                `;
                return;
            }

            container.innerHTML = recipeIngredients.map((ingredient, index) => `
                <div class="card mb-2">
                    <div class="card-body p-3">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <strong>${ingredient.name}</strong>
                                <br><small class="text-muted">${ingredient.unit_type}</small>
                            </div>
                            <div class="col-md-3">
                                <input type="number" step="0.001" min="0.001" class="form-control form-control-sm" 
                                       value="${ingredient.quantity}" 
                                       onchange="updateRecipeIngredientQuantity(${index}, this.value)">
                            </div>
                            <div class="col-md-3">
                                <span class="text-muted">units</span>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRecipeIngredient(${index})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        window.updateRecipeIngredientQuantity = function(index, quantity) {
            if (recipeIngredients[index]) {
                recipeIngredients[index].quantity = parseFloat(quantity) || 1;
            }
        };

        window.removeRecipeIngredient = function(index) {
            recipeIngredients.splice(index, 1);
            displayRecipeIngredients();
        };

        // Ingredient Management Functions
        let currentIngredientForEdit = null;

        window.viewIngredient = async function(ingredientId) {
            console.log('👁️ Viewing ingredient:', ingredientId);
            await loadIngredientForView(ingredientId);
        };

        window.editIngredient = async function(ingredientId) {
            console.log('✏️ Editing ingredient:', ingredientId);
            await loadIngredientForEdit(ingredientId);
        };

        window.deleteIngredient = async function(ingredientId) {
            console.log('🗑️ Deleting ingredient:', ingredientId);
            await deleteIngredientConfirm(ingredientId);
        };

        async function loadIngredientForView(ingredientId) {
            try {
                const response = await authenticatedGet(`${CONFIG.GATEWAY_URL}/api/v1/inventory/ingredients/${ingredientId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                const ingredient = result.data;
                
                // Get category and supplier names if IDs exist
                let categoryName = 'Not assigned';
                let supplierName = 'Not assigned';
                
                if (ingredient.ingredient_category_id) {
                    try {
                        const categoryResponse = await authenticatedGet(`${CONFIG.GATEWAY_URL}/api/v1/inventory/ingredient-categories/${ingredient.ingredient_category_id}`);
                        if (categoryResponse.ok) {
                            const categoryResult = await categoryResponse.json();
                            categoryName = categoryResult.data.name;
                        }
                    } catch (error) {
                        console.warn('Could not fetch category name:', error);
                    }
                }
                
                if (ingredient.supplier_id) {
                    try {
                        const supplierResponse = await authenticatedGet(`${CONFIG.GATEWAY_URL}/api/v1/inventory/suppliers/${ingredient.supplier_id}`);
                        if (supplierResponse.ok) {
                            const supplierResult = await supplierResponse.json();
                            supplierName = supplierResult.data.supplier_name;
                        }
                    } catch (error) {
                        console.warn('Could not fetch supplier name:', error);
                    }
                }
                
                // Populate view modal
                document.getElementById('viewIngredientContent').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="fw-bold">Ingredient Information</h6>
                            <table class="table table-borderless">
                                <tr>
                                    <td class="fw-bold">Name:</td>
                                    <td><strong>${ingredient.name}</strong></td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Category:</td>
                                    <td>${categoryName}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Supplier:</td>
                                    <td>${supplierName}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Description:</td>
                                    <td>${ingredient.description || 'No description provided'}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Created:</td>
                                    <td>${new Date(ingredient.created_at).toLocaleString()}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Last Updated:</td>
                                    <td>${new Date(ingredient.updated_at).toLocaleString()}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                `;
                
                currentIngredientForEdit = ingredient;
                
                const modal = new bootstrap.Modal(document.getElementById('viewIngredientModal'));
                modal.show();
                
            } catch (error) {
                console.error('❌ Error loading ingredient for view:', error);
                Alert.error('Failed to load ingredient details. Please try again.');
            }
        }

        async function loadIngredientForEdit(ingredientId) {
            try {
                const response = await authenticatedGet(`${CONFIG.GATEWAY_URL}/api/v1/inventory/ingredients/${ingredientId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                const ingredient = result.data;
                
                // Get category and supplier names if IDs exist
                let categoryName = '';
                let supplierName = '';
                
                if (ingredient.ingredient_category_id) {
                    try {
                        const categoryResponse = await authenticatedGet(`${CONFIG.GATEWAY_URL}/api/v1/inventory/ingredient-categories/${ingredient.ingredient_category_id}`);
                        if (categoryResponse.ok) {
                            const categoryResult = await categoryResponse.json();
                            categoryName = categoryResult.data.name;
                        }
                    } catch (error) {
                        console.warn('Could not fetch category name:', error);
                    }
                }
                
                if (ingredient.supplier_id) {
                    try {
                        const supplierResponse = await authenticatedGet(`${CONFIG.GATEWAY_URL}/api/v1/inventory/suppliers/${ingredient.supplier_id}`);
                        if (supplierResponse.ok) {
                            const supplierResult = await supplierResponse.json();
                            supplierName = supplierResult.data.supplier_name;
                        }
                    } catch (error) {
                        console.warn('Could not fetch supplier name:', error);
                    }
                }
                
                // Populate edit form
                document.getElementById('editIngredientName').value = ingredient.name;
                document.getElementById('editIngredientCategoryDisplay').value = categoryName;
                document.getElementById('editIngredientCategory').value = ingredient.ingredient_category_id || '';
                document.getElementById('editIngredientSupplierDisplay').value = supplierName;
                document.getElementById('editIngredientSupplier').value = ingredient.supplier_id || '';
                document.getElementById('editIngredientDescription').value = ingredient.description || '';
                
                currentIngredientForEdit = ingredient;
                
                const modal = new bootstrap.Modal(document.getElementById('editIngredientModal'));
                modal.show();
                
            } catch (error) {
                console.error('❌ Error loading ingredient for edit:', error);
                Alert.error('Failed to load ingredient for editing. Please try again.');
            }
        }

        window.updateIngredient = async function() {
            const form = document.getElementById('editIngredientForm');
            const updateBtn = document.querySelector('#editIngredientModal .btn-save-ingredient');
            
            if (!currentIngredientForEdit) {
                Alert.error('No ingredient selected for update.');
                return;
            }
            
            // Reset validation state
            form.classList.remove('was-validated');
            form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            
            // Collect form data
            const formData = new FormData(form);
            const ingredientData = {};
            
            // Process form fields
            for (let [key, value] of formData.entries()) {
                const trimmedValue = value.trim();
                if (trimmedValue) {
                    ingredientData[key] = trimmedValue;
                }
            }
            
            // Validate required fields
            let isValid = true;
            
            if (!ingredientData.ingredient_name) {
                document.getElementById('editIngredientName').classList.add('is-invalid');
                isValid = false;
            }
            
            if (!isValid) {
                form.classList.add('was-validated');
                return;
            }
            
            // Update button state
            updateBtn.disabled = true;
            updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
            
            try {
                const response = await authenticatedPut(`${CONFIG.GATEWAY_URL}/api/v1/inventory/ingredients/${currentIngredientForEdit.id}`, ingredientData);
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    Alert.success('Ingredient updated successfully!');
                    
                    // Hide modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editIngredientModal'));
                    modal.hide();
                    
                    // Reload data
                    await loadIngredientsData();
                } else {
                    throw new Error(result.message || 'Failed to update ingredient');
                }
                
            } catch (error) {
                console.error('❌ Error updating ingredient:', error);
                Alert.error('Failed to update ingredient. Please check your connection and try again.');
            }
            
            // Reset button state
            updateBtn.disabled = false;
            updateBtn.innerHTML = '<i class="fas fa-save me-2"></i>Update Ingredient';
        };

        async function deleteIngredientConfirm(ingredientId) {
            const confirmed = await Swal.fire({
                title: 'Delete Ingredient?',
                text: `Are you sure you want to delete this ingredient? This action cannot be undone.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel'
            });
            
            if (confirmed.isConfirmed) {
                try {
                                    const response = await authenticatedDelete(`${CONFIG.GATEWAY_URL}/api/v1/inventory/ingredients/${ingredientId}`);
                    
                    if (response.ok) {
                        Alert.success('Ingredient deleted successfully!');
                        await loadIngredientsData();
                    } else {
                        const result = await response.json();
                        throw new Error(result.message || 'Failed to delete ingredient');
                    }
                    
                } catch (error) {
                    console.error('❌ Error deleting ingredient:', error);
                    Alert.error('Failed to delete ingredient. Please try again.');
                }
            }
        }

        window.editIngredientFromView = function() {
            if (currentIngredientForEdit) {
                // Hide view modal
                const viewModal = bootstrap.Modal.getInstance(document.getElementById('viewIngredientModal'));
                viewModal.hide();
                
                // Open edit modal
                loadIngredientForEdit(currentIngredientForEdit.id);
            }
        };

        // === TOKEN VALIDATION AND REFRESH ===
        
        // Periodic token validation to prevent expiration
        function startTokenValidation() {
            // Check token every 5 minutes
            setInterval(async () => {
                try {
                    if (window.authService && window.authService.isAuthenticated()) {
                        const isValid = await window.authService.validateToken();
                        if (!isValid) {
                            console.warn('Token validation failed, redirecting to login');
                            window.location.href = 'login.html';
                        }
                    }
                } catch (error) {
                    console.error('Token validation error:', error);
                    window.location.href = 'login.html';
                }
            }, 5 * 60 * 1000); // 5 minutes
        }

        // Start token validation when dashboard loads
        if (window.authService) {
            startTokenValidation();
        }

        // Invoice modal and form functions
        window.openCreateInvoiceModal = function() {
            console.log('Opening create invoice modal...');
            
            try {
                // Check if Bootstrap is available
                if (typeof bootstrap === 'undefined') {
                    console.error('Bootstrap is not available');
                    alert('Bootstrap is not loaded. Modal cannot be opened.');
                    return;
                }
                
                const modal = document.getElementById('createInvoiceModal');
                if (!modal) {
                    console.error('Modal element not found');
                    alert('Modal element not found');
                    return;
                }
                
                // Reset form
                const form = document.getElementById('createInvoiceForm');
                if (form) {
                    form.reset();
                }
                
                // Reset items container
                const itemsContainer = document.getElementById('itemsContainer');
                if (itemsContainer) {
                    itemsContainer.innerHTML = '';
                    // Add first item row
                    if (typeof addItemRow === 'function') {
                        addItemRow();
                    }
                }
                
                // Create and show the modal
                const bootstrapModal = new bootstrap.Modal(modal);
                bootstrapModal.show();
                console.log('Modal opened successfully');
                
            } catch (error) {
                console.error('Error opening modal:', error);
                alert('Failed to open create invoice modal: ' + error.message);
            }
        };

        // Add item row function for invoice modal
        window.addItemRow = function() {
            const container = document.getElementById('itemsContainer');
            if (!container) return;
            
            const itemIndex = container.children.length;
            
            const itemHTML = `
                <div class="item-row" data-index="${itemIndex}">
                    <div class="row">
                        <div class="col-md-3">
                            <label>Detail *</label>
                            <input type="text" class="form-control" name="detail" required>
                        </div>
                        <div class="col-md-2">
                            <label>Count *</label>
                            <input type="number" class="form-control" name="count" step="0.01" min="0" required>
                        </div>
                        <div class="col-md-2">
                            <label>Unit Type *</label>
                            <select class="form-select" name="unitType" required>
                                <option value="">Select</option>
                                <option value="Liters">Liters</option>
                                <option value="Gallons">Gallons</option>
                                <option value="Units">Units</option>
                                <option value="Bag">Bag</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label>Price *</label>
                            <input type="number" class="form-control" name="price" step="0.01" min="0" required>
                        </div>
                        <div class="col-md-2">
                            <label>Expiration Date</label>
                            <input type="date" class="form-control" name="expirationDate">
                        </div>
                        <div class="col-md-1">
                            <button type="button" class="remove-item-btn" onclick="removeItemRow(${itemIndex})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', itemHTML);
        };

        // Remove item row function for invoice modal
        window.removeItemRow = function(index) {
            const container = document.getElementById('itemsContainer');
            if (!container) return;
            
            const rows = container.querySelectorAll('.item-row');
            if (rows.length > 1) {
                rows[index].remove();
                // Reindex remaining rows
                container.querySelectorAll('.item-row').forEach((row, newIndex) => {
                    row.dataset.index = newIndex;
                    row.querySelector('.remove-item-btn').onclick = () => removeItemRow(newIndex);
                });
            }
        };
    </script>
</body>
</html> 