<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ice Cream Store - Management Dashboard</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <!-- Shared CSS -->
    <link rel="stylesheet" href="shared/css/style.css?v=1.3">
    
    <style>
        /* SPA Dashboard Layout */
        body {
            background: var(--background-light);
            font-family: 'Poppins', sans-serif;
        }
        
        .dashboard-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        .dashboard-sidebar {
            width: 280px;
            flex-shrink: 0;
            background: var(--white);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            z-index: 1000;
        }
        
        .dashboard-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .dashboard-header {
            background: var(--white);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            z-index: 999;
            display: flex;
            justify-content: between;
            align-items: center;
        }
        
        .dashboard-content {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }
        
        /* Sidebar Styles */
        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }
        
        .sidebar-nav {
            padding: 1.5rem 1rem;
        }
        
        .nav-section-title {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--secondary-color);
            margin-bottom: 1rem;
            padding: 0 0.75rem;
            letter-spacing: 0.5px;
        }
        
        .nav-pills .nav-link {
            border-radius: var(--border-radius);
            margin-bottom: 0.25rem;
            padding: 0.75rem;
            color: var(--dark-color);
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            background: none;
            text-align: left;
            width: 100%;
        }
        
        .nav-pills .nav-link:hover {
            background: var(--primary-light);
            color: var(--primary-color);
            transform: translateX(5px);
        }
        
        .nav-pills .nav-link.active {
            background: var(--primary-color);
            color: var(--white);
            box-shadow: var(--shadow-light);
        }
        
        .nav-sub {
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
            margin-left: 1rem;
        }
        
        /* Content Loading */
        .content-loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: var(--secondary-color);
        }
        
        .loading-spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .dashboard-sidebar {
                position: fixed;
                left: -280px;
                height: 100vh;
                transition: left 0.3s ease;
                z-index: 1050;
            }
            
            .dashboard-sidebar.show {
                left: 0;
            }
            
            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1040;
                display: none;
            }
            
            .sidebar-overlay.show {
                display: block;
            }
            
            .dashboard-content {
                padding: 1rem;
            }
        }
        
        .breadcrumb-container {
            background: var(--white);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            margin: 0;
        }
        
        .breadcrumb {
            margin: 0;
            background: transparent;
            padding: 0;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="dashboard-sidebar" id="dashboardSidebar">
            <!-- Sidebar Header -->
            <div class="sidebar-header">
                <i class="fas fa-ice-cream text-primary fa-2x"></i>
                <h5 class="mt-2 mb-0">Ice Cream Store</h5>
                <small class="text-muted">Management Dashboard</small>
            </div>
            
            <!-- Navigation -->
            <nav class="sidebar-nav">
                <h6 class="nav-section-title">
                    <i class="fas fa-layer-group me-2"></i>Services
                </h6>
                
                <ul class="nav nav-pills flex-column">
                    <li class="nav-item">
                        <button class="nav-link active" onclick="loadContent('dashboard')" data-page="dashboard">
                            <i class="fas fa-home me-2"></i>
                            Dashboard
                        </button>
                    </li>
                    
                    <li class="nav-item">
                        <button class="nav-link" onclick="loadContent('orders')" data-page="orders">
                            <i class="fas fa-shopping-cart me-2"></i>
                            Orders
                        </button>
                    </li>
                    
                    <li class="nav-item">
                        <button class="nav-link" onclick="toggleSubmenu('inventory')" data-page="inventory">
                            <i class="fas fa-warehouse me-2"></i>
                            Inventory
                            <i class="fas fa-chevron-down ms-auto"></i>
                        </button>
                        <ul class="nav flex-column ms-3" id="inventory-submenu" style="display: none;">
                            <li class="nav-item">
                                <button class="nav-link nav-sub" onclick="loadContent('inventory')" data-page="inventory">
                                    <i class="fas fa-chart-bar me-2"></i>Overview
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link nav-sub" onclick="loadContent('inventory-suppliers')" data-page="inventory-suppliers">
                                    <i class="fas fa-truck me-2"></i>Suppliers
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link nav-sub" onclick="loadContent('inventory-ingredients')" data-page="inventory-ingredients">
                                    <i class="fas fa-seedling me-2"></i>Ingredients
                                </button>
                            </li>
                        </ul>
                    </li>
                    
                    <li class="nav-item">
                        <button class="nav-link" onclick="toggleSubmenu('invoice')" data-page="invoice">
                            <i class="fas fa-file-invoice me-2"></i>
                            Invoice
                            <i class="fas fa-chevron-down ms-auto"></i>
                        </button>
                        <ul class="nav flex-column ms-3" id="invoice-submenu" style="display: none;">
                            <li class="nav-item">
                                <button class="nav-link nav-sub" onclick="loadContent('invoice')" data-page="invoice">
                                    <i class="fas fa-chart-pie me-2"></i>Overview
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link nav-sub" onclick="loadContent('invoice-details')" data-page="invoice-details">
                                    <i class="fas fa-file-invoice me-2"></i>Details
                                </button>
                            </li>
                        </ul>
                    </li>
                </ul>
            </nav>
            
            <!-- User Section -->
            <div class="sidebar-footer" style="padding: 1.5rem; border-top: 1px solid var(--border-color); margin-top: auto;">
                <div class="user-info d-flex align-items-center mb-3">
                    <i class="fas fa-user-circle fa-2x text-primary me-2"></i>
                    <div>
                        <div class="fw-bold" id="user-name">Loading...</div>
                        <small class="text-muted">Administrator</small>
                    </div>
                </div>
                <button class="btn btn-outline-danger btn-sm w-100" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                </button>
            </div>
        </div>
        
        <!-- Mobile sidebar overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
        
        <!-- Main Content Area -->
        <div class="dashboard-main">
            <!-- Header -->
            <div class="dashboard-header">
                <div class="d-flex align-items-center">
                    <button class="btn btn-outline-primary d-md-none me-3" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h4 class="mb-0" id="page-title">Dashboard</h4>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-success me-2" id="system-status">System Online</span>
                    <small class="text-muted" id="current-time"></small>
                </div>
            </div>
            
            <!-- Breadcrumb -->
            <div class="breadcrumb-container">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb" id="breadcrumb">
                        <li class="breadcrumb-item active">Dashboard</li>
                    </ol>
                </nav>
            </div>
            
            <!-- Content Area -->
            <div class="dashboard-content" id="main-content">
                <!-- Initial loading state -->
                <div class="content-loader">
                    <div class="loading-spinner"></div>
                    <span>Loading dashboard...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Configuration -->
    <script src="config.js?v=1.3"></script>
    
    <!-- Shared JavaScript -->
    <script src="shared/js/auth.js?v=1.3"></script>
    <script src="shared/js/alerts.js?v=1.3"></script>
    
    <script>
        let currentPage = 'dashboard';
        let auth = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Initializing SPA Dashboard...');
            
            // Initialize authentication
            auth = new AuthService();
            if (!auth.isAuthenticated()) {
                console.log('❌ User not authenticated, redirecting to login');
                window.location.href = 'login.html';
                return;
            }
            
            // Load user info
            loadUserInfo();
            
            // Start time display
            updateTime();
            setInterval(updateTime, 1000);
            
            // Load initial dashboard content
            await loadContent('dashboard');
            
            console.log('✅ SPA Dashboard initialized successfully');
        });

        // Content loading function
        async function loadContent(page) {
            console.log('📄 Loading content:', page);
            
            try {
                // Show loading state
                showLoading();
                
                // Update navigation state
                updateActiveNavigation(page);
                
                // Update page title and breadcrumb
                updatePageInfo(page);
                
                // Load content based on page
                const contentUrl = getContentUrl(page);
                const response = await fetch(contentUrl);
                
                if (!response.ok) {
                    throw new Error(`Failed to load content: ${response.status}`);
                }
                
                const html = await response.text();
                document.getElementById('main-content').innerHTML = html;
                
                // Initialize page-specific functionality
                await initializePageContent(page);
                
                currentPage = page;
                
            } catch (error) {
                console.error('❌ Error loading content:', error);
                showError('Failed to load page content. Please try again.');
            }
        }

        // Get content URL for each page
        function getContentUrl(page) {
            const contentMap = {
                'dashboard': 'partials/dashboard-content.html',
                'orders': 'partials/orders-content.html',
                'inventory': 'partials/inventory-content.html',
                'inventory-suppliers': 'partials/inventory-suppliers-content.html',
                'inventory-ingredients': 'partials/inventory-ingredients-content.html',
                'invoice': 'partials/invoice-content.html',
                'invoice-details': 'partials/invoice-invoices-content.html'
            };
            
            return contentMap[page] || 'partials/dashboard-content.html';
        }

        // Initialize page-specific content
        async function initializePageContent(page) {
            const initMap = {
                'dashboard': 'initDashboardContent',
                'orders': 'initOrdersContent',
                'inventory': 'initInventoryContent',
                'inventory-suppliers': 'initSuppliersContent',
                'inventory-ingredients': 'initIngredientsContent',
                'invoice': 'initInvoiceContent',
                'invoice-details': 'initInvoiceDetailsContent'
            };
            
            const initFunction = initMap[page];
            if (initFunction && typeof window[initFunction] === 'function') {
                console.log('🔧 Initializing page:', initFunction);
                await window[initFunction]();
            }
        }

        // Update active navigation
        function updateActiveNavigation(page) {
            // Remove all active classes
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Add active class to current page
            const activeLink = document.querySelector(`[data-page="${page}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
        }

        // Update page title and breadcrumb
        function updatePageInfo(page) {
            const pageInfo = {
                'dashboard': { title: 'Dashboard', breadcrumb: ['Dashboard'] },
                'orders': { title: 'Orders Management', breadcrumb: ['Dashboard', 'Orders'] },
                'inventory': { title: 'Inventory Overview', breadcrumb: ['Dashboard', 'Inventory'] },
                'inventory-suppliers': { title: 'Suppliers Management', breadcrumb: ['Dashboard', 'Inventory', 'Suppliers'] },
                'inventory-ingredients': { title: 'Ingredients Management', breadcrumb: ['Dashboard', 'Inventory', 'Ingredients'] },
                'invoice': { title: 'Invoice Management', breadcrumb: ['Dashboard', 'Invoice'] },
                'invoice-details': { title: 'Invoice Details', breadcrumb: ['Dashboard', 'Invoice', 'Details'] }
            };
            
            const info = pageInfo[page] || pageInfo['dashboard'];
            
            // Update title
            document.getElementById('page-title').textContent = info.title;
            document.title = `Ice Cream Store - ${info.title}`;
            
            // Update breadcrumb
            const breadcrumb = document.getElementById('breadcrumb');
            breadcrumb.innerHTML = info.breadcrumb.map((item, index) => {
                const isLast = index === info.breadcrumb.length - 1;
                return isLast 
                    ? `<li class="breadcrumb-item active">${item}</li>`
                    : `<li class="breadcrumb-item"><a href="#" class="text-decoration-none">${item}</a></li>`;
            }).join('');
        }

        // Toggle submenu
        function toggleSubmenu(menuId) {
            const submenu = document.getElementById(menuId + '-submenu');
            if (submenu) {
                submenu.style.display = submenu.style.display === 'none' ? 'block' : 'none';
            }
        }

        // Show loading state
        function showLoading() {
            document.getElementById('main-content').innerHTML = `
                <div class="content-loader">
                    <div class="loading-spinner"></div>
                    <span>Loading content...</span>
                </div>
            `;
        }

        // Show error state
        function showError(message) {
            document.getElementById('main-content').innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-4x text-danger mb-3"></i>
                    <h3>Error Loading Content</h3>
                    <p class="text-muted mb-4">${message}</p>
                    <button class="btn btn-primary" onclick="loadContent('${currentPage}')">
                        <i class="fas fa-refresh me-2"></i>Retry
                    </button>
                </div>
            `;
        }

        // Load user info
        function loadUserInfo() {
            try {
                const userInfo = auth.getCurrentUser();
                if (userInfo) {
                    document.getElementById('user-name').textContent = userInfo.username || 'User';
                }
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        // Update time display
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleTimeString();
        }

        // Toggle mobile sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('dashboardSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                auth.logout();
                window.location.href = 'login.html';
            }
        }

        // Global navigation function for content partials
        window.navigateToRoute = function(route) {
            loadContent(route);
        };
    </script>
</body>
</html> 