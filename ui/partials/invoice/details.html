<!-- Invoice Details Content -->
<style>
    /* Invoice details specific styles */

    .search-filters {
        background: var(--white);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-light);
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .invoices-table {
        background: var(--white);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-light);
        overflow: hidden;
    }

    .table-header {
        background: var(--primary-color);
        color: var(--white);
        padding: 1.5rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .btn-add-invoice {
        background: var(--white);
        color: var(--primary-color);
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: var(--border-radius);
        font-weight: 600;
        transition: var(--transition);
    }

    .btn-add-invoice:hover {
        background: var(--primary-light);
        transform: translateY(-2px);
    }

    .loading-table {
        text-align: center;
        padding: 3rem 2rem;
        color: var(--secondary-color);
    }

    .loading-spinner {
        border: 3px solid var(--border-color);
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .transaction-type-badge {
        padding: 0.375rem 0.75rem;
        border-radius: var(--border-radius);
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .transaction-income {
        background: var(--success-light);
        color: var(--success-color);
    }

    .transaction-outcome {
        background: var(--danger-light);
        color: var(--danger-color);
    }

    .invoice-details-card {
        background: var(--white);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-light);
        margin-bottom: 2rem;
    }

    .invoice-header-section {
        background: var(--primary-color);
        color: var(--white);
        padding: 2rem;
        border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
    }

    .invoice-details-section {
        padding: 2rem;
    }

    .detail-item {
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 1rem;
        margin-bottom: 1rem;
        background: var(--light-color);
    }

    .detail-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .detail-item-name {
        font-weight: 600;
        color: var(--primary-color);
    }

    .detail-item-total {
        font-weight: 700;
        color: var(--success-color);
    }

    .detail-item-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        font-size: 0.9rem;
        color: var(--secondary-color);
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
        .invoice-header-section {
            padding: 1.5rem;
        }

        .invoice-details-section {
            padding: 1.5rem;
        }

        .detail-item-info {
            grid-template-columns: 1fr;
        }
    }
</style>

<!-- Invoice Details Content -->
<div id="invoiceDetailsContent">
    <div class="text-center py-5">
        <div class="loading-spinner"></div>
        <p>Loading invoice details...</p>
    </div>
</div>

<script>
    // Invoice details functionality
    let currentInvoice = null;

    // Initialize invoice details
    window.initInvoiceDetailsContent = async function() {
        console.log('üí∞ Initializing Invoice Details Content...');
        
        try {
            // Get invoice ID from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const invoiceId = urlParams.get('id');
            
            if (invoiceId) {
                await loadInvoiceDetails(invoiceId);
            } else {
                showError('No invoice ID provided');
            }
            
            console.log('‚úÖ Invoice Details Content initialized successfully');
        } catch (error) {
            console.error('‚ùå Error initializing invoice details content:', error);
            showError('Failed to load invoice details');
        }
    };

    // Load invoice details
    async function loadInvoiceDetails(invoiceId) {
        try {
            const response = await fetch(`/api/v1/invoices/${invoiceId}`, {
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    currentInvoice = data.data;
                    displayInvoiceDetails(currentInvoice);
                } else {
                    showError(data.message || 'Failed to load invoice details');
                }
            } else {
                showError('Failed to load invoice details');
            }
        } catch (error) {
            console.error('Error loading invoice details:', error);
            showError('Failed to load invoice details');
        }
    }

    // Display invoice details
    function displayInvoiceDetails(invoice) {
        const container = document.getElementById('invoiceDetailsContent');
        
        const detailsHTML = `
            <div class="invoice-details-card">
                <div class="invoice-header-section">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2 class="mb-2">Invoice #${invoice.invoice_number}</h2>
                            <p class="mb-0">Transaction Date: ${formatDate(invoice.transaction_date)}</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="mb-2">
                                <span class="transaction-type-badge ${invoice.transaction_type === 'income' ? 'transaction-income' : 'transaction-outcome'}">
                                    ${invoice.transaction_type}
                                </span>
                            </div>
                            <h3 class="mb-0">$${invoice.total_amount || 0}</h3>
                        </div>
                    </div>
                </div>
                
                <div class="invoice-details-section">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>Invoice Information</h5>
                            <div class="mb-2">
                                <strong>Invoice Number:</strong> ${invoice.invoice_number}
                            </div>
                            <div class="mb-2">
                                <strong>Transaction Date:</strong> ${formatDateTime(invoice.transaction_date)}
                            </div>
                            <div class="mb-2">
                                <strong>Transaction Type:</strong> ${invoice.transaction_type}
                            </div>
                            <div class="mb-2">
                                <strong>Expense Category ID:</strong> ${invoice.expense_category_id}
                            </div>
                            ${invoice.supplier_id ? `<div class="mb-2"><strong>Supplier ID:</strong> ${invoice.supplier_id}</div>` : ''}
                        </div>
                        <div class="col-md-6">
                            <h5>Additional Information</h5>
                            <div class="mb-2">
                                <strong>Image URL:</strong> 
                                <a href="${invoice.image_url}" target="_blank">View Image</a>
                            </div>
                            ${invoice.notes ? `<div class="mb-2"><strong>Notes:</strong> ${invoice.notes}</div>` : ''}
                            <div class="mb-2">
                                <strong>Created:</strong> ${formatDateTime(invoice.created_at)}
                            </div>
                            <div class="mb-2">
                                <strong>Updated:</strong> ${formatDateTime(invoice.updated_at)}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <h5>Invoice Items</h5>
                            <div id="invoiceItemsContainer">
                                <div class="text-center py-3">
                                    <p class="text-muted">Loading invoice items...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.innerHTML = detailsHTML;
        
        // Load invoice items (details)
        loadInvoiceItems(invoice.id);
    }

    // Load invoice items
    async function loadInvoiceItems(invoiceId) {
        try {
            const response = await fetch(`/api/v1/invoices/${invoiceId}/details`, {
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    displayInvoiceItems(data.data);
                } else {
                    showInvoiceItemsError(data.message || 'Failed to load invoice items');
                }
            } else {
                showInvoiceItemsError('Failed to load invoice items');
            }
        } catch (error) {
            console.error('Error loading invoice items:', error);
            showInvoiceItemsError('Failed to load invoice items');
        }
    }

    // Display invoice items
    function displayInvoiceItems(items) {
        const container = document.getElementById('invoiceItemsContainer');
        
        if (!items || items.length === 0) {
            container.innerHTML = `
                <div class="text-center py-3">
                    <p class="text-muted">No items found for this invoice</p>
                </div>
            `;
            return;
        }

        const itemsHTML = items.map(item => `
            <div class="detail-item">
                <div class="detail-item-header">
                    <div class="detail-item-name">${item.detail}</div>
                    <div class="detail-item-total">$${item.total}</div>
                </div>
                <div class="detail-item-info">
                    <div>
                        <strong>Count:</strong> ${item.count} ${item.unit_type}
                    </div>
                    <div>
                        <strong>Price:</strong> $${item.price}
                    </div>
                    ${item.ingredient_id ? `<div><strong>Ingredient ID:</strong> ${item.ingredient_id}</div>` : ''}
                    ${item.expiration_date ? `<div><strong>Expiration:</strong> ${formatDate(item.expiration_date)}</div>` : ''}
                    <div>
                        <strong>Created:</strong> ${formatDateTime(item.created_at)}
                    </div>
                </div>
            </div>
        `).join('');

        container.innerHTML = itemsHTML;
    }

    // Show error for invoice items
    function showInvoiceItemsError(message) {
        const container = document.getElementById('invoiceItemsContainer');
        container.innerHTML = `
            <div class="text-center py-3">
                <p class="text-danger">${message}</p>
            </div>
        `;
    }

    // Show error
    function showError(message) {
        const container = document.getElementById('invoiceDetailsContent');
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                <h5>Error</h5>
                <p class="text-muted">${message}</p>
                <button class="btn btn-primary" onclick="window.history.back()">
                    <i class="fas fa-arrow-left me-2"></i>
                    Go Back
                </button>
            </div>
        `;
    }

    // Utility functions
    function formatDate(dateString) {
        return new Date(dateString).toLocaleDateString();
    }

    function formatDateTime(dateString) {
        return new Date(dateString).toLocaleString();
    }
</script> 