<!-- Dashboard Content - Clean Services View -->
<style>
    /* Clean Services Dashboard Styles */
    .services-dashboard {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        margin: 1rem 0;
        border: 1px solid #e9ecef;
    }

        .dashboard-header {
        text-align: center;
        margin-bottom: 1rem;
        border-bottom: 1px solid #f8f9fa;
        padding-bottom: 0.5rem;
    }

    .dashboard-header h2 {
        color: var(--primary-color);
        font-weight: 600;
        margin-bottom: 0.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }

    .dashboard-header p {
        color: var(--text-muted);
        font-size: 0.9rem;
        margin: 0;
    }

    /* Service Tiers */
    .service-tier {
        display: flex;
        justify-content: center;
        margin: 0.5rem 0;
    }

    /* Service Cards */
    .service-card {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 0.75rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        box-shadow: 0 1px 5px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        min-height: 100px;
    }

    .service-main {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex: 1;
    }

    .service-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        border-color: var(--primary-color);
    }

    /* Service Card Types */
    .ui-card {
        border-color: #28a745;
        background: linear-gradient(135deg, #f8fff9 0%, #ffffff 100%);
        width: fit-content;
    }

    .gateway-card {
        border-color: var(--primary-color);
        background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
        width: fit-content;
    }

    .data-card {
        border-color: #6f42c1;
        background: linear-gradient(135deg, #faf8ff 0%, #ffffff 100%);
        width: fit-content;
    }

    .small-card {
        width: fit-content;
        padding: 0.75rem;
        margin: 0.25rem;
    }

    /* Services Grid */
    .services-grid {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
        width: 100%;
        max-width: 800px;
    }

    /* Service Icons */
    .service-icon {
        font-size: 1.5rem;
        color: var(--primary-color);
        min-width: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .ui-card .service-icon { color: #28a745; }
    .gateway-card .service-icon { color: var(--primary-color); }
    .data-card .service-icon { color: #6f42c1; }

    /* Service Content */
    .service-content {
        flex: 1;
    }

    .service-content h4 {
        font-weight: 600;
        color: var(--dark-color);
        margin: 0 0 0.25rem 0;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
    }

    .service-content h5 {
        font-weight: 600;
        color: var(--dark-color);
        margin: 0 0 0.25rem 0;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
    }

    /* Animated Connection Status Indicators */
    .service-status {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        position: relative;
        margin-left: 0.5rem;
    }

    .connection-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        position: relative;
        display: inline-block;
        margin-right: 0.25rem;
    }

    .connection-indicator::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        opacity: 0.3;
    }

    .connection-indicator::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        opacity: 0.3;
    }

    /* Animations moved to dashboard.html for global availability */
    
    /* Service card connection indicators - enhanced colors to match header */
    .service-status.online .connection-indicator {
        background: #00d851; /* Vibrant green to match header */
        box-shadow: 0 0 8px rgba(0, 216, 81, 0.5);
        animation: connectionOnline 2s ease-in-out infinite;
    }
    
    .service-status.online .connection-indicator::before {
        background: #00d851;
        animation: connectionPulse 2s ease-in-out infinite;
    }
    
    .service-status.offline .connection-indicator {
        background: #ff1744; /* Vibrant red to match header */
        box-shadow: 0 0 12px rgba(255, 23, 68, 0.6); /* Match header exactly */
        animation: connectionOnline 2s ease-in-out infinite; /* Use same working keyframes as green */
    }
    
    .service-status.offline .connection-indicator::before {
        background: #ff1744;
        animation: connectionPulse 2s ease-in-out infinite; /* Use same working keyframes as green */
    }
    
    .service-status.degraded .connection-indicator {
        background: #ff9500; /* Vibrant orange to match header */
        box-shadow: 0 0 12px rgba(255, 149, 0, 0.6); /* Match header exactly */
        animation: connectionOnline 2s ease-in-out infinite; /* Use same working keyframes as green */
    }
    
    .service-status.degraded .connection-indicator::before {
        background: #ff9500;
        animation: connectionPulse 2s ease-in-out infinite; /* Use same working keyframes as green */
    }
    
    .service-status.checking .connection-indicator {
        background: #ff9500; /* Vibrant orange to match header */
        box-shadow: 0 0 12px rgba(255, 149, 0, 0.6); /* Match header exactly */
        animation: connectionOnline 1.5s ease-in-out infinite; /* Use same working keyframes, slightly faster */
    }
    
    .service-status.checking .connection-indicator::before {
        background: #ff9500;
        animation: connectionPulse 1.5s ease-in-out infinite; /* Use same working keyframes, slightly faster */
    }

    /* Connection Status Text */
    .connection-text {
        font-size: 0.65rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-left: 0.25rem;
    }

    .service-status.online .connection-text {
        color: #28a745;
    }

    .service-status.checking .connection-text {
        color: #ffc107;
    }

    .service-status.offline .connection-text {
        color: #dc3545;
    }

    .service-status.degraded .connection-text {
        color: #fd7e14;
    }

    /* Service Actions */
    .service-actions {
        display: flex;
        gap: 0.25rem;
        justify-content: center;
        padding-top: 0.25rem;
        border-top: 1px solid #f0f0f0;
        margin-top: auto;
        opacity: 0;
        transform: translateY(5px);
        transition: all 0.3s ease;
    }

    .service-card:hover .service-actions {
        opacity: 1;
        transform: translateY(0);
    }

    /* Keep actions visible when any button is in processing state */
    .service-actions:has(.action-btn.loading),
    .service-actions:has(.action-btn.success),
    .service-actions:has(.action-btn.error),
    .service-card.has-active-operations .service-actions {
        opacity: 1;
        transform: translateY(0);
    }

    .action-btn {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 0.25rem;
        cursor: pointer;
        transition: all 0.2s ease;
        backdrop-filter: blur(10px);
        min-width: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        font-weight: 600;
        font-size: 0.75rem;
    }

    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .start-btn {
        color: #28a745;
        border-color: rgba(40, 167, 69, 0.3);
    }

    .start-btn:hover {
        background: #28a745 !important;
        color: white !important;
    }

    .action-btn.start-btn:hover .fas,
    .action-btn.start-btn:hover i,
    .start-btn:hover .fas,
    .start-btn:hover i {
        color: white !important;
    }

    .stop-btn {
        color: #dc3545;
        border-color: rgba(220, 53, 69, 0.3);
    }

    .stop-btn:hover {
        background: #dc3545 !important;
        color: white !important;
    }

    .action-btn.stop-btn:hover .fas,
    .action-btn.stop-btn:hover i,
    .stop-btn:hover .fas,
    .stop-btn:hover i {
        color: white !important;
    }

    .restart-btn {
        color: #ffc107;
        border-color: rgba(255, 193, 7, 0.3);
    }

    .restart-btn:hover {
        background: #ffc107 !important;
        color: white !important;
    }

    .action-btn.restart-btn:hover .fas,
    .action-btn.restart-btn:hover i,
    .restart-btn:hover .fas,
    .restart-btn:hover i {
        color: white !important;
    }

    /* Disabled Button Styles */
    .action-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        background: rgba(255, 255, 255, 0.5) !important;
        color: #6c757d !important;
        border-color: rgba(222, 226, 230, 0.5) !important;
        transform: none !important;
        box-shadow: none !important;
    }

    .action-btn:disabled:hover {
        transform: none !important;
        box-shadow: none !important;
        background: rgba(255, 255, 255, 0.5) !important;
        color: #6c757d !important;
    }

    .action-btn:disabled .fas,
    .action-btn:disabled i {
        color: #6c757d !important;
    }

    /* Loading Button States */
    .action-btn.loading {
        position: relative;
        opacity: 0.8;
        cursor: wait;
        pointer-events: none;
        background: rgba(255, 255, 255, 0.95) !important;
        color: #6c757d !important;
        border-color: rgba(52, 152, 219, 0.5) !important;
        box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2) !important;
        animation: pulse-border 1.5s infinite;
    }

    .action-btn.loading:hover {
        transform: none !important;
    }

    /* Loading spinner overlay */
    .action-btn.loading::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 12px;
        height: 12px;
        margin: -6px 0 0 -6px;
        border: 2px solid transparent;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        z-index: 2;
    }

    /* Hide original icon when loading */
    .action-btn.loading .fas,
    .action-btn.loading i {
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    /* Success animation */
    .action-btn.success {
        background: #28a745 !important;
        color: white !important;
        border-color: #28a745 !important;
        animation: success-flash 0.6s ease;
    }

    .action-btn.success .fas,
    .action-btn.success i {
        color: white !important;
    }

    /* Error animation */
    .action-btn.error {
        background: #dc3545 !important;
        color: white !important;
        border-color: #dc3545 !important;
        animation: error-shake 0.6s ease;
    }

    .action-btn.error .fas,
    .action-btn.error i {
        color: white !important;
    }

    /* Keyframe animations */
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes pulse-border {
        0% {
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        50% {
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.1);
        }
        100% {
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
    }

    @keyframes success-flash {
        0% {
            transform: scale(1);
            background: #28a745;
        }
        50% {
            transform: scale(1.1);
            background: #20c997;
            box-shadow: 0 0 20px rgba(40, 167, 69, 0.5);
        }
        100% {
            transform: scale(1);
            background: #28a745;
        }
    }

    @keyframes error-shake {
        0%, 100% {
            transform: translateX(0);
        }
        10%, 30%, 50%, 70%, 90% {
            transform: translateX(-2px);
        }
        20%, 40%, 60%, 80% {
            transform: translateX(2px);
        }
    }

    /* Enhanced button responsiveness */
    .action-btn {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .action-btn:not(.loading):not(:disabled):active {
        transform: scale(0.95);
        transition: transform 0.1s ease;
    }

    /* Connection Lines */
    .service-connection {
        display: flex;
        justify-content: center;
        margin: 0.5rem 0;
    }

    .connection-line {
        width: 2px;
        height: 30px;
        background: linear-gradient(to bottom, #dee2e6, #adb5bd, #dee2e6);
        border-radius: 1px;
        position: relative;
    }

    .connection-line::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 8px;
        height: 8px;
        background: #adb5bd;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Status icons when inline with titles */
    h4 .service-status, h5 .service-status {
        display: inline-block;
        margin-left: 8px;
        vertical-align: baseline;
        font-size: 0.8em;
    }



    .connection-line.healthy {
        background: linear-gradient(to bottom, #28a745, #20c997, #28a745);
    }

    .connection-line.degraded {
        background: linear-gradient(to bottom, #ffc107, #ffcd39, #ffc107);
    }

    .connection-line.offline {
        background: linear-gradient(to bottom, #dc3545, #e85d75, #dc3545);
    }

        /* Mobile Responsiveness */
    @media (max-width: 768px) {
        .services-dashboard {
            padding: 1rem;
        }

        .services-grid {
            flex-direction: column;
            align-items: center;
        }

        .service-card {
            width: 100%;
            min-height: 160px;
        }

        .small-card {
            width: 100%;
            margin: 0.25rem 0;
        }

        .service-main {
            flex-direction: column;
            text-align: center;
            gap: 0.5rem;
        }

        .action-btn {
            min-width: 35px;
            padding: 0.4rem;
        }
    }
</style>

<!-- Clean Vertical Services Dashboard -->
<div class="services-dashboard">
    <div class="dashboard-header">
        <h2>
            <i class="fas fa-sitemap me-2"></i>System Architecture
        </h2>
        <p class="text-muted">Ice Cream Store Management System</p>
    </div>
    
    <!-- UI Layer -->
    <div class="service-tier">
        <div class="service-card ui-card">
            <div class="service-icon">
                <i class="fas fa-desktop"></i>
            </div>
            <div class="service-content">
                <h4>
                    User Interface
                    <div class="service-status online" id="ui-status">
                        <div class="connection-indicator"></div>
                        <span class="connection-text">Online</span>
                    </div>
                </h4>
            </div>
        </div>
    </div>

    <!-- Connection -->
    <div class="service-connection">
        <div class="connection-line"></div>
    </div>

    <!-- Gateway Layer -->
    <div class="service-tier">
        <div class="service-card gateway-card" data-service="gateway-service" oncontextmenu="showServiceContextMenu(event, 'gateway-service')">
            <div class="service-main">
                <div class="service-icon">
                    <i class="fas fa-network-wired"></i>
                </div>
                <div class="service-content">
                    <h4>
                        API Gateway
                        <div class="service-status checking" id="gateway-status">
                            <div class="connection-indicator"></div>
                            <span class="connection-text">Checking</span>
                        </div>
                    </h4>
                </div>
            </div>
            <div class="service-actions">
                <button class="action-btn start-btn" onclick="manageService('gateway-service', 'start')" title="Start Gateway" disabled>
                    <i class="fas fa-play"></i>
                </button>
                <button class="action-btn stop-btn" onclick="manageService('gateway-service', 'stop')" title="Stop Gateway" disabled>
                    <i class="fas fa-stop"></i>
                </button>
                <button class="action-btn restart-btn" onclick="manageService('gateway-service', 'restart')" title="Restart Gateway" disabled>
                    <i class="fas fa-sync"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Connection -->
    <div class="service-connection">
        <div class="connection-line"></div>
    </div>

    <!-- Business Services -->
    <div class="service-tier">
        <div class="services-grid">
            <!-- Session Service -->
            <div class="service-card small-card" data-service="session-service" oncontextmenu="showServiceContextMenu(event, 'session-service')">
                <div class="service-main">
                    <div class="service-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="service-content">
                        <h5>
                            Session
                            <div class="service-status checking" id="session-status">
                                <div class="connection-indicator"></div>
                                <span class="connection-text">Checking</span>
                            </div>
                        </h5>
                    </div>
                </div>
                <div class="service-actions">
                    <button class="action-btn start-btn" onclick="manageService('session-service', 'start', this)" title="Start Session" disabled>
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="action-btn stop-btn" onclick="manageService('session-service', 'stop', this)" title="Stop Session" disabled>
                        <i class="fas fa-stop"></i>
                    </button>
                    <button class="action-btn restart-btn" onclick="manageService('session-service', 'restart', this)" title="Restart Session" disabled>
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
            </div>

            <!-- Orders Service -->
            <div class="service-card small-card" data-service="orders-service" oncontextmenu="showServiceContextMenu(event, 'orders-service')">
                <div class="service-main">
                    <div class="service-icon">
                        <i class="fas fa-ice-cream"></i>
                    </div>
                    <div class="service-content">
                        <h5>
                            Orders
                            <div class="service-status checking" id="orders-status">
                                <div class="connection-indicator"></div>
                                <span class="connection-text">Checking</span>
                            </div>
                        </h5>
                    </div>
                </div>
                <div class="service-actions">
                    <button class="action-btn start-btn" onclick="manageService('orders-service', 'start', this)" title="Start Orders" disabled>
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="action-btn stop-btn" onclick="manageService('orders-service', 'stop', this)" title="Stop Orders" disabled>
                        <i class="fas fa-stop"></i>
                    </button>
                    <button class="action-btn restart-btn" onclick="manageService('orders-service', 'restart', this)" title="Restart Orders" disabled>
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
            </div>

            <!-- Inventory Service -->
            <div class="service-card small-card" data-service="inventory-service" oncontextmenu="showServiceContextMenu(event, 'inventory-service')">
                <div class="service-main">
                    <div class="service-icon">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div class="service-content">
                        <h5>
                            Inventory
                            <div class="service-status checking" id="inventory-status">
                                <div class="connection-indicator"></div>
                                <span class="connection-text">Checking</span>
                            </div>
                        </h5>
                    </div>
                </div>
                <div class="service-actions">
                    <button class="action-btn start-btn" onclick="manageService('inventory-service', 'start', this)" title="Start Inventory" disabled>
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="action-btn stop-btn" onclick="manageService('inventory-service', 'stop', this)" title="Stop Inventory" disabled>
                        <i class="fas fa-stop"></i>
                    </button>
                    <button class="action-btn restart-btn" onclick="manageService('inventory-service', 'restart', this)" title="Restart Inventory" disabled>
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
            </div>

            <!-- Invoice Service -->
            <div class="service-card small-card" data-service="invoice-service" oncontextmenu="showServiceContextMenu(event, 'invoice-service')">
                <div class="service-main">
                    <div class="service-icon">
                        <i class="fas fa-receipt"></i>
                    </div>
                    <div class="service-content">
                        <h5>
                            Invoice
                            <div class="service-status checking" id="invoice-status">
                                <div class="connection-indicator"></div>
                                <span class="connection-text">Checking</span>
                            </div>
                        </h5>
                    </div>
                </div>
                <div class="service-actions">
                    <button class="action-btn start-btn" onclick="manageService('invoice-service', 'start', this)" title="Start Invoice" disabled>
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="action-btn stop-btn" onclick="manageService('invoice-service', 'stop', this)" title="Stop Invoice" disabled>
                        <i class="fas fa-stop"></i>
                    </button>
                    <button class="action-btn restart-btn" onclick="manageService('invoice-service', 'restart', this)" title="Restart Invoice" disabled>
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Connection -->
    <div class="service-connection">
        <div class="connection-line"></div>
    </div>

    <!-- Database Layer -->
    <div class="service-tier">
        <div class="service-card data-card" data-service="data-service" oncontextmenu="showServiceContextMenu(event, 'data-service')">
            <div class="service-main">
                <div class="service-icon">
                    <i class="fas fa-database"></i>
                </div>
                <div class="service-content">
                    <h4>
                        PostgreSQL Database
                        <div class="service-status checking" id="data-status">
                            <div class="connection-indicator"></div>
                            <span class="connection-text">Checking</span>
                        </div>
                    </h4>
                </div>
            </div>
            <div class="service-actions">
                <button class="action-btn start-btn" onclick="manageService('data-service', 'start', this)" title="Start Database" disabled>
                    <i class="fas fa-play"></i>
                </button>
                <button class="action-btn stop-btn" onclick="manageService('data-service', 'stop', this)" title="Stop Database" disabled>
                    <i class="fas fa-stop"></i>
                </button>
                <button class="action-btn restart-btn" onclick="manageService('data-service', 'restart', this)" title="Restart Database" disabled>
                    <i class="fas fa-sync"></i>
                </button>
            </div>
        </div>
    </div>
</div>

 <!-- Context Menu -->
 <div id="serviceContextMenu" class="service-context-menu">
     <div class="context-menu-header" id="contextMenuHeader">Service Management</div>
     <div class="context-menu-item" id="contextMenuStart" onclick="contextMenuAction('start')">
         <i class="fas fa-play"></i>Start Service
     </div>
     <div class="context-menu-item" id="contextMenuStop" onclick="contextMenuAction('stop')">
         <i class="fas fa-stop"></i>Stop Service
     </div>
     <div class="context-menu-item" id="contextMenuRestart" onclick="contextMenuAction('restart')">
         <i class="fas fa-sync"></i>Restart Service
     </div>
     <div class="context-menu-item" onclick="setServiceEnvironment('locally')">
         <i class="fas fa-laptop"></i>Set Environment: Local
     </div>
     <div class="context-menu-item" onclick="setServiceEnvironment('container')">
         <i class="fas fa-docker"></i>Set Environment: Container
    </div>
</div>

<script>
    // Update architecture diagram status indicators
    function updateArchitectureStatus(servicesStatus, overallStatus = 'healthy') {
        const archMapping = {
            'data-service': 'data-arch',
            'gateway-service': 'gateway-arch', 
            'session-service': 'session-arch',
            'orders-service': 'orders-arch',
            'inventory-service': 'inventory-arch',
            'invoice-service': 'invoice-arch'
        };
        
        for (const [gatewayServiceName, archId] of Object.entries(archMapping)) {
            const statusElement = document.getElementById(`${archId}-status`);
            if (!statusElement) continue;
            
            const serviceStatus = servicesStatus[gatewayServiceName];
            
            // Special handling for gateway service
            if (archId === 'gateway-arch') {
                if (overallStatus === 'healthy') {
                    statusElement.className = 'node-status status-online';
                    statusElement.innerHTML = '<i class="fas fa-check-circle me-1"></i>Online';
                } else if (overallStatus === 'degraded') {
                    statusElement.className = 'node-status status-warning';
                    statusElement.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Degraded';
                } else {
                    statusElement.className = 'node-status status-offline';
                    statusElement.innerHTML = '<i class="fas fa-times-circle me-1"></i>Offline';
                }
            } else {
                // For all other services
                if (serviceStatus === 'healthy') {
                    statusElement.className = 'node-status status-online';
                    statusElement.innerHTML = '<i class="fas fa-check-circle me-1"></i>Online';
                } else if (serviceStatus === 'unhealthy') {
                    statusElement.className = 'node-status status-offline';
                    statusElement.innerHTML = '<i class="fas fa-times-circle me-1"></i>Offline';
                } else {
                    statusElement.className = 'node-status status-loading';
                    statusElement.innerHTML = '<i class="fas fa-question-circle me-1"></i>Unknown';
                }
            }
        }
    }

         // Mark all architecture nodes as offline
     function markAllArchitectureOffline() {
         const archIds = ['data-arch', 'gateway-arch', 'session-arch', 'orders-arch', 'inventory-arch', 'invoice-arch'];
         
         archIds.forEach(archId => {
             const statusElement = document.getElementById(`${archId}-status`);
             if (statusElement) {
                 statusElement.className = 'node-status-compact status-offline';
                 statusElement.innerHTML = '<i class="fas fa-times-circle me-1"></i>Offline';
             }
         });
         
         // Also update visual node states
         const allOfflineStatus = {
             'data-service': 'unhealthy',
             'gateway-service': 'unhealthy',
             'session-service': 'unhealthy',
             'orders-service': 'unhealthy',
             'inventory-service': 'unhealthy',
             'invoice-service': 'unhealthy'
         };
         updateArchitectureNodeStates(allOfflineStatus);
         
         // Update all connection lines and dots to offline
         const connectionLines = document.querySelectorAll('.connection-line');
         connectionLines.forEach(line => {
             line.className = 'connection-line offline';
         });
         
         const connectionDots = document.querySelectorAll('.connection-dot');
         connectionDots.forEach(dot => {
             dot.className = 'connection-dot offline';
         });
         
         // Update all buttons to offline state
         const services = ['gateway-service', 'session-service', 'orders-service', 'inventory-service', 'invoice-service', 'data-service'];
         services.forEach(serviceName => {
             updateArchitectureServiceButtons(serviceName, 'unhealthy');
         });
     }

         // Context menu functionality
     let currentContextService = null;

     function showServiceContextMenu(event, serviceName) {
         event.preventDefault();
         event.stopPropagation();
         
         currentContextService = serviceName;
         
         const contextMenu = document.getElementById('serviceContextMenu');
         const header = document.getElementById('contextMenuHeader');
         
         // Update header
         header.textContent = `${serviceName.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())} Management`;
         
         // Position menu at cursor
         contextMenu.style.left = event.pageX + 'px';
         contextMenu.style.top = event.pageY + 'px';
         contextMenu.style.display = 'block';
         
         // Update button states based on service status
         updateContextMenuButtons(serviceName);
         
         // Hide menu when clicking elsewhere
         setTimeout(() => {
             document.addEventListener('click', hideContextMenu, { once: true });
         }, 10);
         
         return false;
     }

     function hideContextMenu() {
         const contextMenu = document.getElementById('serviceContextMenu');
         contextMenu.style.display = 'none';
         currentContextService = null;
     }

         function contextMenuAction(action) {
        if (currentContextService && typeof window.manageService === 'function') {
            // Find the context menu button that was clicked for visual feedback
            const contextButton = event ? event.target.closest('.context-menu-item') : null;
            window.manageService(currentContextService, action, contextButton);
        }
        hideContextMenu();
    }

     function updateContextMenuButtons(serviceName) {
         const startBtn = document.getElementById('contextMenuStart');
         const stopBtn = document.getElementById('contextMenuStop');
         const restartBtn = document.getElementById('contextMenuRestart');
         
         // Get current service status from the architecture status element
         const servicePrefix = serviceName.split('-')[0];
         const statusElement = document.getElementById(`${servicePrefix}-arch-status`);
         
         if (statusElement) {
             const isOnline = statusElement.className.includes('status-online');
             
             if (isOnline) {
                 // Service is online: disable start, enable stop and restart
                 startBtn.classList.add('disabled');
                 stopBtn.classList.remove('disabled');
                 restartBtn.classList.remove('disabled');
             } else {
                 // Service is offline: enable start, disable stop and restart
                 startBtn.classList.remove('disabled');
                 stopBtn.classList.add('disabled');
                 restartBtn.classList.add('disabled');
             }
         }
     }

     // Update architecture nodes visual state based on status
     function updateArchitectureNodeStates(servicesStatus) {
         const serviceMapping = {
             'data-service': 'data',
             'gateway-service': 'gateway', 
             'session-service': 'session',
             'orders-service': 'orders',
             'inventory-service': 'inventory',
             'invoice-service': 'invoice'
         };
         
         for (const [gatewayServiceName, servicePrefix] of Object.entries(serviceMapping)) {
             const node = document.querySelector(`[data-service="${gatewayServiceName}"]`);
             if (!node || !node.classList.contains('node-service')) continue;
             
             const serviceStatus = servicesStatus[gatewayServiceName];
             
             // Remove existing status classes
             node.classList.remove('online', 'offline', 'degraded');
             
             // Add appropriate status class
             if (serviceStatus === 'healthy') {
                 node.classList.add('online');
             } else if (serviceStatus === 'unhealthy') {
                 node.classList.add('offline');
             } else {
                 node.classList.add('degraded');
             }
         }
     }

     // Simple service status update function
     function updateArchitectureStatus(servicesStatus, overallStatus = 'healthy') {
         console.log('🔄 Updating services dashboard...', { servicesStatus, overallStatus });
         
         const serviceMapping = {
             'data-service': 'data-status',
             'gateway-service': 'gateway-status', 
             'session-service': 'session-status',
             'orders-service': 'orders-status',
             'inventory-service': 'inventory-status',
             'invoice-service': 'invoice-status'
         };
         
         for (const [serviceName, statusId] of Object.entries(serviceMapping)) {
             const statusElement = document.getElementById(statusId);
            if (!statusElement) continue;
            
                         const serviceStatus = servicesStatus[serviceName];
            
            // Special handling for gateway service - improved recovery logic
            let status;
            if (serviceName === 'gateway-service') {
                // Gateway status logic:
                // - Online: Gateway service healthy AND all business services healthy
                // - Degraded: Gateway service healthy BUT any business services down (recovery mode)
                // - Offline: Gateway service itself is down/unreachable
                
                const gatewayServiceHealthy = serviceStatus === 'healthy';
                
                if (!gatewayServiceHealthy) {
                    // Gateway service itself is down = offline (but buttons stay enabled for recovery)
                    status = 'unhealthy';
                    console.log('🚪 Gateway card: Service itself is down - showing offline');
                } else {
                    // Gateway service is healthy - check business services
                    let onlineBusinessServices = 0;
                    let totalBusinessServices = 0;
                    
                    // Count only business services (exclude gateway itself)
                    for (const [svcName, svcStatus] of Object.entries(servicesStatus)) {
                        if (svcName !== 'gateway-service') { // Don't count gateway itself
                            totalBusinessServices++;
                            if (svcStatus === 'healthy') {
                                onlineBusinessServices++;
                            }
                        }
                    }
                    
                    if (onlineBusinessServices === totalBusinessServices) {
                        status = 'healthy'; // Gateway healthy + all business services healthy = online
                    } else {
                        status = 'degraded'; // Gateway healthy but business services down = degraded (recovery mode)
                    }
                    
                    console.log(`🚪 Gateway card: Service healthy, business services ${onlineBusinessServices}/${totalBusinessServices} → ${status}`);
                }
            } else {
                status = serviceStatus;
            }
             
             if (status === 'healthy') {
                 statusElement.className = 'service-status online';
                 const textElement = statusElement.querySelector('.connection-text');
                 if (textElement) textElement.textContent = 'Online';
             } else if (status === 'degraded') {
                 statusElement.className = 'service-status degraded';
                 const textElement = statusElement.querySelector('.connection-text');
                 if (textElement) textElement.textContent = 'Degraded';
             } else if (status === 'unhealthy') {
                 statusElement.className = 'service-status offline';
                 const textElement = statusElement.querySelector('.connection-text');
                 if (textElement) textElement.textContent = 'Offline';
                } else {
                 statusElement.className = 'service-status checking';
                 const textElement = statusElement.querySelector('.connection-text');
                 if (textElement) textElement.textContent = 'Checking';
             }
         }
         
         // Update UI status to mirror Gateway status  
         const uiStatusElement = document.getElementById('ui-status');
         if (uiStatusElement) {
             const gatewayServiceHealthy = servicesStatus['gateway-service'] === 'healthy';
             
             let uiStatus;
             if (!gatewayServiceHealthy) {
                 // Gateway service itself is down = UI offline (can't reach gateway)
                 uiStatus = 'unhealthy';
                 console.log('🖥️  UI status: Gateway unreachable - showing offline');
             } else {
                 // Gateway service is healthy - check business services for UI status
                 let onlineBusinessServices = 0;
                 let totalBusinessServices = 0;
                 
                 // Count only business services (exclude gateway itself)
                 for (const [svcName, svcStatus] of Object.entries(servicesStatus)) {
                     if (svcName !== 'gateway-service') { // Don't count gateway itself
                         totalBusinessServices++;
                         if (svcStatus === 'healthy') {
                             onlineBusinessServices++;
                         }
                     }
                 }
                 
                 if (onlineBusinessServices === totalBusinessServices) {
                     uiStatus = 'healthy'; // All business services healthy = UI online
                 } else {
                     uiStatus = 'degraded'; // Some business services down = UI degraded
                 }
                 
                 console.log(`🖥️  UI status: Gateway healthy, business services ${onlineBusinessServices}/${totalBusinessServices} → ${uiStatus}`);
             }
             
             if (uiStatus === 'healthy') {
                 uiStatusElement.className = 'service-status online';
                 const textElement = uiStatusElement.querySelector('.connection-text');
                 if (textElement) textElement.textContent = 'Online';
             } else if (uiStatus === 'degraded') {
                 uiStatusElement.className = 'service-status degraded';
                 const textElement = uiStatusElement.querySelector('.connection-text');
                 if (textElement) textElement.textContent = 'Degraded';
             } else if (uiStatus === 'unhealthy') {
                 uiStatusElement.className = 'service-status offline';
                 const textElement = uiStatusElement.querySelector('.connection-text');
                 if (textElement) textElement.textContent = 'Offline';
             } else {
                 uiStatusElement.className = 'service-status checking';
                 const textElement = uiStatusElement.querySelector('.connection-text');
                 if (textElement) textElement.textContent = 'Checking';
             }
         }
         
                 console.log('✅ Services dashboard updated');
    }

         // Update connection line colors based on service health
    function updateConnectionLines(servicesStatus, overallStatus) {
        const connections = [
            {
                lineClass: '.service-connection:nth-of-type(2) .connection-line',
                dotId: 'ui-gateway-dot',
                status: servicesStatus['gateway-service'] || 'unhealthy' // UI mirrors Gateway status
            },
            {
                lineClass: '.service-connection:nth-of-type(4) .connection-line', 
                dotId: 'gateway-services-dot',
                status: overallStatus // Gateway to Services connection
            },
            {
                lineClass: '.service-connection:nth-of-type(6) .connection-line',
                dotId: 'services-data-dot', 
                status: servicesStatus['data-service'] // Services to Data connection
            }
        ];

        connections.forEach(conn => {
            const line = document.querySelector(conn.lineClass);
            const dot = document.getElementById(conn.dotId);
            
            if (line && dot) {
                const statusClass = getConnectionStatus(conn.status);
                line.className = `connection-line ${statusClass}`;
                dot.className = `connection-dot ${statusClass}`;
            }
        });
        
        console.log('✅ Connection lines and dots updated');
    }

     // Get connection status class based on service health
     function getConnectionStatus(status) {
         if (status === 'healthy') return 'healthy';
         if (status === 'unhealthy') return 'offline';
         if (status === 'degraded') return 'degraded';
         return 'unknown';
     }

     // Update all architecture service buttons
     function updateAllArchitectureButtons(servicesStatus, overallStatus) {
         const services = ['gateway-service', 'session-service', 'orders-service', 'inventory-service', 'invoice-service', 'data-service'];
         
         services.forEach(serviceName => {
             const serviceStatus = (serviceName === 'gateway-service') ? overallStatus : servicesStatus[serviceName];
             updateArchitectureServiceButtons(serviceName, serviceStatus);
         });
     }

         // Update buttons for a specific service based on status
    function updateArchitectureServiceButtons(serviceName, serviceStatus) {
        const serviceCard = document.querySelector(`[data-service="${serviceName}"]`);
        if (!serviceCard) return;

        const startBtn = serviceCard.querySelector('.start-btn');
        const stopBtn = serviceCard.querySelector('.stop-btn');
        const restartBtn = serviceCard.querySelector('.restart-btn');

        if (startBtn && stopBtn && restartBtn) {
            const isOnline = serviceStatus === 'healthy';
            
            if (isOnline) {
                // Service is online: disable start, enable stop and restart
                startBtn.disabled = true;
                startBtn.style.opacity = '0.5';
                startBtn.style.cursor = 'not-allowed';
                
                stopBtn.disabled = false;
                stopBtn.style.opacity = '1';
                stopBtn.style.cursor = 'pointer';
                
                restartBtn.disabled = false;
                restartBtn.style.opacity = '1';
                restartBtn.style.cursor = 'pointer';
            } else {
                // Service is offline: enable start, disable stop and restart
                startBtn.disabled = false;
                startBtn.style.opacity = '1';
                startBtn.style.cursor = 'pointer';
                
                stopBtn.disabled = true;
                stopBtn.style.opacity = '0.5';
                stopBtn.style.cursor = 'not-allowed';
                
                restartBtn.disabled = true;
                restartBtn.style.opacity = '0.5';
                restartBtn.style.cursor = 'not-allowed';
            }
        }
    }

     // Dynamically calculate and update connection lines based on panel centers
     function updateDynamicConnections() {
         const container = document.querySelector('.architecture-container');
         const svg = document.getElementById('connectionsSvg');
         
         if (!container || !svg) return;
         
         // Get container dimensions for relative positioning
         const containerRect = container.getBoundingClientRect();
         
         // Helper function to get center point of an element relative to container
         function getElementCenter(element) {
             const rect = element.getBoundingClientRect();
             return {
                 x: ((rect.left + rect.width / 2) - containerRect.left) / containerRect.width * 100,
                 y: ((rect.top + rect.height / 2) - containerRect.top) / containerRect.height * 100
             };
         }
         
         // Get all panel elements
         const gatewayPanel = document.querySelector('.node-gateway');
         const dataPanel = document.querySelector('.node-data');
         const servicePanels = {
             'session': document.querySelector('[data-service="session-service"]'),
             'orders': document.querySelector('[data-service="orders-service"]'),
             'inventory': document.querySelector('[data-service="inventory-service"]'),
             'invoice': document.querySelector('[data-service="invoice-service"]')
         };
         
         if (!gatewayPanel || !dataPanel) return;
         
         const gatewayCenter = getElementCenter(gatewayPanel);
         const dataCenter = getElementCenter(dataPanel);
         
         // Update gateway-to-service lines
         Object.entries(servicePanels).forEach(([serviceName, servicePanel]) => {
             if (!servicePanel) return;
             
             const serviceCenter = getElementCenter(servicePanel);
             
             // Update gateway-to-service line
             const gatewayLine = document.getElementById(`gateway-${serviceName}-line`);
             if (gatewayLine) {
                 gatewayLine.setAttribute('x1', gatewayCenter.x);
                 gatewayLine.setAttribute('y1', gatewayCenter.y);
                 gatewayLine.setAttribute('x2', serviceCenter.x);
                 gatewayLine.setAttribute('y2', serviceCenter.y);
             }
             
             // Update service-to-data line
             const dataLine = document.getElementById(`${serviceName}-data-line`);
             if (dataLine) {
                 dataLine.setAttribute('x1', serviceCenter.x);
                 dataLine.setAttribute('y1', serviceCenter.y);
                 dataLine.setAttribute('x2', dataCenter.x);
                 dataLine.setAttribute('y2', dataCenter.y);
             }
             
             // Update connection dots
             const gatewayDot = document.getElementById(`${serviceName}-gateway-dot`);
             if (gatewayDot) {
                 gatewayDot.setAttribute('cx', serviceCenter.x);
                 gatewayDot.setAttribute('cy', serviceCenter.y);
             }
             
             const dataDot = document.getElementById(`${serviceName}-data-dot`);
             if (dataDot) {
                 dataDot.setAttribute('cx', serviceCenter.x);
                 dataDot.setAttribute('cy', serviceCenter.y);
             }
         });
         
         // Update gateway and data dots
         const gatewayDot = document.getElementById('gateway-dot');
         if (gatewayDot) {
             gatewayDot.setAttribute('cx', gatewayCenter.x);
             gatewayDot.setAttribute('cy', gatewayCenter.y);
         }
         
         const dataDot = document.getElementById('data-dot');
         if (dataDot) {
             dataDot.setAttribute('cx', dataCenter.x);
             dataDot.setAttribute('cy', dataCenter.y);
         }
     }

     // Initialize dynamic connections when page loads and on resize
     function initializeDynamicConnections() {
         // Wait for elements to be rendered
         setTimeout(updateDynamicConnections, 100);
         
         // Update on window resize
         window.addEventListener('resize', updateDynamicConnections);
         
         // Update when architecture status changes
         const originalUpdateArchitectureStatus = updateArchitectureStatus;
         updateArchitectureStatus = function(...args) {
             originalUpdateArchitectureStatus.apply(this, args);
             setTimeout(updateDynamicConnections, 50);
         };
     }

     // Expose functions globally for dashboard.html
     window.updateArchitectureStatus = updateArchitectureStatus;
     window.markAllArchitectureOffline = markAllArchitectureOffline;
     window.showServiceContextMenu = showServiceContextMenu;
     window.updateDynamicConnections = updateDynamicConnections;
     window.initializeDynamicConnections = initializeDynamicConnections;
</script> 

 