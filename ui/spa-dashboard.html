<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ice Cream Store - Management Dashboard</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <!-- Shared CSS -->
    <link rel="stylesheet" href="shared/css/style.css?v=1.3">
    
    <style>
        /* SPA-specific styles */
        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        .app-sidebar {
            width: 280px;
            flex-shrink: 0;
            background: var(--white);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            z-index: 1000;
        }
        
        .app-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .app-header {
            background: var(--white);
            border-bottom: 1px solid var(--border-color);
            padding: 0;
            z-index: 999;
        }
        
        .app-content {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            background: var(--background-light);
        }
        
        .content-loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: var(--secondary-color);
        }
        
        .loading-spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .breadcrumb-container {
            background: var(--white);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            margin: 0;
        }
        
        .breadcrumb {
            margin: 0;
            background: transparent;
            padding: 0;
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .app-sidebar {
                position: fixed;
                left: -280px;
                height: 100vh;
                transition: left 0.3s ease;
                z-index: 1050;
            }
            
            .app-sidebar.show {
                left: 0;
            }
            
            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1040;
                display: none;
            }
            
            .sidebar-overlay.show {
                display: block;
            }
            
            .app-content {
                padding: 1rem;
            }
        }
        
        /* Active navigation highlighting */
        .nav-link.active {
            background: var(--primary-light) !important;
            color: var(--primary-color) !important;
            font-weight: 600;
        }
        
        .nav-link.active .nav-indicator {
            background: var(--primary-color);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="app-sidebar" id="appSidebar">
            <!-- Sidebar content will be loaded here -->
        </div>
        
        <!-- Mobile sidebar overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        
        <!-- Main Content Area -->
        <div class="app-main">
            <!-- Header -->
            <div class="app-header" id="appHeader">
                <!-- Header content will be loaded here -->
            </div>
            
            <!-- Breadcrumb -->
            <div class="breadcrumb-container">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb" id="appBreadcrumb">
                        <li class="breadcrumb-item active">Dashboard</li>
                    </ol>
                </nav>
            </div>
            
            <!-- Content Area -->
            <div class="app-content" id="appContent">
                <!-- Page content will be loaded here -->
                <div class="content-loader">
                    <div class="loading-spinner"></div>
                    <span>Loading dashboard...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Configuration -->
    <script src="config.js?v=1.3"></script>
    
    <!-- Shared JavaScript -->
    <script src="shared/js/load-partials.js?v=1.3"></script>
    <script src="shared/js/auth.js?v=1.3"></script>
    <script src="shared/js/alerts.js?v=1.3"></script>
    <script src="shared/js/status.js?v=1.3"></script>
    
    <!-- SPA Router -->
    <script src="shared/js/spa-router.js?v=1.0"></script>
    
    <script>
        class SPADashboard {
            constructor() {
                this.auth = null;
                this.router = null;
                this.init();
            }

            async init() {
                console.log('🚀 Initializing SPA Dashboard...');
                
                try {
                    // Initialize authentication
                    this.auth = new AuthService();
                    if (!this.auth.isAuthenticated()) {
                        console.log('❌ User not authenticated, redirecting to login');
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    // Load layout components
                    await this.loadLayoutComponents();
                    
                    // Initialize router
                    this.router = new SPARouter();
                    await this.router.init();
                    
                    // Setup event listeners
                    this.setupEventListeners();
                    
                    // Load initial page
                    const initialRoute = window.location.hash.slice(1) || 'dashboard';
                    await this.router.navigate(initialRoute);
                    
                    console.log('✅ SPA Dashboard initialized successfully');
                    
                } catch (error) {
                    console.error('❌ Error initializing SPA Dashboard:', error);
                    Alert.error('Dashboard Error', 'Failed to initialize dashboard. Please refresh the page.');
                }
            }
            
            async loadLayoutComponents() {
                console.log('📥 Loading layout components...');
                
                // Load header
                await window.PartialLoader.loadPartial('shared/partials/layout-header.html', 'appHeader');
                
                // Load sidebar with SPA navigation
                await this.loadSPASidebar();
                
                // Load system status
                await window.PartialLoader.loadSystemStatus('system-status-container');
                
                console.log('✅ Layout components loaded');
            }
            
            async loadSPASidebar() {
                // Load sidebar content but modify navigation links for SPA
                await window.PartialLoader.loadPartial('shared/partials/layout-sidebar.html', 'appSidebar');
                
                // Convert navigation links to SPA navigation
                this.convertNavigationToSPA();
            }
            
            convertNavigationToSPA() {
                const sidebar = document.getElementById('appSidebar');
                const navLinks = sidebar.querySelectorAll('.nav-link[href]');
                
                navLinks.forEach(link => {
                    const href = link.getAttribute('href');
                    const route = this.convertHrefToRoute(href);
                    
                    if (route) {
                        link.removeAttribute('href');
                        link.setAttribute('data-route', route);
                        link.style.cursor = 'pointer';
                        
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            this.router.navigate(route);
                        });
                    }
                });
            }
            
            convertHrefToRoute(href) {
                // Convert traditional hrefs to SPA routes
                const routeMap = {
                    '../dashboard.html': 'dashboard',
                    'dashboard.html': 'dashboard',
                    '../orders.html': 'orders',
                    'orders.html': 'orders',
                    '../inventory/index.html': 'inventory',
                    'inventory/index.html': 'inventory',
                    '../inventory/suppliers.html': 'inventory/suppliers',
                    'inventory/suppliers.html': 'inventory/suppliers',
                    '../inventory/ingredients.html': 'inventory/ingredients',
                    'inventory/ingredients.html': 'inventory/ingredients',
                    '../invoice/index.html': 'invoice',
                    'invoice/index.html': 'invoice',
                    '../invoice/invoices.html': 'invoice/invoices',
                    'invoice/invoices.html': 'invoice/invoices'
                };
                
                return routeMap[href] || null;
            }
            
            setupEventListeners() {
                // Mobile sidebar toggle
                const sidebarToggle = document.querySelector('[data-bs-toggle="sidebar"]');
                const sidebar = document.getElementById('appSidebar');
                const overlay = document.getElementById('sidebarOverlay');
                
                if (sidebarToggle) {
                    sidebarToggle.addEventListener('click', () => {
                        sidebar.classList.toggle('show');
                        overlay.classList.toggle('show');
                    });
                }
                
                if (overlay) {
                    overlay.addEventListener('click', () => {
                        sidebar.classList.remove('show');
                        overlay.classList.remove('show');
                    });
                }
                
                // Handle browser back/forward
                window.addEventListener('hashchange', () => {
                    const route = window.location.hash.slice(1) || 'dashboard';
                    this.router.navigate(route, false); // false = don't update URL
                });
            }
        }

        // Initialize SPA when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            window.spaDashboard = new SPADashboard();
        });
    </script>
</body>
</html> 