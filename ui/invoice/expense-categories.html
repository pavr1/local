<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ice Cream Store - Expense Categories</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <!-- Shared CSS -->
    <link rel="stylesheet" href="../shared/css/style.css?v=1.2">
    
    <style>
        /* Page-specific styles */
        .categories-header {
            background: var(--gradient-success);
            color: var(--white);
            padding: 2rem;
            border-radius: var(--border-radius-lg);
            margin-bottom: 2rem;
        }

        .category-card {
            background: var(--white);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: var(--transition);
        }

        .category-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .category-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .category-status {
            padding: 0.375rem 0.75rem;
            border-radius: var(--border-radius);
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-active {
            background: var(--success-light);
            color: var(--success-color);
        }

        .status-inactive {
            background: var(--danger-light);
            color: var(--danger-color);
        }

        .category-description {
            color: var(--secondary-color);
            margin-bottom: 1rem;
        }

        .category-actions {
            display: flex;
            gap: 0.5rem;
        }

        .loading-spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .categories-header {
                padding: 2rem 1rem;
            }

            .category-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Include shared layout components -->
    <div id="layout-header"></div>
    <div id="layout-sidebar"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container-fluid">
            <!-- Header -->
            <div class="categories-header">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="mb-2">
                            <i class="fas fa-tags me-2"></i>
                            Expense Categories
                        </h1>
                        <p class="mb-0">Manage expense categories for better financial organization</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-light" onclick="openCreateCategoryModal()">
                            <i class="fas fa-plus me-2"></i>
                            New Category
                        </button>
                    </div>
                </div>
            </div>

            <!-- Categories List -->
            <div id="categoriesList">
                <div class="text-center py-5">
                    <div class="loading-spinner"></div>
                    <p>Loading categories...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Create Category Modal -->
    <div class="modal fade" id="createCategoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Expense Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createCategoryForm">
                        <div class="form-group">
                            <label for="categoryName">Category Name *</label>
                            <input type="text" class="form-control" id="categoryName" required maxlength="100">
                        </div>
                        <div class="form-group">
                            <label for="categoryDescription">Description (Optional)</label>
                            <textarea class="form-control" id="categoryDescription" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="categoryActive" checked>
                                <label class="form-check-label" for="categoryActive">
                                    Active
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createCategory()">Create Category</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Category Modal -->
    <div class="modal fade" id="editCategoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Expense Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editCategoryForm">
                        <input type="hidden" id="editCategoryId">
                        <div class="form-group">
                            <label for="editCategoryName">Category Name *</label>
                            <input type="text" class="form-control" id="editCategoryName" required maxlength="100">
                        </div>
                        <div class="form-group">
                            <label for="editCategoryDescription">Description (Optional)</label>
                            <textarea class="form-control" id="editCategoryDescription" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editCategoryActive">
                                <label class="form-check-label" for="editCategoryActive">
                                    Active
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateCategory()">Update Category</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Shared Scripts -->
    <script src="../shared/js/auth.js"></script>
    <script src="../shared/js/alerts.js"></script>
    <script src="../shared/js/load-partials.js"></script>
    <script src="../shared/js/status.js"></script>

    <script>
        // Global variables
        let categories = [];
        let currentCategoryId = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadLayoutComponents();
            loadCategories();
        });

        // Load categories
        async function loadCategories() {
            try {
                showLoading();
                
                const response = await fetch('/api/v1/expense-categories', {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        categories = data.data;
                        displayCategories(categories);
                    } else {
                        Alert.error(data.message || 'Failed to load categories');
                    }
                } else {
                    Alert.error('Failed to load categories');
                }
            } catch (error) {
                console.error('Error loading categories:', error);
                Alert.error('Failed to load categories');
            } finally {
                hideLoading();
            }
        }

        // Display categories
        function displayCategories(categoriesToShow) {
            const container = document.getElementById('categoriesList');
            
            if (categoriesToShow.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-tags fa-3x text-muted mb-3"></i>
                        <h5>No categories found</h5>
                        <p class="text-muted">Create your first expense category to get started</p>
                    </div>
                `;
                return;
            }

            const categoriesHTML = categoriesToShow.map(category => `
                <div class="category-card">
                    <div class="category-header">
                        <div>
                            <div class="category-name">${category.category_name}</div>
                            <div class="category-description">${category.description || 'No description'}</div>
                        </div>
                        <div class="text-end">
                            <span class="category-status ${category.is_active ? 'status-active' : 'status-inactive'}">
                                ${category.is_active ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                    </div>
                    <div class="category-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="editCategory('${category.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory('${category.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = categoriesHTML;
        }

        // Open create category modal
        function openCreateCategoryModal() {
            document.getElementById('createCategoryForm').reset();
            new bootstrap.Modal(document.getElementById('createCategoryModal')).show();
        }

        // Create category
        async function createCategory() {
            try {
                const form = document.getElementById('createCategoryForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const categoryData = {
                    category_name: document.getElementById('categoryName').value,
                    description: document.getElementById('categoryDescription').value || null,
                    is_active: document.getElementById('categoryActive').checked
                };

                const response = await fetch('/api/v1/expense-categories', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(categoryData)
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        Alert.success('Category created successfully');
                        bootstrap.Modal.getInstance(document.getElementById('createCategoryModal')).hide();
                        loadCategories();
                    } else {
                        Alert.error(data.message || 'Failed to create category');
                    }
                } else {
                    Alert.error('Failed to create category');
                }
            } catch (error) {
                console.error('Error creating category:', error);
                Alert.error('Failed to create category');
            }
        }

        // Edit category
        async function editCategory(categoryId) {
            try {
                const response = await fetch(`/api/v1/expense-categories/${categoryId}`, {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        const category = data.data;
                        populateEditForm(category);
                        new bootstrap.Modal(document.getElementById('editCategoryModal')).show();
                    } else {
                        Alert.error(data.message || 'Failed to load category');
                    }
                } else {
                    Alert.error('Failed to load category');
                }
            } catch (error) {
                console.error('Error loading category:', error);
                Alert.error('Failed to load category');
            }
        }

        // Populate edit form
        function populateEditForm(category) {
            currentCategoryId = category.id;
            document.getElementById('editCategoryId').value = category.id;
            document.getElementById('editCategoryName').value = category.category_name;
            document.getElementById('editCategoryDescription').value = category.description || '';
            document.getElementById('editCategoryActive').checked = category.is_active;
        }

        // Update category
        async function updateCategory() {
            try {
                const form = document.getElementById('editCategoryForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const categoryData = {
                    category_name: document.getElementById('editCategoryName').value,
                    description: document.getElementById('editCategoryDescription').value || null,
                    is_active: document.getElementById('editCategoryActive').checked
                };

                const response = await fetch(`/api/v1/expense-categories/${currentCategoryId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(categoryData)
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        Alert.success('Category updated successfully');
                        bootstrap.Modal.getInstance(document.getElementById('editCategoryModal')).hide();
                        loadCategories();
                    } else {
                        Alert.error(data.message || 'Failed to update category');
                    }
                } else {
                    Alert.error('Failed to update category');
                }
            } catch (error) {
                console.error('Error updating category:', error);
                Alert.error('Failed to update category');
            }
        }

        // Delete category
        async function deleteCategory(categoryId) {
            const result = await Alert.confirm('Are you sure you want to delete this category?');
            if (!result) return;

            try {
                const response = await fetch(`/api/v1/expense-categories/${categoryId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        Alert.success('Category deleted successfully');
                        loadCategories();
                    } else {
                        Alert.error(data.message || 'Failed to delete category');
                    }
                } else {
                    Alert.error('Failed to delete category');
                }
            } catch (error) {
                console.error('Error deleting category:', error);
                Alert.error('Failed to delete category');
            }
        }

        // Utility functions
        function showLoading() {
            document.getElementById('categoriesList').innerHTML = `
                <div class="text-center py-5">
                    <div class="loading-spinner"></div>
                    <p>Loading categories...</p>
                </div>
            `;
        }

        function hideLoading() {
            // Loading is handled by displayCategories
        }
    </script>
</body>
</html> 